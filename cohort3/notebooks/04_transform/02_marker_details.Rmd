---
title: "02_marker_details"
author: "Sean Maden"
date: "2023-11-14"
output: html_document
---

```{r setup, include=FALSE}
libv <- c("ComplexHeatmap", "ggplot2", "dplyr", "reshape2", "gridExtra")
sapply(libv, library, character.only = TRUE)
knitr::opts_chunk$set(echo = FALSE)
setwd("..")
setwd("..")
load("./env/04_transform/01_transform_script.RData")
source("./notebooks/04_transform/00_param.R")
```

# Overview

This document looks at marker subsets by cell type, focusing on cell type size 
categories (largest and smallest types). The log2(TPM+1) scale, and cell size 
estimates in that scale, is used across assessments.

# Cell sizes

Bar plots of cell sizes.

```{r}
dfPlot <- data.frame(size = as.numeric(cellSizes), cellType=names(cellSizes))
dfPlot$log2_size <- log2(dfPlot$size)
dfPlot$cellType <- factor(dfPlot$cellType, levels = dfPlot$cellType[order(dfPlot$size)])
plot1 <- ggplot(dfPlot, aes(x = cellType, y = size)) + geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))
plot2 <- ggplot(dfPlot, aes(x = cellType, y = log2_size)) + geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))
plot1
plot2
grid.arrange(plot1, plot2, ncol = 1)
```

Violin plot of size distributions.

```{r}
plot1 <- ggplot(dfPlot, aes(x = 1, y = size)) + geom_violin() +
  theme(axis.text.x = element_text(angle = 45,hjust=1))
plot2 <- ggplot(dfPlot, aes(x = 1, y = size)) + 
  geom_jitter() + geom_boxplot(alpha = 0, color = "cyan") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))
plot1
plot2
grid.arrange(plot1, plot2, nrow=1)
```

Separate low, medium, and high sizes.

```{r}
quantileVector <- quantile(dfPlot$size)
lowSizeMax <- quantileVector[2]
highSizeMin <- quantileVector[4]
dfPlot$sizeCategory <- ifelse(dfPlot$size <= lowSizeMax, "low",
                              ifelse(dfPlot$size >= highSizeMin, "high", "medium"))
dfCellSizeInfo <- dfPlot
```

```{r}
# barplot coloring by category
plot1 <- ggplot(dfPlot, aes(x = cellType, y = size, fill = sizeCategory)) + geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))
# violin plots by category
plot2 <- 
  ggplot(dfPlot, aes(x = sizeCategory, y = size)) + geom_violin(draw_quantiles=0.5) +
  theme(axis.text.x = element_text(angle = 45,hjust=1))
# jitterbox
plot3 <- 
  ggplot(dfPlot, aes(x = sizeCategory, y = size)) + 
  geom_jitter() + geom_boxplot(alpha = 0, color = "cyan") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))

plot1
plot2
plot3
grid.arrange(plot1, plot2, plot3, 
             layout_matrix=matrix(c(1,2,1,3),nrow=2), 
             nrow=2,ncol=2)
```

## Marker summaries by size category

Marker counts

```{r}
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)
# map size category
markerTable$sizeCategory <- "NA"
for(type in markerTable$cellType){
  markerTable[markerTable$cellType==type,]$sizeCategory<-
    dfPlot[dfPlot$cellType==type,]$sizeCategory}
```

```{r}
plot1 <- ggplot(markerTable, aes(x = sizeCategory)) + geom_bar(stat="count")
plot1
```

Marker expression, all markers and cell types grouped by size category.

```{r}
dfExpression <- refTpmLog2Filter %>% as.matrix() %>% melt()
colnames(dfExpression) <- c("markerName", "cellType", "expression")
# map size category
dfExpression$sizeCategory <- "NA"
for(type in dfExpression$cellType){
  dfExpression[dfExpression$cellType==type,]$sizeCategory<-
    dfPlot[dfPlot$cellType==type,]$sizeCategory}
```

```{r}
plot1 <- 
  ggplot(dfExpression, aes(x = sizeCategory, y = expression)) + 
  geom_violin(draw_quantiles=0.5) + 
  theme(axis.text.x = element_text(angle = 45,hjust=1))
# jitterbox
plot2 <- 
  ggplot(dfExpression, aes(x = sizeCategory, y = expression)) + 
  geom_jitter() + geom_boxplot(alpha = 0, color = "cyan") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))

plot1
plot2
grid.arrange(plot1, plot2, nrow = 2)
```

Marker expression mean versus variance.

```{r}
dfMeanVarByGroup <- dfExpression %>% group_by(sizeCategory, markerName) %>% 
  summarise(mean = mean(expression), var = var(expression))
dfMeanVarByGroup$log_mean <- log(dfMeanVarByGroup$mean)
dfMeanVarByGroup$log_var <- log(dfMeanVarByGroup$var)
```

```{r}
plot1 <- ggplot(dfMeanVarByGroup, aes(x = log_mean,  y = log_var)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0) + 
  facet_wrap(~sizeCategory)

plot2 <- ggplot(
  dfMeanVarByGroup, aes(x = log_mean,  y = log_var, color = sizeCategory)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0)

plot3 <- ggplot(
  dfMeanVarByGroup, aes(x = log_mean,  y = log_var, color = sizeCategory)) + 
  geom_smooth(method="glm") + geom_abline(slope = 1, intercept = 0)

plot1 
plot2
plot3
```

# Heatmaps

## By size category

Heatmaps subsetting on size category.

```{r}
```

```{r}
```

# Session info

```{r}
sessinInfo()
```