---
title: "01_transform"
author: "Sean Maden"
date: "2023-11-08"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
libv <- c("ComplexHeatmap", "ggplot2", "dplyr", "reshape2")
sapply(libv, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
setwd("..")
setwd("..")
load("./env/04_transform/01_transform_script.RData")
source("./notebooks/04_transform/00_param.R")
```

This notebook shows heatmaps of immune cell types before and after cell type 
transformation. Part of this task is to relate the normalization conditions to 
the discernability of cell type transformation difference.

# Conditions tested

Experiment condition matrix for conditions evaluated.

```{r}
df <- data.frame(
  expressionScale=c("tpm", "log2_tpm_plusone", "tpm", "log2_tpm_plusone"),
  heatmapRescale=rep("Z", 4),
  cellSizeScaleFactor=rep("sum",4)
)
knitr::kable(df, align = "c")
```

# Heatmaps TPM

## Before transformation

Showing the Z-transformed TPM scale marker expression for 17 cell types from 
ABIS-seq reference. This is without the cell scale factors transformation.

```{r}
heatmapData <- refTpmFilter
```

```{r, include = FALSE}
# check z transformation
globalMean <- mean(heatmapData)
globalSD <- sd(heatmapData)
zHeatmapData <- heatmapData-globalMean/globalSD
zHeatmapData[1,1]==zHeatmapData[1,1]-globalMean/globalSD
identical(zHeatmapData, scale(heatmapData, center=TRUE, scale=FALSE))
identical(zHeatmapData, scale(heatmapData, center=TRUE, scale=TRUE))
identical(zHeatmapData, scale(heatmapData, center=FALSE, scale=TRUE))
```

```{r}
heatmapTall <- scale(heatmapData)
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
```
```{r, include = FALSE}
# check z scale
identical(zHeatmapData, scale(heatmapData))
identical(zHeatmapData, scale(heatmapData, scale=F))
head(scale(zHeatmapData))
head(zHeatmapData)
# check object dimensions
dim(heatmapTall)
head(heatmapTall)
head(markerTable)
intersect(unique(markerTable$cellType), colnames(heatmapTall))
length(intersect(unique(markerTable$cellType), colnames(heatmapTall)))
mapTable
head(rownames(heatmapTall))
head(markerTable$markerName)
length(intersect(rownames(heatmapTall), markerTable$markerName))
length(intersect(rownames(heatmapTall), markerTable$markerName))
identical(rownames(heatmapTall), markerTable$markerName)
```

```{r}
newAnnotationHeatmapList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "Z", "Untransformed")
```

```{r}
newAnnotationHeatmapList$heatmap
```

```{r}
newAnnotationHeatmapListTpm <- newAnnotationHeatmapList
```

## After transformation

Showing the Z-transformed TPM scale marker expression for 17 cell types from 
ABIS-seq reference. This is with the cell scale factors transformation.

```{r}
heatmapData <- refTpmTransformedFilter
```

```{r, include = FALSE}
# check z transformation
globalMean <- mean(heatmapData)
globalSD <- sd(heatmapData)
zHeatmapData <- heatmapData-globalMean/globalSD
zHeatmapData[1,1]==zHeatmapData[1,1]-globalMean/globalSD
identical(zHeatmapData, scale(heatmapData, center=TRUE, scale=FALSE))
identical(zHeatmapData, scale(heatmapData, center=TRUE, scale=TRUE))
identical(zHeatmapData, scale(heatmapData, center=FALSE, scale=TRUE))
```

```{r}
heatmapTall <- scale(heatmapData)
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
```

```{r, include = FALSE}
# check z scale
identical(zHeatmapData, scale(heatmapData))
identical(zHeatmapData, scale(heatmapData, scale=F))
head(scale(zHeatmapData))
head(zHeatmapData)
# check object dimensions
dim(heatmapTall)
head(heatmapTall)
head(markerTable)
intersect(unique(markerTable$cellType), colnames(heatmapTall))
length(intersect(unique(markerTable$cellType), colnames(heatmapTall)))
mapTable
head(rownames(heatmapTall))
head(markerTable$markerName)
length(intersect(rownames(heatmapTall), markerTable$markerName))
length(intersect(rownames(heatmapTall), markerTable$markerName))
identical(rownames(heatmapTall), markerTable$markerName)
```

```{r}
newAnnotationHeatmapList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "Z", "Transformed")
```

```{r}
newAnnotationHeatmapList$heatmap
```

```{r}
newAnnotationHeatmapListTpmTransformed <- newAnnotationHeatmapList
```

## Side-by-side

Shows heatmaps before and after transformation, side by side.

```{r}
heatmap1 <- newAnnotationHeatmapListTpm$heatmap
heatmap2 <- newAnnotationHeatmapListTpmTransformed$heatmap
heatmap1 + heatmap2
```

# Heatmaps log2( TPM + 1 )

## Before transformation

Showing the Z-transformed log2( TPM + 1 ) scale marker expression for 17 cell 
types from ABIS-seq reference. This is without the cell scale factors 
transformation.

```{r}
heatmapData <- as.matrix(refTpmLog2Filter)
```

```{r, include = FALSE}
# check z transformation
globalMean <- mean(heatmapData)
globalSD <- sd(heatmapData)
zHeatmapData <- heatmapData-globalMean/globalSD
zHeatmapData[1,1]==zHeatmapData[1,1]-globalMean/globalSD
identical(zHeatmapData, scale(heatmapData, center=TRUE, scale=FALSE))
identical(zHeatmapData, scale(heatmapData, center=TRUE, scale=TRUE))
identical(zHeatmapData, scale(heatmapData, center=FALSE, scale=TRUE))
```

```{r}
heatmapTall <- scale(heatmapData)
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
```

```{r, include = FALSE}
# check z scale
identical(zHeatmapData, scale(heatmapData))
identical(zHeatmapData, scale(heatmapData, scale=F))
head(scale(zHeatmapData))
head(zHeatmapData)
# check object dimensions
dim(heatmapTall)
head(heatmapTall)
head(markerTable)
intersect(unique(markerTable$cellType), colnames(heatmapTall))
length(intersect(unique(markerTable$cellType), colnames(heatmapTall)))
mapTable
head(rownames(heatmapTall))
head(markerTable$markerName)
length(intersect(rownames(heatmapTall), markerTable$markerName))
length(intersect(rownames(heatmapTall), markerTable$markerName))
identical(rownames(heatmapTall), markerTable$markerName)
```

```{r}
newAnnotationHeatmapList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "Z", "Untransformed")
```

```{r}
newAnnotationHeatmapList$heatmap
```

```{r}
newAnnotationHeatmapListTpmLog2Untransformed <- newAnnotationHeatmapList
```



## After transformation

Showing the Z-transformed log2( TPM + 1 ) scale marker expression for 17 cell 
types from ABIS-seq reference. This is with the cell scale factors 
transformation.

```{r}
heatmapData <- as.matrix(refTpmLog2TransformedFilter)
```

```{r, include = FALSE}
# check z transformation
globalMean <- mean(heatmapData)
globalSD <- sd(heatmapData)
zHeatmapData <- heatmapData-globalMean/globalSD
zHeatmapData[1,1]==zHeatmapData[1,1]-globalMean/globalSD
identical(zHeatmapData, scale(heatmapData, center=TRUE, scale=FALSE))
identical(zHeatmapData, scale(heatmapData, center=TRUE, scale=TRUE))
identical(zHeatmapData, scale(heatmapData, center=FALSE, scale=TRUE))
```

```{r}
heatmapTall <- scale(heatmapData)
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
```

```{r, include = FALSE}
# check z scale
identical(zHeatmapData, scale(heatmapData))
identical(zHeatmapData, scale(heatmapData, scale=F))
head(scale(zHeatmapData))
head(zHeatmapData)
# check object dimensions
dim(heatmapTall)
head(heatmapTall)
head(markerTable)
intersect(unique(markerTable$cellType), colnames(heatmapTall))
length(intersect(unique(markerTable$cellType), colnames(heatmapTall)))
mapTable
head(rownames(heatmapTall))
head(markerTable$markerName)
length(intersect(rownames(heatmapTall), markerTable$markerName))
length(intersect(rownames(heatmapTall), markerTable$markerName))
identical(rownames(heatmapTall), markerTable$markerName)
```

```{r}
newAnnotationHeatmapList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "Z", "Transformed")
```

```{r}
newAnnotationHeatmapList$heatmap
```

```{r}
newAnnotationHeatmapListTpmLog2Transformed <- newAnnotationHeatmapList
```

## Side-by-side

Shows heatmaps before and after transformation, side by side.

```{r}
heatmap1 <- newAnnotationHeatmapListTpmLog2Untransformed$heatmap
heatmap2 <- newAnnotationHeatmapListTpmLog2Transformed$heatmap
heatmap1 + heatmap2
```


# Scatter plots

Comparing before/after transformation expression

## TPM expression

Scatterplots of marker TPM expression, comparing before and after rescaling.

```{r}
plotDataUntransformed <- refTpmFilter
plotDataTransformed <- refTpmTransformedFilter
```

```{r, include = FALSE}
# checks
dim(plotDataUntransformed)
dim(plotDataTransformed)
identical(rownames(plotDataUntransformed), rownames(plotDataTransformed))
identical(colnames(plotDataUntransformed), colnames(plotDataTransformed))
# get tall plot versions
untransformedMelt <- melt(plotDataUntransformed)
transformedMelt <- melt(plotDataTransformed)
identical(untransformedMelt$Var1, transformedMelt$Var1)
identical(untransformedMelt$Var2, transformedMelt$Var2)
```

```{r}
plotScatter <- data.frame(untransformed = untransformedMelt[,"value"],
                          transformed = transformedMelt[,"value"],
                          cellType = untransformedMelt[,"Var2"])
```

Overlay all cell types, markers.

```{r}
ggplot(plotScatter, aes(x = untransformed, y = transformed)) + geom_point() + 
  geom_abline(slope = 1, intercept = 0)
```

```{r}
ggplot(plotScatter, aes(x = untransformed, y = transformed, color = cellType)) + geom_point() + 
  geom_abline(slope = 1, intercept = 0)
```
Facet on cell types

```{r}
ggplot(plotScatter, aes(x = untransformed, y = transformed)) + geom_point() + 
  geom_abline(slope = 1, intercept = 0) + facet_wrap(~cellType)
```

Facet on cell types, excluding Plasmablasts.

```{r}
ggplot(plotScatter[!plotScatter$cellType %in% c("Plasmablasts"),], 
       aes(x = untransformed, y = transformed)) + geom_point() + 
  geom_abline(slope = 1, intercept = 0) + facet_wrap(~cellType)
```

## log2(TPM+1) expression

Scatterplots of marker log2(TPM+1) expression, comparing before and after 
rescaling.

```{r}
plotDataUntransformed <- as.matrix(refTpmLog2Filter)
plotDataTransformed <- as.matrix(refTpmLog2TransformedFilter)
```

```{r, include = FALSE}
# checks
dim(plotDataUntransformed)
dim(plotDataTransformed)
identical(rownames(plotDataUntransformed), rownames(plotDataTransformed))
identical(colnames(plotDataUntransformed), colnames(plotDataTransformed))
# get tall plot versions
untransformedMelt <- melt(plotDataUntransformed)
transformedMelt <- melt(plotDataTransformed)
identical(untransformedMelt$Var1, transformedMelt$Var1)
identical(untransformedMelt$Var2, transformedMelt$Var2)
```

```{r}
plotScatter <- data.frame(untransformed = untransformedMelt[,"value"],
                          transformed = transformedMelt[,"value"],
                          cellType = untransformedMelt[,"Var2"])
```

Overlay all cell types, markers.

```{r}
ggplot(plotScatter, aes(x = untransformed, y = transformed)) + geom_point() + 
  geom_abline(slope = 1, intercept = 0)
```

```{r}
ggplot(plotScatter, aes(x = untransformed, y = transformed, color = cellType)) + geom_point() + 
  geom_abline(slope = 1, intercept = 0)
```

Facet on cell types

```{r}
ggplot(plotScatter, aes(x = untransformed, y = transformed)) + geom_point() + 
  geom_abline(slope = 1, intercept = 0) + facet_wrap(~cellType)
```

Facet on cell types, excluding Plasmablasts.

```{r}
ggplot(plotScatter[!plotScatter$cellType %in% c("Plasmablasts"),], 
       aes(x = untransformed, y = transformed)) + geom_point() + 
  geom_abline(slope = 1, intercept = 0) + facet_wrap(~cellType)
```





# Session info

```{r}
sessionInfo()
```
