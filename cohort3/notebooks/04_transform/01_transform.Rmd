---
title: "01_transform"
author: "Sean Maden"
date: "2023-11-08"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
libv <- c("ComplexHeatmap")
sapply(libv, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
setwd("..")
setwd("..")
load("./env/04_transform/01_transform_script.RData")
source("./notebooks/04_transform/00_param.R")
```

This notebook shows heatmaps of immune cell types before and after cell type 
transformation. Part of this task is to relate the normalization conditions to 
the discernability of cell type transformation difference.

# Conditions tested

Experiment condition matrix for conditions evaluated.

```{r}
df <- data.frame(
  expressionScale=c("tpm", "log2_tpm_plusone", "tpm", "log2_tpm_plusone"),
  heatmapRescale=rep("Z", 4),
  cellSizeScaleFactor=rep("sum",4)
)
knitr::kable(df, align = "c")
```

# Heatmaps TPM

## Before transformation

Showing the Z-transformed TPM scale marker expression for 17 cell types from 
ABIS-seq reference. This is without the cell scale factors transformation.

```{r, check_ztransform, include = FALSE}
# check z transformation
globalMean <- mean(refTpm)
globalSD <- sd(refTpm)
zRefTpm <- refTpm-globalMean/globalSD
zRefTpm[1,1]==refTpm[1,1]-globalMean/globalSD

identical(zRefTpm, scale(refTpm, center=TRUE, scale=FALSE))
identical(zRefTpm, scale(refTpm, center=TRUE, scale=TRUE))
identical(zRefTpm, scale(refTpm, center=FALSE, scale=TRUE))
```

```{r}
heatmapTall <- scale(refTpm)
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
```

```{r, checks-untransformed, include = FALSE}

identical(zRefTpm, scale(refTpm))
identical(zRefTpm, scale(refTpm,scale=F))
head(scale(refTpm))
head(zRefTpm)

# check object dimensions
dim(heatmapTall)
head(heatmapTall)
head(markerTable)
intersect(unique(markerTable$cellType), colnames(heatmapTall))
length(intersect(unique(markerTable$cellType), colnames(heatmapTall)))
mapTable
head(rownames(heatmapTall))
head(markerTable$markerName)
length(intersect(rownames(heatmapTall), markerTable$markerName))
length(intersect(rownames(heatmapTall), markerTable$markerName))
identical(rownames(heatmapTall), markerTable$markerName)
```

```{r}
newAnnotationHeatmapList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "Z")
```

```{r}
newAnnotationHeatmapList$heatmap
```

## Before transformation

Showing the Z-transformed TPM scale marker expression for 17 cell types from 
ABIS-seq reference. This is with the cell scale factors transformation.

```{r}
heatmapTall <- scale(refTpmTransformed)
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTall <- listMarkersHarmonize[["heatmapTall"]]
markerTable <- listMarkersHarmonize[["markerTable"]]
```

```{r, checks-transformed, include = FALSE}
dim(heatmapTall)
head(heatmapTall)
head(markerTable)
intersect(unique(markerTable$cellType), colnames(heatmapTall))
length(intersect(unique(markerTable$cellType), colnames(heatmapTall)))
mapTable
head(rownames(heatmapTall))
head(markerTable$markerName)
length(intersect(rownames(heatmapTall), markerTable$markerName))
length(intersect(rownames(heatmapTall), markerTable$markerName))
identical(rownames(heatmapTall), markerTable$markerName)
```

```{r}
annotationHeatmapList <- annotationHeatmapList(
  heatmapTall, mapTable, markerTable, "Z")
```

```{r}
annotationHeatmapList$heatmap
```

# Heatmaps log2( TPM + 1 )

## Before transformation

Showing the Z-transformed log2( TPM + 1 ) scale marker expression for 17 cell 
types from ABIS-seq reference. This is without the cell scale factors 
transformation.

```{r}
heatmapTall <- scale(refTpmLog2)
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTall <- listMarkersHarmonize[["heatmapTall"]]
markerTable <- listMarkersHarmonize[["markerTable"]]
```

```{r, checks-untransformed-tpmlog2, include = FALSE}
dim(heatmapTall)
head(heatmapTall)
head(markerTable)
intersect(unique(markerTable$cellType), colnames(heatmapTall))
length(intersect(unique(markerTable$cellType), colnames(heatmapTall)))
mapTable
head(rownames(heatmapTall))
head(markerTable$markerName)
length(intersect(rownames(heatmapTall), markerTable$markerName))
length(intersect(rownames(heatmapTall), markerTable$markerName))
identical(rownames(heatmapTall), markerTable$markerName)
```

```{r}
newAnnotationHeatmapList <- annotationHeatmapList(
  heatmapTall, mapTable, markerTable, "Z")
```

```{r}
newAnnotationHeatmapList$heatmap
```

## After transformation

Showing the Z-transformed log2( TPM + 1 ) scale marker expression for 17 cell 
types from ABIS-seq reference. This is with the cell scale factors 
transformation.

```{r}
heatmapTall <- scale(refTpmLog2Transformed)
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTall <- listMarkersHarmonize[["heatmapTall"]]
markerTable <- listMarkersHarmonize[["markerTable"]]
```

```{r, checks-untransformed-tpmlog2, include = FALSE}
dim(heatmapTall)
head(heatmapTall)
head(markerTable)
intersect(unique(markerTable$cellType), colnames(heatmapTall))
length(intersect(unique(markerTable$cellType), colnames(heatmapTall)))
mapTable
head(rownames(heatmapTall))
head(markerTable$markerName)
length(intersect(rownames(heatmapTall), markerTable$markerName))
length(intersect(rownames(heatmapTall), markerTable$markerName))
identical(rownames(heatmapTall), markerTable$markerName)
```

```{r}
newAnnotationHeatmapList <- annotationHeatmapList(
  heatmapTall, mapTable, markerTable, "Z")
```

```{r}
newAnnotationHeatmapList$heatmap
```

# Session info

```{r}
sessionInfo()
```
