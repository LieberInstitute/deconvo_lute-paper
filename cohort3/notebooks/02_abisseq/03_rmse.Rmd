---
title: "RMSE ABIS-seq results"
author: "Sean Maden"
date: "2023-10-24"
output:
  pdf_document: default
  html_document: default
---

This notebook compares the RMSE across S13 samples for each cell type, using the
flow cytometry proportions as true cell proportions.

```{r setup, include=FALSE}
libv <- c("ggplot2", "gridExtra", "reshape2", "SummarizedExperiment")
sapply(libv, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
setwd("..")
setwd("..")
load("./env/02_abisseq/03_rmse_script.RData")
```

# Summaries

## F.C. proportions at overlapping cell types

### Proportions at samples with F.C. proportions 

```{r}
df.plot <- melt(df2, value = sample.id.format)
colnames(df.plot) <- c("sample.name", "sample.id", "cell.type", "proportion")
ggplot(df.plot, aes(x = sample.id, y = proportion, fill = cell.type)) + 
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("All F.C. proportions samples")
```

### Proportions at subset of S13 samples with predictions and F.C. proportions

Stacked barplots

```{r}
df.plot <- melt(df2, value = sample.id.format)
df.plot <- df.plot[df.plot$sample.id %in% df3$sample.id.format,]
colnames(df.plot) <- c("sample.name", "sample.id", "cell.type", "proportion")
df.plot$cell.type <- gsub(".fc.true", "", df.plot$cell.type)

ggplot(df.plot, aes(x = sample.id, y = proportion, fill = cell.type)) + 
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("S13 samples with predictions and F.C. proportions\n(RMSE samples)")
```

Boxplots and jittered points

```{r}
ggplot(df.plot, aes(x = cell.type, y = proportion)) +
  geom_boxplot(alpha = 0, color = "cyan") + geom_jitter(alpha = 0.5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## RMSE calculations

RMSE calculations summaries for the subset of S13 samples with predictions and 
F.C. proportions.

```{r}
knitr::kable(df.rmse.wide)
```

## RMSE summaries, for samples having F.C. true proportions available

Not all samples have F.C. proportions available. This section summarizes the 
differences between sample IDs with predictions and the subset also having
F.C. proportions.

Sample IDs with F.C. proportions but not predictions (i.e. not in S13 normal 
PBMC samples).

```{r}
unique(df2$sample.id.format[!df2$sample.id.format %in% df3$sample.id.format])
```
Sample IDs without F.C. proportions available (i.e. part of S13 normal PBMC 
samples).

```{r}
unique(df1$sample.id.format[!df1$sample.id.format %in% df3$sample.id.format])
```

```{r}
length(
  unique(
    df1$sample.id.format[!df1$sample.id.format %in% df3$sample.id.format]))
```

S13 sample IDs with predictions and F.C. proportions available.

```{r}
unique(df3$sample.id.format)
```

Number of S13 samples with predictions and F.C. proportions.

```{r}
length(unique(df3$sample.id.format))
```

# Plots

## True versus predictions proportions

Scatterplot of all cell types

```{r}

# prepare plot data for scatterplots
df.plot1 <- melt(df3[,c(1:16,18)], value = "sample.id.format")
df.plot2 <- melt(df3[,c(1,18,20:34)], value = "sample.id.format")
df.plot1$cell.type <- gsub("\\.nnls.pred$|\\.fc.true$", "", df.plot1$variable)
df.plot2$cell.type <- gsub("\\.nnls.pred$|\\.fc.true$", "", df.plot2$variable)
df.plot1$id.match <- paste0(df.plot1$sample.id.format,";",df.plot1$cell.type)
df.plot2$id.match <- paste0(df.plot2$sample.id.format,";",df.plot2$cell.type)
df.plot1 <- df.plot1[order(match(df.plot1$id.match, df.plot2$id.match)),]
identical(df.plot1$id.match, df.plot2$id.match) # TRUE
df.plot <- data.frame(id.match = df.plot1$id.match,
                      cell.type = df.plot1$cell.type,
                      sample.id = df.plot1$sample.id.format,
                      true.proportion = df.plot2$value,
                      predicted.proportion = df.plot1$value,
                      experiment.condition = df.plot1$type)
```

Scatter plot overlaying all cell types and faceting conditions

```{r}
ggplot(df.plot, aes(x = true.proportion, y = predicted.proportion, 
                    color = cell.type)) +
  geom_point(alpha = 0.5, size = 4) + geom_abline(slope = 1, yintercept = 0) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~experiment.condition) + xlab("True") + ylab("Predicted")
```

Scatter plots faceting all cell types and conditions

```{r}
ggplot(df.plot, aes(x = true.proportion, y = predicted.proportion, 
                    color = cell.type)) +
  geom_point(alpha = 0.5, size = 4) + geom_abline(slope = 1, yintercept = 0) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~experiment.condition*cell.type) + xlab("True") + ylab("Predicted") +
  xlim(0, 1) + ylim(0, 1)
```

Scatter plots of largest 3 cell types, faceting conditions

```{r}
cell.sizes <- df.tall$s.cell.size.log
names(cell.sizes) <- df.tall$cell.type
cell.sizes <- cell.sizes[rev(order(cell.sizes))]

df.plot.large <- df.plot[df.plot$cell.type %in% names(cell.sizes[1:3]),]

# OVERLAY
ggplot(df.plot.large, aes(x = true.proportion, y = predicted.proportion, 
                    color = cell.type)) +
  geom_point(alpha = 0.5, size = 4) + geom_abline(slope = 1, yintercept = 0) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~experiment.condition) + xlab("True") + ylab("Predicted") +
  xlim(0, 1) + ylim(0, 1)

# FACET
ggplot(df.plot.large, aes(x = true.proportion, y = predicted.proportion, 
                    color = cell.type)) +
  geom_point(alpha = 0.5, size = 4) + geom_abline(slope = 1, yintercept = 0) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~experiment.condition*cell.type) + xlab("True") + ylab("Predicted") +
  xlim(0, 1) + ylim(0, 1)
```

Scatter plots of smallest 3 cell types, faceting conditions

```{r}
cell.sizes <- df.tall$s.cell.size.log
names(cell.sizes) <- df.tall$cell.type
cell.sizes <- cell.sizes[order(cell.sizes)]

df.plot.small <- df.plot[df.plot$cell.type %in% names(cell.sizes[1:3]),]

# OVERLAY
ggplot(df.plot.small, aes(x = true.proportion, y = predicted.proportion, 
                    color = cell.type)) +
  geom_point(alpha = 0.5, size = 4) + geom_abline(slope = 1, yintercept = 0) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~experiment.condition) + xlab("True") + ylab("Predicted") +
  xlim(0, 1) + ylim(0, 1)

# FACET
ggplot(df.plot.small, aes(x = true.proportion, y = predicted.proportion, 
                    color = cell.type)) +
  geom_point(alpha = 0.5, size = 4) + geom_abline(slope = 1, yintercept = 0) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~experiment.condition*cell.type) + xlab("True") + ylab("Predicted") +
  xlim(0, 1) + ylim(0, 1)
```

Scatter plots of smallest 3 cell types, faceting conditions

```{r}
```

## RMSE

Scatter plot comparing scaled versus unscaled Pearson R

```{r}
ggplot(df.rmse.wide, aes(x = rmse.unscaled, y = rmse.scaled,
                         color = cell.type, size = s.cell.size)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0)
```

Barplots of difference, scaled minus unscaled

```{r}
df.rmse.wide$rmse.diff = df.rmse.wide$rmse.scaled-df.rmse.wide$rmse.unscaled
df.rmse.wide$rmse.diff.direction <- ifelse(df.rmse.wide$rmse.diff>0, "red", "blue")

ggplot(df.rmse.wide, 
       aes(x = cell.type, y = rmse.diff, fill = rmse.diff.direction)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  ylab("RMSE difference (Scaled - Unscaled)")
```

## Pearson R coefficients

Scatter plot comparing scaled versus unscaled Pearson R

```{r}
ggplot(df.rmse.wide, aes(x = pearson.r.unscaled, y = pearson.r.scaled,
                         color = cell.type, size = s.cell.size)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0)
```

Barplots of difference, scaled minus unscaled

```{r}
df.rmse.wide$pearson.r.diff = df.rmse.wide$pearson.r.scaled-df.rmse.wide$pearson.r.unscaled
df.rmse.wide$pearson.r.diff.direction <- ifelse(df.rmse.wide$pearson.r.diff>0, "red", "blue")

ggplot(df.rmse.wide, 
       aes(x = cell.type, y = pearson.r.diff, fill = pearson.r.diff.direction)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  ylab("Pearson R difference (Scaled - Unscaled)")
```

## RMSE difference versus Pearson R difference

```{r}
ggplot(df.rmse.wide, aes(x = rmse.diff, y = pearson.r.diff,
                         color = cell.type, size = s.cell.size)) + 
  geom_point() + geom_hline(yintercept = 0) + geom_vline(xintercept = 0) +
  xlab("RMSE difference (Scaled - Unscaled)") +
  ylab("Pearson R difference (Scaled - Unscaled)")
```

# Conclusions

# Session info

```{r}
sessionInfo()
```
