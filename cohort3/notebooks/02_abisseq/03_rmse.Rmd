---
title: "RMSE ABIS-seq results"
author: "Sean Maden"
date: "2023-10-24"
output:
  pdf_document: default
  html_document: default
---

This notebook compares the RMSE across S13 samples for each cell type, using the
flow cytometry proportions as true cell proportions.

```{r setup, include=FALSE}
libv <- c("ggplot2", "gridExtra", "reshape2")
sapply(libv, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
setwd("..")
setwd("..")
load("./env/02_abisseq/03_rmse_script.RData")
```

# Summaries

## F.C. proportions at overlapping cell types

### Proportions at samples with F.C. proportions 

```{r}
df.plot <- melt(df2, value = sample.id.format)
colnames(df.plot) <- c("sample.name", "sample.id", "cell.type", "proportion")
ggplot(df.plot, aes(x = sample.id, y = proportion, fill = cell.type)) + 
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("All F.C. proportions samples")
```

### Proportions at subset of S13 samples with predictions and F.C. proportions

```{r}
df.plot <- melt(df2, value = sample.id.format)
df.plot <- df.plot[df.plot$sample.id %in% df3$sample.id.format,]
colnames(df.plot) <- c("sample.name", "sample.id", "cell.type", "proportion")

ggplot(df.plot, aes(x = sample.id, y = proportion, fill = cell.type)) + 
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("S13 samples with predictions and F.C. proportions\n(RMSE samples)")
```

## RMSE calculations

RMSE calculations summaries for the subset of S13 samples with predictions and 
F.C. proportions.

```{r}
knitr::kable(df.rmse.wide)
```

## RMSE summaries, for samples having F.C. true proportions available

Not all samples have F.C. proportions available. This section summarizes the 
differences between sample IDs with predictions and the subset also having
F.C. proportions.

Sample IDs with F.C. proportions but not predictions (i.e. not in S13 normal 
PBMC samples).

```{r}
unique(df2$sample.id.format[!df2$sample.id.format %in% df3$sample.id.format])
```
Sample IDs without F.C. proportions available (i.e. part of S13 normal PBMC 
samples).

```{r}
unique(df1$sample.id.format[!df1$sample.id.format %in% df3$sample.id.format])
```

```{r}
length(
  unique(
    df1$sample.id.format[!df1$sample.id.format %in% df3$sample.id.format]))
```

S13 sample IDs with predictions and F.C. proportions available.

```{r}
unique(df3$sample.id.format)
```

Number of S13 samples with predictions and F.C. proportions.

```{r}
length(unique(df3$sample.id.format))
```

# Plots

## RMSE

Scatter plot comparing scaled versus unscaled Pearson R

```{r}
ggplot(df.rmse.wide, aes(x = rmse.unscaled, y = rmse.scaled,
                         color = cell.type, size = s.cell.size)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0)
```

Barplots of difference, scaled minus unscaled

```{r}
df.rmse.wide$rmse.diff = df.rmse.wide$rmse.scaled-df.rmse.wide$rmse.unscaled
df.rmse.wide$rmse.diff.direction <- ifelse(df.rmse.wide$rmse.diff>0, "red", "blue")

ggplot(df.rmse.wide, 
       aes(x = cell.type, y = rmse.diff, fill = rmse.diff.direction)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  ylab("RMSE difference (Scaled - Unscaled)")
```

## Pearson R coefficients

Scatter plot comparing scaled versus unscaled Pearson R

```{r}
ggplot(df.rmse.wide, aes(x = pearson.r.unscaled, y = pearson.r.scaled,
                         color = cell.type, size = s.cell.size)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0)
```

Barplots of difference, scaled minus unscaled

```{r}
df.rmse.wide$pearson.r.diff = df.rmse.wide$pearson.r.scaled-df.rmse.wide$pearson.r.unscaled
df.rmse.wide$pearson.r.diff.direction <- ifelse(df.rmse.wide$pearson.r.diff>0, "red", "blue")

ggplot(df.rmse.wide, 
       aes(x = cell.type, y = pearson.r.diff, fill = pearson.r.diff.direction)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  ylab("Pearson R difference (Scaled - Unscaled)")
```

## RMSE difference versus Pearson R difference

```{r}
ggplot(df.rmse.wide, aes(x = rmse.diff, y = pearson.r.diff,
                         color = cell.type, size = s.cell.size)) + 
  geom_point() + geom_hline(yintercept = 0) + geom_vline(xintercept = 0) +
  xlab("RMSE difference (Scaled - Unscaled)") +
  ylab("Pearson R difference (Scaled - Unscaled)")
```

# Conclusions

# Session info

```{r}
sessionInfo()
```
