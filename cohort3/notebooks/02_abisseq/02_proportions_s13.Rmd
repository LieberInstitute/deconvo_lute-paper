---
title: "02_cell_proportions_bysample_s13"
author: "Sean Maden"
date: "2023-10-23"
output:
  pdf_document: default
  html_document: default
---

This notebook compares cell type labels and amounts between the 2 refernces 
(flow cytometry and mRNA yield), and available cell type labels from the 
ABIS-seq reference.

```{r setup, include=FALSE}
libv <- c("ggplot2", "dplyr", "reshape2")
sapply(libv, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
setwd("..")
setwd("..")
load("./env/02_abisseq/02_proportions_s13_script.Rdata")
```

# Label overlap

## Check cell label overlap

Cell labels, flow cytometry proportions, FC proportions

```{r}
labels.fc <- colnames(fc.proportions)
labels.fc
```
Cell labels, reference Zref

```{r}
labels.ref <- colnames(zref)
labels.ref
```

Intersect, FC proportions, Zref cell type labels

```{r}
labels.intersect <- intersect(labels.fc, labels.ref)
labels.intersect
```

```{r}
length(labels.intersect)
```

# Summaries -- flow cytometry proportions

## Sample labels

Unique sample lables

```{r}
unique.samples.fc <- unique(fc.proportions$Sample.Name)
unique.samples.fc
```

Number unique sample labels

```{r}
length(unique.samples.fc)
```

## Evaluating one of the S13 cohort samples (id: 453W)

```{r}
sample.index <- 1 # "453W"

row.data <- fc.proportions[sample.index, seq(2,ncol(fc.proportions))]
numeric.row.data <- as.numeric(row.data)
names(numeric.row.data) <- names(row.data)
```

Flow cytometry proportions summary

```{r}
summary(numeric.row.data)
```

Most abundant cell type label

```{r}
names(numeric.row.data[numeric.row.data==max(numeric.row.data)])
```

Least abundant cell type label

```{r}
names(numeric.row.data[numeric.row.data==min(numeric.row.data)])
```

Total of proportions

```{r}
sum(numeric.row.data)
```

### Evaluating proportions from total cell profile

Barplot of proportions, original scale

```{r}
df.plot <- data.frame(cell.type = names(numeric.row.data),
                      proportion = numeric.row.data)
df.plot$cell.type <- factor(df.plot$cell.type, 
                            levels = 
                              df.plot$cell.type[
                                order(df.plot$proportion)])
df.plot$labels.intersect <- ifelse(
  df.plot$cell.type %in% labels.intersect, "TRUE", "FALSE")
```

Barplot of cell proportions (not rescaled, total exceeds 100)

```{r}
ggplot(df.plot, aes(y = cell.type, x = proportion, fill = labels.intersect)) + 
  geom_bar(stat = "identity")
```

### Evaluating proportions from reference cell profile

```{r}
df.plot <- df.plot[df.plot$labels.intersect=="TRUE",]
df.plot
```

Barplot of the amounts (unscaled)

```{r}
ggplot(df.plot, aes(y = cell.type, x = proportion)) + 
  geom_bar(stat = "identity")
```

Barplot of the fractions (rescaled, fractions of total)

```{r}
df.plot$proportion.rescale <- df.plot$proportion/sum(df.plot$proportion)

ggplot(df.plot, aes(y = cell.type, x = proportion.rescale)) + 
  geom_bar(stat = "identity")
```

## Evaluating all S13 samples on overlapping cell types

```{r}
filter.fc <- colnames(fc.proportions)[seq(2,ncol(fc.proportions))] %in%
  labels.intersect

df.plot.wide <- cbind(fc.proportions[,1,drop=F], fc.proportions[,filter.fc]) %>% as.data.frame()
df.plot.tall <- melt(df.plot.wide, id.vars = c("Sample.Name"))
colnames(df.plot.tall) <- c("sample.id", "cell.type", "proportion")
```

Total proportions of mapped cell types

```{r}
df.total.mapped <- apply(df.plot.wide[,seq(2,ncol(df.plot.wide))], 1, function(ri){sum(ri)})
df.total.mapped <- data.frame(sample.id = df.plot.wide$Sample.Name,
                              total.proportion.mapped = df.total.mapped)

ggplot(df.total.mapped, aes(x = sample.id, y = total.proportion.mapped)) +
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Summary of total mapped cell types proportions

```{r}
summary(df.total.mapped$total.proportion.mapped)
```

Cell proportions across S13 samples

```{r}
ggplot(df.plot.tall, aes(x = cell.type, y = proportion)) + 
  geom_jitter() + geom_boxplot(alpha = 0, color = "cyan") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Stacked barplots of cell proportions by sample

```{r}
ggplot(df.plot.tall, aes(x = sample.id, y = proportion, fill = cell.type)) + 
  geom_bar(stat = "identity", position = "stack", color = "black") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.text = element_text(size = 4),
        legend.title = element_text(size = 4))
```

# Summaries -- mRNA yield

## Sample labels

Unique sample labels

```{r}
unique.samples.mrna <- unique(mrna.yield$Sample_Name)
unique.samples.mrna
```

Reformat labels

```{r}
unique.samples.mrna.format <- gsub("_.*", "", unique.samples.mrna)
unique.samples.mrna.format
```

Number unique sample labels

```{r}
length(unique.samples.mrna)
```

Intersect with FC proportions

```{r}
intersect.fc.mrna <- intersect(
  fc.proportions$Sample.Name, unique.samples.mrna.format)
intersect.fc.mrna
```

Number intersecting sample labels

```{r}
length(intersect.fc.mrna)
```

Outersecting labels FC

```{r}
outersect.fc <- fc.proportions$Sample.Name[
  !fc.proportions$Sample.Name %in% unique.samples.mrna.format]
outersect.fc
```

Outersecting labels mRNA yield

```{r}
outersect.mrna <- unique.samples.mrna.format[
  !unique.samples.mrna.format %in% fc.proportions$Sample.Name]
outersect.mrna
```

Variable summaries for column "yield_ng"

```{r}
summary(mrna.yield[,"yield_ng"])
```

Variable summaries for column "pg_cell"

```{r}
summary(mrna.yield[,"pg_cell"])
```

## Evaluating one of the S13 cohort samples (id: 453W)

```{r}
mrna.sample <- mrna.yield[mrna.yield$Sample_Name=="453W_PBMC",,drop=F]
```

Values

```{r}
mrna.sample
```

## mRNA yield across samples

Original table

```{r}
knitr::kable(mrna.yield)
```

Plot Sample ID versus the column "yield_ng" (Nanograms total cell yield ?)

```{r}
df.plot <- mrna.yield

ggplot(df.plot, aes(x = Sample_Name, y = yield_ng)) + geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Yield NG versus PG, original values

```{r}
ggplot(df.plot, aes(x = pg_cell, y = yield_ng)) + 
  geom_point(size = 4, alpha = 0.5) + geom_abline(slope = 1, intercept = 0)
```

Yield NG versus PG, ranks

```{r}
df.plot <- df.plot[order(df.plot$pg_cell),]
df.plot$pg_cell.rank <- seq(nrow(df.plot))
  
df.plot <- df.plot[order(df.plot$yield_ng),]
df.plot$yield_ng.rank <- seq(nrow(df.plot))

ggplot(df.plot, aes(x = pg_cell.rank, y = yield_ng.rank)) + 
  geom_point(size = 4, alpha = 0.5) + geom_abline(slope = 1, intercept = 0)
```

# Conclusions

Flow cytometry proportions table contains "parts" (not fractions or percentages) 
of cell signal amounts (i.e. includes <1 cell not discrete cell counts). mRNA 
yield amounts reflect total cell amounts rather than cell type-specific amounts 
(i.e. one value per sample). 12/13 of the S13 cohort samples have FC data, and 
13/13 have mRNA yields.

Flow cytometry data maps to ABIS-seq Zref cell type identifiers for 17 (of 61 
available) cell types, reflecting all ABIS-seq Zref cell types. Cell types in 
the FCS data (FC proportions table) are not mutually exclusive, but the 
overlapping reference cell type labels are. Plasmablasts and mDCs, which had 
high marker library size/cell size (see notebook `01_abisseq`), have very low 
abundances from flow cytometry. 




# Session info

```{r}
sessionInfo()
```
