---
title: "01_run"
author: "Sean Maden"
date: "2023-11-16"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
libv <- c("ComplexHeatmap", "ggplot2", "dplyr", "reshape2")
sapply(libv, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
setwd("..")
setwd("..")
load("./env/06_top10markers/01_run_script.RData")
source("./source/00_heatmap_param.R")
```

# Overview

Notebook looking at the impact of performing Z rescaling and cell size 
transformations. The following design matrix is used.

```{r, echo = FALSE}
df <- data.frame(
  expressionScale=c("TPM", "log2(TPM+1)", "TPM", "log2(TPM+1)"),
  heatmapRescale=rep("Z rescaling using scale()", 4),
  cellSizeScaleFactor=rep("Marker library size (sum expression)",4)
)
df2 <- df; df2$heatmapRescale <- "unscaled"
df <- rbind(df, df2)
knitr::kable(df, align = "c")
```

# Heatmaps

## TPM

```{r}
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)

# tpm, untransformed
heatmapData <- refTpmFilter
# z scaled
heatmapTall <- scale(heatmapData)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
zTpmList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "Z", "Scaled, untransformed")
# unscaled
heatmapTall <- heatmapData
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
tpmList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "TPM", "Unscaled, untransformed")

# tpm, transformed
heatmapData <- refTpmTransformedFilter
# z scaled
heatmapTall <- scale(heatmapData)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
zTpmTransformedList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "Z", "Scaled, transformed")
# unscaled
heatmapTall <- heatmapData
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
tpmTransformedList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "TPM", "Unscaled, transformed")
```

```{r}
heatmap1_1 <- tpmList[["heatmap"]]
heatmap1_2 <- zTpmList[["heatmap"]]
heatmap2_1 <- tpmTransformedList[["heatmap"]]
heatmap2_2 <- zTpmTransformedList[["heatmap"]]
```

### With and without Z scaling, no cell size scale transformation

```{r, fig.width = 14, fig.height = 20}
heatmap1_1 + heatmap1_2
```

### With and without Z scaling, with cell size scale transformation

```{r, fig.width = 14, fig.height = 20}
heatmap2_1 + heatmap2_2
```

### Without Z scaling, with and without cell size scale transformation

Large format

```{r, fig.width = 14, fig.height = 20}
heatmap1_1 + heatmap2_1
```

Small format

```{r, fig.width = 11, fig.height = 6}
heatmap1_1 + heatmap2_1
```

### With Z scaling, with and without cell size scale transformation

Large format

```{r, fig.width = 14, fig.height = 20}
heatmap1_1 + heatmap2_1
```

Small format

```{r, fig.width = 11, fig.height = 6}
heatmap1_1 + heatmap2_1
```

## Log2(TPM+1)

```{r}
mapTable <- mapTableImmuneCells("abis17")
markerTable <- markerTableFromList(listMarkers)

# log2(tpm+1), untransformed
heatmapData <- refTpmLog2Filter
# z scaled
heatmapTall <- scale(heatmapData)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
zTpmList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "Z", "Scaled, untransformed")
# unscaled
heatmapTall <- heatmapData
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
tpmList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "log2(TPM+1)", "Unscaled, untransformed")

# tpm, transformed
heatmapData <- refTpmLog2TransformedFilter
# z scaled
heatmapTall <- scale(heatmapData)
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
zTpmTransformedList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "Z", "Scaled, transformed")
# unscaled
heatmapTall <- heatmapData
listMarkersHarmonize <- markersHarmonize(heatmapTall, markerTable)
heatmapTallHarmonized <- listMarkersHarmonize[["heatmapTall"]]
markerTableHarmonized <- listMarkersHarmonize[["markerTable"]]
tpmTransformedList <- annotationHeatmapList(
  heatmapTallHarmonized, mapTable, markerTableHarmonized, "log2(TPM+1)", "Unscaled, transformed")
```

```{r}
heatmap1_1 <- tpmList[["heatmap"]]
heatmap1_2 <- zTpmList[["heatmap"]]
heatmap2_1 <- tpmTransformedList[["heatmap"]]
heatmap2_2 <- zTpmTransformedList[["heatmap"]]
```

### With and without Z scaling, no cell size scale transformation

```{r, fig.width = 14, fig.height = 20}
heatmap1_1 + heatmap1_2
```

### With and without Z scaling, with cell size scale transformation

```{r, fig.width = 14, fig.height = 20}
heatmap2_1 + heatmap2_2
```

### Without Z scaling, with and without cell size scale transformation

```{r, fig.width = 14, fig.height = 20}
heatmap1_1 + heatmap2_1
```

### With Z scaling, with and without cell size scale transformation

```{r, fig.width = 14, fig.height = 20}
heatmap1_2 + heatmap2_2
```


# Session info

```{r}
sessionInfo()
```
