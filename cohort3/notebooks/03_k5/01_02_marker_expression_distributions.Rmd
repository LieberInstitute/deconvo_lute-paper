---
title: "marker_expression_distributions"
author: "Sean Maden"
date: "2023-10-30"
output:
  pdf_document: default
  html_document: default
---

Documenting the ABIS-seq reference marker expression distributions. Uses TPM, 
log2(TPM+1), with and without scaling (Z score).

```{r setup, include=FALSE}
libraryVector <- c("ggplot2", "reshape2", "dplyr")
sapply(libraryVector, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
setwd("..")
setwd("..")
load("./env/03_k5/01_run_script.RData")

#---------------

#------------------
# helper functions
#------------------

# FROM EXPRESSION, GET SIMPLIFIED THRESHOLD PLOT
getQuantileTablesFromReferenceExpression <- function(
    expressionTable, heatmapNumericScaleName, quantileThresholdIndex=4, 
    quantileSeq=seq(0,1,0.25)){
  
  # boolean matrix
  booleanTable <- apply(tpmReference, 2, function(ci){
    quantileThreshold <- 
      quantile(ci, probs=quantileSeq)[quantileThresholdIndex]
    labelColumnValues <- ifelse(
      ci >= quantileThreshold, TRUE, FALSE)
    return(labelColumnValues)
  })
  # numeric matrix
  numericTable <- matrix(
    as.numeric(booleanTable), nrow = nrow(booleanTable))
  # format
  colnames(numericTable) <- 
    colnames(booleanTable) <- colnames(expressionTable)
  rownames(numericTable) <- 
    rownames(booleanTable) <- rownames(expressionTable)
  
  # heatmaps
  heatmapNumeric <- Heatmap(
    numericTable, name = heatmapNumericScaleName)
  
  # return
  returnList <- list(
    booleanTable = booleanTable, 
    numericTable = numericTable,
    heatmapNumeric = heatmapNumeric
  )
  return(returnList)
}

# FROM EXPRESSION GET PCA

# 
```

# Getting markers

## Original expression

```{r}
Heatmap(tpmReference)
Heatmap(scaleTpmReference)
Heatmap(log2TpmReference)
Heatmap(scaleLog2TpmReference)
```

## Quantile expression

Shows the threshold heatmap.

```{r}

getQuantileTablesFromReferenceExpression(
  tpmReference, "TPM", 10, seq(0,1,0.1))[[3]]

getQuantileTablesFromReferenceExpression(
  scaleTpmReference, "Z TPM", 10, seq(0,1,0.1))[[3]]

getQuantileTablesFromReferenceExpression(
  log2TpmReference, "log2 TPM", 10, seq(0,1,0.1))[[3]]

getQuantileTablesFromReferenceExpression(
  scaleLog2TpmZref, "Z log2 TPM", 10, seq(0,1,0.1))[[3]]

```

## 

```{r}
```












# Get the binary plot for TPM reference

## TPM reference

```{r}

listQuantileTables <- 
  getQuantileTablesFromReferenceExpression(tpmReference)

# test
identical(
  ifelse(
    listQuantileTables$booleanTable[1,seq(10)], 1, 0),
  listQuantileTables$numericTable[1,seq(10)]
) # TRUE

```

Plot

```{r}


# plot the numeric table

heatmap(
  as.numeric(referenceQuantile))

```

Save

```{r}
```

# Cluster

```{r}

clusterTpmReference <- prcomp(tpmReference)
clusterTpmLog2Reference <- prcomp(log2TpmReference)
clusterScaleTpmReference <- prcomp(scaleTpmReference)
clusterScaleTpmLog2Reference <- prcomp(scaleLog2TpmZref)

```

```{r}

dfplot <- melt(clusterTpmReference$x)
dfplot$cellType <- 

ggplot(clusterTpmReference$x, aes(x = PC1, y = PC2, color = )) + geom_point()

```

# Summary statistics

## TPM

```{r}
summary(tpmZref)
```

## Log2 TPM

```{r}
summary(log2TpmZref)
```

## Z score (from TPM)

```{r}
summary(zscoreTpm)
```

## Z score (from log2 TPM)

```{r}
summary(zscoreLog2TpmZref)
```

# Density plots

```{r}
meanDifferences <- function(dfplot){
  cellTypes <- colnames(dfplot)
  
  
  
  markersVector <- rownames(dfplot)
  dfMeanAllTypes <- apply(dfplot, 2, mean)
  
  
  
  lapply(markersVector, function(marker){
    
    mean(
      
    )
    
    dfPlotOut <- dfplot[,!colnames(dfplot)==cellType]
    meanOut <- apply(dfPlotDifference,2,mean)
    meanIn <- mean(dfplot[,cellType])
    
    
    
  })
  
  
}

densityPlot <- function(dfplot){
  dfplot <- melt(dfplot)
  dfplot[,2] <- as.numeric(dfplot[,2])
  
  # get pairwise mean differences
  
  plotAllMarkers <- ggplot(dfplot, aes(x = variable, y = value)) + 
    geom_density() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  
  
  return(listPlots)
}
```

## TPM

```{r}
densityPlot(zref)
```

## Log2 TPM

```{r}
densityPlot(log2TpmZref)
```

## Z score (from TPM)

```{r}
densityPlot(zscoreTpm)
```

## Z score (from log2 TPM)

```{r}
densityPlot(zscoreLog2TpmZref)
```

# Session info

```{r}
sessionInfo()
```