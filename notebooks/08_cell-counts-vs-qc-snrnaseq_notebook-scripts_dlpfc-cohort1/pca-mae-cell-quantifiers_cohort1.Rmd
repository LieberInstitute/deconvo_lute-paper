---
title: "Principal Component Analyses of MultiAssayExperiment Assays: RNAscope postprocessing and filters"
author: "Sean Maden"
date: "2023-08-10"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("GGally", "ggplot2", "MultiAssayExperiment")
sapply(libv, library, character.only = TRUE)

# plot params
celltype.quantity.title <- "Cell type quantities"
celltype.proportion.title <- "Cell type proportions"
```

This notebook shows principal component analysis (PCA) results from analyzing 
MultiAssayExperiment (MAE) data. The particular task is to compare the RNAscope 
image data after post-processed and filtering, specifically measures important 
for deconvolution including cell type quantities, proportions, and size estimates.

# Notebook metadata

* RNAscope -- This notebooks uses filtered RNAscope data that only includes the cell types Inhib, Excit, and Oligo.
* snRNAseq -- This notebook uses the snRNAseq data.

# Prep data for analysis

## Loads the MAE data

Load MAE data

```{r, include = F}
setwd("..")
setwd("..")

# load mae filtered data
folder.name <- "08_cell-counts-vs-qc-snrnaseq_notebook-scripts_dlpfc-cohort1"
mae.filtered.name <- "mae_rnascope-filtered_cohort1.rda"
mae.filtered.path <- file.path("outputs", folder.name, mae.filtered.name)
mae <- get(load(mae.filtered.path))

# source mae utilities
script.name <- "mae_utilities.R"
script.path <- file.path("notebooks", folder.name, script.name)
source(script.path)
```

## Pre-filters RNAscope data.

Get RNAscope assay name.

```{r}
rn.assay.name <- "rnascope.image"
```

Dimensions of RNAscope data, pre-filter.

```{r}
dim(mae[[rn.assay.name]])
```

Cell type abundance summaries, pre-filter.

```{r}
rn.cd <- colData(mae[[rn.assay.name]])
table(rn.cd[,"cell_type"])
table(rn.cd[,"k2"])
table(rn.cd[,"k3"])
table(rn.cd[,"k4"])
table(rn.cd[,"k2"], rn.cd[,"Sample"])
```

```{r, include  = F}
dim(mae[[rn.assay.name]])
rn <- mae[[rn.assay.name]]

#---------------
# defines filter
#---------------
# params
min.k2.filter <- 100
variable.name <- "cell_type"
variable.levels.vector <- c("Inhib", "Excit", "Oligo")
# cell type labels filter
filter.rn <- colData(rn)[,variable.name] %in% variable.levels.vector
rn.filtered <- rn[,filter.rn]
rn.cd <- colData(rn.filtered)
# min glial quantity filter by sample.id 
sample.k2.quantities <- table(rn.cd$Sample, rn.cd$k2) %>% as.data.frame()
sample.k2.glial.quantities <- sample.k2.quantities[sample.k2.quantities[,2]=="glial",]
filter.rn.sampleid.k2 <- sample.k2.glial.quantities[,3]>=100
sample.id.keep <- sample.k2.glial.quantities[filter.rn.sampleid.k2,1] %>% unique()
filter.rn <- rn.cd$Sample %in% sample.id.keep
rn.filtered <- rn.filtered[,filter.rn]

# applies filter on cell types
mae[[rn.assay.name]] <- rn.filtered
```

Dimensions of RNAscope data, post-filter.

```{r}
dim(mae[[rn.assay.name]])
```

Cell type abundance summaries, post-filter.

```{r}
rn.cd <- colData(mae[[rn.assay.name]])
table(rn.cd[,"cell_type"])
table(rn.cd[,"k2"])
table(rn.cd[,"k3"])
table(rn.cd[,"k4"])
table(rn.cd[,"k2"], rn.cd[,"Sample"])
```

## Concludes the data prep

Get cell quantities and proportions.

```{r}
rn.assay.name <- "rnascope.image"
sn.assay.name <- "sn1.rnaseq"

# filter mae on shared sample ids
sample.id.vector.sn <- unique(mae[[sn.assay.name]]$Sample)
sample.id.vector.rnascope <- unique(mae[[rn.assay.name]]$Sample)
sample.id.vector <- intersect(sample.id.vector.sn, sample.id.vector.rnascope)
filter.mae <- colData(mae)[,"sample.id"] %in% sample.id.vector
mae.filtered <- mae[,filter.mae,]

# check for zero-count sample.id values
rn.cd <- colData(mae.filtered[[rn.assay.name]])
table(rn.cd[,"k2"], rn.cd[,"Sample"])

# get group quantity df datasets
list.quantity <- get_mae_quantity_bygroup(mae.filtered, object.name.vector = names(mae.filtered))
list.proportions <- get_mae_quantity_bygroup(mae.filtered, quantity.type = "proportions",
                                             object.name.vector = names(mae.filtered))

# get analysis datasets
df.lm.quantity <- list.quantity$qdf.wide[,seq(10)]
df.lm.proportion <- list.proportions$qdf.wide[,seq(10)]
# convert variables to numeric
for(c in seq(ncol(df.lm.quantity))){
  df.lm.quantity[,c]<-as.numeric(df.lm.quantity[,c])}
for(c in seq(ncol(df.lm.proportion))){
  df.lm.proportion[,c]<-as.numeric(df.lm.proportion[,c])}
```

# Summarize platform data

```{r}
# summary variables
kcelltypes <- length(unique(list.quantity$qdf.tall$cell.type))
nplatforms <- length(mae.filtered)
platform.names <- names(mae.filtered)
jsamples <- unique(colData(mae.filtered)$sample.id)
```

Total cell types analyzed: `r kcelltypes`.

Total sample/block IDs analyzed: `r length(jsamples)`.

Total platforms analyzed: `r nplatforms`.

Unique platform names: `r platform.names`.

Unique samples/block ids: `r jsamples`.

Dimensions of each platform object in filtered `MultiAssayExperiment`:

```{r}
for(index in seq(length(mae.filtered))){
  message(names(mae.filtered)[index], ", dims:")
  print(dim(mae.filtered[[index]]))
  message("\n")
}
```

# PCA including full RNAscope after post-processing

## 1. Inspect linearity of features for PCA

This section inspects the linearity of the variables to be analyzed by PCA. Key properties 
include correlation (a.k.a. "collinearity") of each variable pair. We also wish to 
inspect the residuals of linear models of the datasets, which we perform systematically
by fitting a linear model to predict each variable using the remaining variables. Here, 
variable identity is "PLATFORM_CELLTYPE", so there are `r nplatforms*kcelltypes` 
total variables.

### Cell type quantities

Correlations and scatter plots of cell type quantities.

```{r, fig.width=15, fig.height=15}
ggpairs(df.lm.quantity, progress = F) + ggtitle("Cell type quantities")
```

Residual correlations and distributions by predictor, from cell type counts.

```{r, fig.width=15, fig.height=15}
df.res.quantity <- get_dfres(df.lm.quantity)
ggpairs(df.res.quantity, progress = F) + 
  ggtitle(paste0("Residuals, ", celltype.quantity.title))
```

### Cell type proportions

Correlations and scatter plots of cell type proportions.

```{r, fig.width=15, fig.height=15}
ggpairs(df.lm.proportion, progress = F) + ggtitle("Cell type proportions")
```

Residual correlations and distributions by predictor, from cell type proportions

```{r, fig.width=15, fig.height=15}
df.res.proportion <- get_dfres(df.lm.proportion)
ggpairs(df.res.proportion, progress = F) + 
  ggtitle(paste0("Residuals, ", celltype.proportion.title))
```

## 2. Get PCA

```{r}
# get pca results
pca.results.quantity <- pca_results_format(t(df.lm.quantity))
pca.results.proportion <- pca_results_format(t(df.lm.proportion))
plots.list.quantity <- pca_scatterplots_bygroups(pca.results.quantity)
plots.list.proportion <- pca_scatterplots_bygroups(pca.results.proportion)
```

### Cell type quantities results

View scatterplots, cell type quantities.

```{r}
plots.list.quantity$plot1 + ggtitle(celltype.quantity.title)
plots.list.quantity$plot2 + ggtitle(celltype.quantity.title)
plots.list.quantity$plot3 + ggtitle(celltype.quantity.title)
```

### Cell type proportions results

View scatterplots, cell type proportions.

```{r}
plots.list.proportion$plot1 + ggtitle(celltype.proportion.title)
plots.list.proportion$plot2 + ggtitle(celltype.proportion.title)
plots.list.proportion$plot3 + ggtitle(celltype.proportion.title)
```

# PCA not including full RNAscope after post-processing 

This repeats the PCA analysis, excluding the full post-processed RNAscope data (i.e. not having cell size filters).

```{r, include = F}
# remove assay "rn.assay.name"
filter.dflmprop <- !grepl("^rnascope.image;.*", colnames(df.lm.proportion))
df.lm.proportion <- df.lm.proportion[,filter.dflmprop]
filter.dflmquant <- !grepl("^rnascope.image;.*", colnames(df.lm.quantity))
df.lm.quantity <- df.lm.quantity[,filter.dflmquant]
# get pca results
pca.results.quantity <- pca_results_format(t(df.lm.quantity))
pca.results.proportion <- pca_results_format(t(df.lm.proportion))
plots.list.quantity <- pca_scatterplots_bygroups(pca.results.quantity)
plots.list.proportion <- pca_scatterplots_bygroups(pca.results.proportion)
```

## Cell type quantities results

View scatterplots, cell type quantities.

```{r}
plots.list.quantity$plot1 + ggtitle(celltype.quantity.title)
plots.list.quantity$plot2 + ggtitle(celltype.quantity.title)
plots.list.quantity$plot3 + ggtitle(celltype.quantity.title)
```

### Cell type proportions results

View scatterplots, cell type proportions.

```{r}
plots.list.proportion$plot1 + ggtitle(celltype.proportion.title)
plots.list.proportion$plot2 + ggtitle(celltype.proportion.title)
plots.list.proportion$plot3 + ggtitle(celltype.proportion.title)
```

# Export environment

Exports the environment to file `"mae-pca-3steps_rnascope-nucleus-size-filters_cohort1.RData"`.

```{r, include = FALSE}
setwd("..")
setwd("..")
# remove large objects
rm(mae)
rm(mae.filter)
rm(mae.final)
# save
folder.name <- "08_cell-counts-vs-qc-snrnaseq_notebook-scripts_dlpfc-cohort1"
env.name <- "mae-pca-3steps_rnascope-nucleus-size-filters_cohort1.RData"
env.path <- file.path("outputs", folder.name, env.name)
save.image(file = env.path)
```

# Session info

```{r}
sessionInfo()
```
