---
title: "cell-type-qc_cohort1"
author: "Sean Maden"
date: "2023-08-10"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("GGally", "ggplot2", "MultiAssayExperiment")
sapply(libv, library, character.only = TRUE)

# plot params
celltype.quantity.title <- "Cell type quantities"
celltype.proportion.title <- "Cell type proportions"
```

# Prepare MAE data

Load MAE data

```{r}
setwd("..")
setwd("..")

# load mae filtered data
folder.name <- "08_cell-counts-vs-qc-snrnaseq_notebook-scripts_dlpfc-cohort1"
mae.filtered.name <- "mae_rnascope-filtered_cohort1.rda"
mae.filtered.path <- file.path("outputs", folder.name, mae.filtered.name)
mae <- get(load(mae.filtered.path))

# source mae utilities
script.name <- "mae_utilities.R"
script.path <- file.path("notebooks", folder.name, script.name)
source(script.path)
```

Get cell quantities and proportions.

```{r}
# filter mae on shared sample ids
sample.id.vector.sn <- unique(mae[["sn1.rnaseq"]]$Sample)
sample.id.vector.rnascope <- unique(mae[["rnascope.image"]]$Sample)
sample.id.vector <- intersect(sample.id.vector.sn, sample.id.vector.rnascope)
filter.mae <- colData(mae)[,"sample.id"] %in% sample.id.vector
mae.filtered <- mae[,filter.mae,]

# get group quantity df datasets
list.quantity <- get_mae_quantity_bygroup(mae.filtered, object.name.vector = names(mae.filtered))
list.proportions <- get_mae_quantity_bygroup(mae.filtered, quantity.type = "proportions",
                                             object.name.vector = names(mae.filtered))

# get analysis datasets
df.lm.quantity <- list.quantity$qdf.wide[,seq(10)]
df.lm.proportion <- list.proportions$qdf.wide[,seq(10)]
# convert variables to numeric
for(c in seq(ncol(df.lm.quantity))){
  df.lm.quantity[,c]<-as.numeric(df.lm.quantity[,c])}
for(c in seq(ncol(df.lm.proportion))){
  df.lm.proportion[,c]<-as.numeric(df.lm.proportion[,c])}
```

# Summarize platform data

```{r}
# summary variables
kcelltypes <- length(unique(list.quantity$qdf.tall$cell.type))
nplatforms <- length(mae.filtered)
platform.names <- names(mae.filtered)
jsamples <- unique(colData(mae.filtered)$sample.id)
```

Total cell types analyzed: `r kcelltypes`.

Total sample/block IDs analyzed: `r length(jsamples)`.

Total platforms analyzed: `r nplatforms`.

Unique platform names: `r platform.names`.

Unique samples/block ids: `r jsamples`.

Dimensions of each platform object in filtered `MultiAssayExperiment`:

```{r}
for(index in seq(length(mae.filtered))){
  message(names(mae.filtered)[index], ", dims:")
  print(dim(mae.filtered[[index]]))
  message("\n")
}
```

# 1. Inspect linearity of features for PCA

This section inspects the linearity of the variables to be analyzed by PCA. Key properties 
include correlation (a.k.a. "collinearity") of each variable pair. We also wish to 
inspect the residuals of linear models of the datasets, which we perform systematically
by fitting a linear model to predict each variable using the remaining variables. Here, 
variable identity is "PLATFORM_CELLTYPE", so there are `r nplatforms*kcelltypes` 
total variables.

## Cell type quantities

Correlations and scatter plots of cell type quantities.

```{r}
ggpairs(df.lm.quantity, progress = F) + ggtitle("Cell type quantities")
```

Residual correlations and distributions by predictor, from cell type counts.

```{r}
df.res.quantity <- get_dfres(df.lm.quantity)
ggpairs(df.res.quantity, progress = F) + 
  ggtitle(paste0("Residuals, ", celltype.quantity.title))
```

## Cell type quantities

Correlations and scatter plots of cell type proportions.

```{r, fig.width=18}
ggpairs(df.lm.proportion, progress = F) + ggtitle("Cell type proportions")
```

Residual correlations and distributions by predictor, from cell type proportions

```{r}
df.res.proportion <- get_dfres(df.lm.proportion)
ggpairs(df.res.proportion, progress = F) + 
  ggtitle(paste0("Residuals, cell type proportions", celltype.proportion.title))
```

# 2. Get PCA

```{r}
# get pca results
pca.results.quantity <- pca_results_format(t(df.lm.quantity))
pca.results.proportion <- pca_results_format(t(df.lm.proportion))
plots.list.quantity <- pca_scatterplots_bygroups(pca.results.quantity)
plots.list.proportion <- pca_scatterplots_bygroups(pca.results.proportion)
```

## Cell type quantities results

View scatterplots, cell type quantities.

```{r}
plots.list.quantity$plot1 + ggtitle(celltype.quantity.title)
plots.list.quantity$plot2 + ggtitle(celltype.quantity.title)
plots.list.quantity$plot3 + ggtitle(celltype.quantity.title)
```

## Cell type proportions results

View scatterplots, cell type proportions.

```{r}
plots.list.proportion$plot1 + ggtitle(celltype.proportion.title)
plots.list.proportion$plot2 + ggtitle(celltype.proportion.title)
plots.list.proportion$plot3 + ggtitle(celltype.proportion.title)
```

# Export environment

```{r}
setwd("..")
setwd("..")
# remove large objects
rm(mae)
rm(mae.filter)
rm(mae.final)
# save
folder.name <- "08_cell-counts-vs-qc-snrnaseq_notebook-scripts_dlpfc-cohort1"
env.name <- "mae-pca-3steps_rnascope-nucleus-size-filters_cohort1.RData"
env.path <- file.path("outputs", folder.name, env.name)
save.image(file = env.path)
```

# Session info

```{r}
sessionInfo()
```
