---
title: "cell-type-qc_cohort1"
author: "Sean Maden"
date: "2023-08-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("GGally", "ggplot2")
sapply(libv, library, character.only = TRUE)
```

# Prepare MAE data

Load MAE data

```{r}
setwd("..")
setwd("..")
# load mae filtered data
folder.name <- "08_cell-counts-vs-qc-snrnaseq_notebook-scripts_dlpfc-cohort1"
mae.filtered.name <- "mae_rnascope-filtered_cohort1.rda"
mae.filtered.path <- file.path("outputs", folder.name, mae.filtered.name)
mae <- get(load(mae.filtered.path))
# source mae utilities
script.name <- "mae_utilities.R"
script.path <- file.path("notebooks", folder.name, script.name)
source(script.path)
```

Get cell quantities and proportions.

```{r}
# filter mae on shared sample ids
sample.id.vector <- intersect(unique(mae[["sn1.rnaseq"]]$Sample), unique(mae[["rnascope.image"]]$Sample))
filter.mae <- colData(mae)[,"sample.id"] %in% sample.id.vector
mae.filtered <- mae[,filter.mae,]

# get group quantity df datasets
list.quantity <- get_mae_quantity_bygroup(mae.filtered, object.name.vector = names(mae.filtered))
list.proportions <- get_mae_quantity_bygroup(mae.filtered, quantity.type = "proportions",
                                             object.name.vector = names(mae.filtered))

# get analysis datasets
df.lm.quantity <- list.quantity$qdf.wide[,seq(10)]
df.lm.proportion <- list.proportions$qdf.wide[,seq(10)]
# convert variables to numeric
for(c in seq(ncol(df.lm.quantity))){
  df.lm.quantity[,c]<-as.numeric(df.lm.quantity[,c])}
for(c in seq(ncol(df.lm.proportion))){
  df.lm.proportion[,c]<-as.numeric(df.lm.proportion[,c])}
```

# Summarize platform data

```{r}
kcelltypes <- length(unique(list.quantity$qdf.tall$cell.type))
kcelltypes

nplatforms <- length(mae.filtered)
nplatforms

platform.names <- names(mae.filtered)
```

Total cell types analyzed: `r kcelltypes`.

Total platforms analyzed: `r nplatforms`.

Unique platform names: `r platform.names`.

Dimensions of each platform object in filtered `MultiAssayExperiment`.

```{r}
for(index in seq(length(mae.filtered))){
  message(names(mae.filtered)[index], ", dims:")
  print(dim(mae.filtered[[index]]))
  message("\n")
}
```

# 1. Inspect linearity of features for PCA

This section inspects the linearity of the variables to be analyzed by PCA. Key properties 
include correlation (a.k.a. "collinearity") of each variable pair. We also wish to 
inspect the residuals of linear models of the datasets, which we perform systematically
by fitting a linear model to predict each variable using the remaining variables. 

The variable identity is "PLATFORM_CELLTYPE", so we have `r nplatforms*ncelltypes` total variables.

Show cell quantities by platform name.

```{r}
ggpairs(df.lm.quantity, progress = F) + ggtitle("QUANTITY")
```

```{r}
ggpairs(df.lm.proportion, progress = F) + ggtitle("PROPORTION")
```

Plot residuals across linear models

```{r}
column.index.vector <- seq(ncol(df.lm.quantity))
df.res <- do.call(cbind, lapply(column.index.vector, function(col.index){
  df.lm.iter <- data.frame(return.variable = df.lm.quantity[,col.index])
  col.seq.include <- column.index.vector[column.index.vector==!col.index]
  df.lm.iter <- cbind(df.lm.iter, df.lm.quantity[,col.seq.include])
  lm(return.variable ~ . , data = df.lm.iter)$residuals
}))
df.res <- as.data.frame(df.res)
colnames(df.res) <- colnames(df.lm.quantity)
# plot residuals
ggpairs(df.res, progress = F) + ggtitle("RESIDUALS")
```

# 2. Get PCA

````{r}
# get pca results
pca.results.quantity <- pca_results_format(t(df.lm.quantity))
pca.results.proportion <- pca_results_format(t(df.lm.proportion))

plots.list.quantity <- pca_scatterplots_bygroups(pca.results.quantity)
plots.list.proportion <- pca_scatterplots_bygroups(pca.results.proportion)

```

```{r}
plots.list.quantity$plot1
plots.list.quantity$plot2
plots.list.quantity$plot3
```

```{r}
plots.list.proportion$plot1
plots.list.proportion$plot2
plots.list.proportion$plot3
```

# 3. Comparative PCA -- variances explained in top component

```{r}
pca.cond1 <- alksdsa
pca.cond2 <- adfndsalk
lm()
```

# Export environment

```{r}
setwd("..")
setwd("..")
# remove large objects
rm(mae)
rm(mae.filter)
rm(mae.final)
# save
folder.name <- "08_cell-counts-vs-qc-snrnaseq_notebook-scripts_dlpfc-cohort1"
env.name <- "mae-pca-3steps_rnascope-nucleus-size-filters_cohort1.RData"
env.path <- file.path("outputs", folder.name, env.name)
save.image(file = env.path)
```

# Session info

```{r}
sessionInfo()
```
