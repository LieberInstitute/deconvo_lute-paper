---
title: "cell-type-qc_cohort1"
author: "Sean Maden"
date: "2023-08-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("GGally", "ggplot2")
sapply(libv, library, character.only = TRUE)
```

# Prepare MAE data

Load MAE data

```{r}
setwd("..")
setwd("..")
# load mae data
mae <- get(load(file.path("outputs", "01_prepare-datasets",
                          "mae_with-rpkm_additional-data_final.rda")))
```

Source utilities

```{r}
setwd("..")
setwd("..")
# source mae utilties
script.path <- file.path("notebooks",
                         "08_cell-counts-vs-qc-snrnaseq_notebook-scripts_dlpfc-cohort1",
                         "mae_utilities.R")
source(script.path)
```

Append absolute cell size filters.

```{r}
mae <- new_mae_with_filters(mae)
```

Get quantity data frames.

```{r}
# get sample ids
sample.id.vector <- intersect(unique(mae[["sn1.rnaseq"]]$Sample), 
                              unique(mae[["rnascope.image"]]$Sample))
filter.mae <- colData(mae)[,"sample.id"] %in% sample.id.vector
mae.filtered <- mae[,filter.mae,]

# get group quantity df datasets
list.quantity <- get_mae_quantity_bygroup(mae.filtered, object.name.vector = names(mae))
list.proportions <- get_mae_quantity_bygroup(mae.filtered, quantity.type = "proportions",
                                             object.name.vector = names(mae))

# get analysis datasets
df.lm.quantity <- list.quantity$qdf.wide[,seq(10)]
df.lm.proportion <- list.proportions$qdf.wide[,seq(10)]
# convert variables to numeric
for(c in seq(ncol(df.lm.quantity))){
  df.lm.quantity[,c]<-as.numeric(df.lm.quantity[,c])}
for(c in seq(ncol(df.lm.proportion))){
  df.lm.proportion[,c]<-as.numeric(df.lm.proportion[,c])}
```

# 1. Check linear model bias distribution

Pairs plots

```{r}
ggpairs(df.lm.quantity) + ggtitle("QUANTITY")
ggpairs(df.lm.proportion) + ggtitle("PROPORTION")
```

Get bias data and plot

```{r}
column.index.vector <- seq(ncol(df.lm.quantity))
df.res <- do.call(cbind, lapply(column.index.vector, function(col.index){
  df.lm.iter <- data.frame(return.variable = df.lm.quantity[,col.index])
  col.seq.include <- column.index.vector[column.index.vector==!col.index]
  df.lm.iter <- cbind(df.lm.iter, df.lm.quantity[,col.seq.include])
  lm(return.variable ~ . , data = df.lm.iter)$residuals
}))
df.res <- as.data.frame(df.res)
colnames(df.res) <- colnames(df.lm.quantity)
# plot residuals
ggpairs(df.res)
```

# 2. Get PCA

````{r}
# get pca results
pca.results.quantity <- pca_results_format(t(df.lm.quantity))
pca.results.proportion <- pca_results_format(t(df.lm.proportion))

plots.list.quantity <- pca_scatterplots_bygroups(pca.results.quantity)
plots.list.proportion <- pca_scatterplots_bygroups(pca.results.proportion)

```

# 3. Check PCA relationships across conditions

```{r}
```


