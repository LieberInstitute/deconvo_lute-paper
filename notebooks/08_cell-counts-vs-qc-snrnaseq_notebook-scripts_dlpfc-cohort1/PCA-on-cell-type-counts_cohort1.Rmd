---
title: "cell-type-qc_cohort1"
author: "Sean Maden"
date: "2023-08-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("GGally", "ggplot2")
sapply(libv, library, character.only = TRUE)
```

# Prepare MAE data

```{r}
setwd("..")
setwd("..")
mae <- get(
  load(
    file.path("outputs", "01_prepare-datasets", "mae_with-rpkm_additional-data_final.rda")))

script.path <- file.path("notebooks",
                         "08_cell-counts-vs-qc-snrnaseq_notebook-scripts_dlpfc-cohort1",
                         "mae_utilities.R")
source(script.path)
```

Get quantity data frames.

```{r}
# get sample ids
sample.id.vector <- intersect(unique(mae[[1]]$Sample), unique(mae[[6]]$Sample))
filter.mae <- colData(mae)[,"sample.id"] %in% sample.id.vector
mae.filtered <- mae[,filter.mae,]

# get group quantity df datasets
list.quantity <- get_mae_quantity_bygroup(mae.filtered)
list.proportions <- get_mae_quantity_bygroup(mae.filtered, quantity.type = "proportions")

# get analysis datasets
df.lm.quantity <- list.quantity$qdf.wide[,seq(4)]
df.lm.proportion <- list.proportions$qdf.wide[,seq(4)]
# convert variables to numeric
for(c in seq(ncol(df.lm.quantity))){df.lm.quantity[,c]<-as.numeric(df.lm.quantity[,c])}
for(c in seq(ncol(df.lm.proportion))){df.lm.proportion[,c]<-as.numeric(df.lm.proportion[,c])}
```

# 1. Check linear model bias distribution

Pairs plots

```{r}
ggpairs(df.lm.quantity[,seq(4)]) + ggtitle("QUANTITY")
ggpairs(df.lm.proportion[,seq(4)]) + ggtitle("PROPORTION")
```

Get bias data and plot

```{r}
column.index.vector <- seq(ncol(df.lm.quantity))
df.res <- do.call(cbind, lapply(column.index.vector, function(col.index){
  df.lm.iter <- data.frame(return.variable = df.lm.quantity[,col.index])
  col.seq.include <- column.index.vector[column.index.vector==!col.index]
  df.lm.iter <- cbind(df.lm.iter, df.lm.quantity[,col.seq.include])
  lm(return.variable ~ . , data = df.lm.iter)$residuals
}))
df.res <- as.data.frame(df.res)
colnames(df.res) <- colnames(df.lm.quantity)

# plot residuals
ggplot(df.res, )



```

# 2. Get PCA

````{r}

mae_pca <- function(){
  library(dplyr)
  library(ggplot2)
  mat.pca <- t(df.tall.ct[,seq(num.cell.types)])
  pca <- prcomp(x = mat.pca)
  
  mat.pca <- df.tall.ct[,seq(num.cell.types)]
  pca <- prcomp(x = mat.pca)
  
  
  # check dim of outputs
  res1 <- prcomp(df.tall.ct[,seq(num.cell.types)])$x
  res2 <- prcomp(t(df.tall.ct[,seq(num.cell.types)]))$x
  
  heatmap(res1)
  
  pca.res <- pca$x %>% as.data.frame()
  ggplot(pca.res, aes(x = PC1, y = PC2)) + geom_point()
  
}

```

# 3. Check PCA relationships across conditions

```{r}
```


