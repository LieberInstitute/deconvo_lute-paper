---
title: "covar-corr-demonstrations"
author: "Sean Maden"
date: "2023-07-26"
output:
  pdf_document: default
  html_document: default
---

This notebook compares properties of two types of cell scale transformations. 
For details about the transformation definitions and derivation of the dynamic 
transform, see the notebook `covar-corr-demonstrations.rmd`.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("ggplot2", "lute", "here", "dplyr")
sapply(libv, library, character.only = T)
set.seed(10)
```

# Load datasets

Random variables x1, y1.

```{r}
# get starting variables
x1 <- rnbinom(n = 10, size = 10, mu = 10)  #sample(10)
y1 <- rnbinom(n = 10, size = 10, mu = 10) #sample(10)
```

Cohort 1

```{r}
base.path <- file.path("outputs", "01_prepare-datasets")
sce1.filename <- "list-scef_markers-k2-k3-k4_ro1-dlpfc.rda"
sce1.path <- here(base.path, sce1.filename)
sce1 <- get(load(sce1.path))[[1]]
```

Cohort 2

```{r}
sce2.filename <- "sce-mrb_dlpfc.rda"
sce2.path <- here(base.path, sce2.filename)
sce2 <- get(load(sce2.path))
sce2 <- sce2[rownames(sce2) %in% rownames(sce1),]
```

# Define transformations

Static tranformation -- this is the provided s.set series.

```{r}
X <- 10
Y <- 3
```

Dynamic transformation -- this is a function of the starting expression values as well as provided s.set series.

```{r}
adj.weight.x <- function(WeightX, WeightY, x1, y1, offset=1e-5){
  # Transform x and y such that their correlation decreases, and their covariance remains negative?
  # x1 : first cell type
  # y1 : second cell type
  fract <- WeightX/WeightY
  (fract*y1*WeightY+offset)/(x1+offset)
}
get.adj <- function(x1, y1, WeightX, WeightY){
  # pseudoalgorithm
  # given a vector of normalizations, get the fraction, x/y
  # now adjust vectors x1, y1 such that the ratio is achieved
  X.adj <- adj.weight.x(WeightX = WeightX, WeightY = WeightY, x1 = x1, y1 = y1)
  Y.adj <- adj.weight.x(WeightX = WeightY, WeightY = WeightX, x1 = x1, y1 = y1)
  list(x.adj=x1*X.adj, y.adj=y1*Y.adj)
}
```

```{r}
# CRITICALITY CHECK: for identical terms (x1==y1), expect X.adj==X, Y.adj==Y
X.adj <- adj.weight.x(WeightX = X, WeightY = Y, x1 = x1[1], y1 = y1[1])
Y.adj <- adj.weight.x(WeightX = Y, WeightY = X, x1 = x1[1], y1 = y1[1])
round(X.adj)==X
round(Y.adj)==Y
```

# Compare static vs dynamic

```{r}
adj.xy <- get.adj(x1, y1, WeightX = X, WeightY = Y)
x2 <- adj.xy[[1]]
y2 <- adj.xy[[2]]
dfp <- rbind(data.frame(x = x1, y = y1, type = rep("unadj", length(x1))),
             data.frame(x = x2, y = y2, type = rep("dynamic", length(x2))))
dfp <- rbind(dfp, data.frame(x = x1*X, y = y1*Y, type = rep("static", length(x1))))
ggplot(dfp, aes(x = x, y = y, color = type)) + geom_point() + facet_wrap(~type) +
  geom_abline(slope = 1, intercept = 0) + ggtitle("Marker expression")
```

```{r}
# cor tests
# unadj
cor(dfp[dfp$type=="unadj",]$x,dfp[dfp$type=="unadj",]$y) # -0.2988827
# static
cor(dfp[dfp$type=="static",]$x,dfp[dfp$type=="static",]$y) # -0.2988827
# dynamic
cor(dfp[dfp$type=="dynamic",]$x,dfp[dfp$type=="dynamic",]$y) # [1] 0.9354588
```

```{r}
# cov tests
# unadj
cov(dfp[dfp$type=="unadj",]$x,dfp[dfp$type=="unadj",]$y) # -3.7
# static
cov(dfp[dfp$type=="static",]$x,dfp[dfp$type=="static",]$y) # -111
# dynamic
cov(dfp[dfp$type=="dynamic",]$x,dfp[dfp$type=="dynamic",]$y) # 1093.662
```

# Compare static vs dynamic -- mrb cohort2 dataset

```{r}
z.unadj <- lute:::.get_z_from_sce(sce2, "counts", "k2")

z.static <- lute:::.get_z_from_sce(sce2, "counts", "k2") %>%
  lute:::.zstransform(s = c("glial" = 3, "neuron" = 10))

ladj <- get.adj(x1 = z.unadj[,1], y1 = z.unadj[,2], WeightX = 3, WeightY = 10)

z.dynamic <- do.call(cbind, lapply(ladj, function(type.expr){type.expr}))
colnames(z.dynamic) <- c("glial", "neuron")
```

```{r}
dfp <- rbind(
  data.frame(neuron = z.unadj[,"neuron"], glial = z.unadj[,"glial"], type = rep("unadj", nrow(z.unadj))),
  data.frame(neuron = z.static[,"neuron"], glial = z.static[,"glial"], type = rep("static", nrow(z.static)))
)
dfp <- rbind(dfp,
             data.frame(
               neuron = z.dynamic[,"neuron"], glial = z.dynamic[,"glial"], 
               type = rep("dynamic", nrow(z.dynamic))))

ggplot(dfp, aes(x = neuron, y = glial, color = type)) + 
  geom_point() + facet_wrap(~type) +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Marker expression")
```

# Compare static vs dynamic -- dlpfc cohort1 dataset

```{r}
# get z matrices
z.unadj <- lute:::.get_z_from_sce(sce1, "counts", "k2")

z.static <- lute:::.get_z_from_sce(sce1, "counts", "k2") %>%
  lute:::.zstransform(s = c("glial" = 3, "neuron" = 10))

ladj <- get.adj(x1 = z.unadj[,1], y1 = z.unadj[,2], WeightX = 3, WeightY = 10)
z.dynamic <- do.call(cbind, lapply(ladj, function(type.expr){type.expr}))
colnames(z.dynamic) <- c("glial", "neuron")
```

```{r}
dfp <- rbind(
  data.frame(neuron = z.unadj[,"neuron"], glial = z.unadj[,"glial"], type = rep("unadj", nrow(z.unadj))),
  data.frame(neuron = z.static[,"neuron"], glial = z.static[,"glial"], type = rep("static", nrow(z.static)))
)
dfp <- rbind(
  dfp,
  data.frame(
    neuron = z.dynamic[,"neuron"], glial = z.dynamic[,"glial"], 
    type = rep("dynamic", nrow(z.dynamic)))
)

ggplot(dfp, aes(x = neuron, y = glial, color = type)) + 
  geom_point() + facet_wrap(~type) +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Marker expression")
```

# Compare bulk

Test if linear adjustment of bulk is impacted by static or dynamic transformation.

```{r}
mae.filename <- "mae_with-rpkm_additional-data_final.rda"
mae.path <- file.path(base.path, mae.filename)
mae <- get(load(mae.path))
```

Prep inputs

```{r}
y <- assays(mae[["bulk.rnaseq"]])[[1]]
y <- y[rownames(z.unadj),] %>% as.matrix()
# get lm fits
z.iter <- z.unadj
zlist <- list(z.unadj = z.unadj, z.static = z.static, z.dynamic = z.dynamic)
```

Perform experiment

```{r}
#-----------------
# get wide results
#-----------------
dfres <- do.call(rbind, lapply(seq(ncol(y)), function(index.y){
  dflm <- data.frame(y.expr.counts = as.numeric(y[,index.y]))
  # get df of fitted values
  dffit <- do.call(cbind, lapply(seq(length(zlist)), function(index.z){
    z.iter <- zlist[[index.z]]
    dflm$type1 <- z.iter[,1]; dflm$type2 <- z.iter[,2]
    lm(y.expr.counts~type1+type2,data=dflm)$fitted.values
  }))
  # format fitted results
  colnames(dffit) <- paste0("fitted.", names(zlist))
  z.label.iter <- names(zlist)
  dfr <- cbind(dflm, dffit)
  dfr$sample.id <- colnames(y)[index.y]
  dfr$marker.id <- rownames(z.unadj)
  return(dfr)
}))
# get differences by z type
dfres$diff.z.static.unadj <- dfres$fitted.z.static-dfres$fitted.z.unadj
dfres$diff.z.dynamic.unadj <- dfres$fitted.z.dynamic-dfres$fitted.z.unadj
dfwide <- dfres

#-----------------
# get tall results
#-----------------
# dftall <- do.call(rbind, lapply(, function()))
dftall <- reshape2::melt(dfres)
```

Plot results for single sample

```{r}
# plots the differences by z treatment
# defines the dfp filter
dftall.filter <- dftall$sample.id=="2107UNHS-0291_Br2720_Mid_Bulk"
dftall.filter <- dftall.filter & dftall$variable %in% c("diff.z.static.unadj", "diff.z.dynamic.unadj")
dfp.new <- dftall[dftall.filter,]
ggplot(dfp.new, aes(x = variable, y = value)) + geom_jitter() + geom_boxplot(alpha = 0) + facet_wrap(~sample.id)

# plots scatterplot of adj diffs by marker 
dfwide.filter <- dfwide$sample.id=="2107UNHS-0291_Br2720_Mid_Bulk"
dfp.new <- dfwide[dfwide.filter,]
ggplot(dfp.new, aes(x = diff.z.static.unadj, y = diff.z.dynamic.unadj)) + 
  geom_jitter() + geom_point() + geom_abline(slope = 1, intercept = 0) +
  geom_text(aes(label = marker.id))

# ggpairs for marker expression
colnames.filter <- c("fitted.z.unadj", "fitted.z.static", "fitted.z.dynamic")
pairs(dfwide[,colnames.filter])
```

