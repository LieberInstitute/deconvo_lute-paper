---
title: "S optimize bias, all samples, cohort1"
author: "Sean Maden"
date: "2023-08-08"
output:
  pdf_document: default
  html_document: default
---

# Key experiment notes

This experiment utilizes the same Y, Z, P definition scheme as the pseudobulk experiments 02 scripts.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("ggplot2")
sapply(libv, library, character.only = T)
```

# load results

```{r}
# load the dataset
setwd("..")
setwd("..")
load.filename <- "df-result_s-opt-bias_cohort1.rda"
load.path <- file.path("outputs", "11_soptimize-pbfit-bias_dlpfc-cohort1", load.filename)
df.res <- get(load(load.path))
df.res$abs.bias.neuron <- abs(df.res$bias.neuron.true.pred)

# do postprocessing on the dataset
# rename abs bias colname to error
colnames.filter <- colnames(df.res)=="abs.bias.neuron"
colnames(df.res)[colnames.filter] <- "error.neuron"
```

# Plot results summaries

Heatmap of k2 scale factors (field axes) by error (gradient).

```{r}
ggplot(df.res, aes(x = neuron, y = glial)) + theme_bw() +
  geom_raster(aes(fill = error.neuron)) +
  scale_fill_gradientn(colours = rainbow(5)) + facet_wrap(~sample.id) +
  geom_hline(yintercept = 3) + geom_vline(xintercept = 10) +
  geom_abline(slope = 1, intercept = 0)
```

Scatterplots of K2_1 by K2_1 bias, color by block ID.

```{r}
# neuron
ggplot(df.res, aes(x = neuron, y = bias.neuron.true.pred, color = sample.id)) + 
  geom_point(alpha = 0.2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0) +
  ggtitle("Neuron")

# glial
ggplot(df.res, aes(x = glial, y = bias.glial.true.pred, color = sample.id)) + 
  geom_point(alpha = 0.2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0) +
  ggtitle("Glial")
```

Scatterplots of K2_1 by K2_1 bias, color by K2_2 cell size.

```{r}
# neuron
ggplot(df.res, aes(x = neuron, y = bias.neuron.true.pred, color = glial)) + 
  geom_point(alpha = 0.2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0) +
  ggtitle("Neuron")

# glial
ggplot(df.res, aes(x = glial, y = bias.glial.true.pred, color = neuron)) + 
  geom_point(alpha = 0.2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0) +
  ggtitle("Glial")
```

Smooth lines by

```{r}
ggplot(df.res, aes(x = neuron, y = bias.neuron.true.pred, color = sample.id)) + 
  theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0) +
  geom_smooth(method = "glm", se = T)

ggplot(df.res, aes(x = neuron, y = bias.neuron.true.pred, color = sample.id)) + 
  theme_bw() + geom_smooth(method = "glm", se = T) + geom_hline(yintercept = 0)

ggplot(df.res, aes(x = neuron, y = bias.glial.true.pred, color = sample.id)) + 
  theme_bw() + geom_smooth(method = "glm", se = T) + geom_hline(yintercept = 0)
```

# Plots highlighting lowest bias values

```{r}
highlight.color <- "red"
```

Highlight minimum across blocks.

```{r}
df.res$minimum.bias <- df.res$bias.neuron.true.pred==min(df.res$abs.bias.neuron)
# red and gray color scheme
ggplot(df.res, aes(x = glial, y = neuron, color = minimum.bias)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color, "FALSE" = "gray")) +
  facet_wrap(~sample.id)
```

Highlight lowest 10th quantile across blocks.

```{r}
# quantile filter
quant <- quantile(df.res$abs.bias.neuron, seq(0,1,0.1))
df.res$lowest.decile.bias <- df.res$abs.bias.neuron <= quant[2]
# red and gray color scheme
ggplot(df.res, aes(x = glial, y = neuron, color = lowest.decile.bias)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color, "FALSE" = "gray")) +
  facet_wrap(~sample.id)
```

# Plots highlighting highest bias values

```{r}
highlight.color <- "blue"
```

Highlight maximum across blocks.

```{r}
df.res$maximum.bias <- df.res$abs.bias.neuron==max(df.res$abs.bias.neuron)
# red and gray color scheme
ggplot(df.res, aes(x = glial, y = neuron, color = maximum.bias)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color, "FALSE" = "gray")) +
  facet_wrap(~sample.id)
```

Highlight highest 10th quantile across blocks.

```{r}
# quantile filter
quant <- quantile(df.res$abs.bias.neuron, seq(0,1,0.1))
df.res$highest.decile <- df.res$abs.bias.neuron>=quant[10]
# red and gray color scheme
ggplot(df.res, aes(x = glial, y = neuron, color = highest.decile)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color, "FALSE" = "gray")) +
  facet_wrap(~sample.id)
```



