---
title: "Compare Experiment Conditions Cohort1"
author: "Sean Maden"
date: "2023-08-28"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
libv <- c("ggplot2", "dplyr", "scuttle")
sapply(libv, library, character.only = T)
knitr::opts_chunk$set(echo = TRUE)
folder.name <- "14_compare-expt-conditions-cohort1"

# load assays
mae.path <- "C:/Users/User/Documents/GitHub/deconvo_method-paper/outputs/01_prepare-datasets/mae_y-rpkm_z-validate_cohort1.rda"
mae <- get(load(mae.path))
```



```{r, include = FALSE}
# load
setwd("..")
setwd("..")

# df.rnascope.kdata
df.rn.path <- file.path("outputs", "01_prepare-datasets", "df-rnascope-info_cohort1.rda")
df.rn <- get(load(df.rn.path))

# source scripts
base.path <- file.path("code", folder.name)
list.files(base.path)
script.paths <- c(file.path(base.path, "00_source_example-soptimize-framework-lute.R"),
                  file.path(base.path, "00_source-deconvo-plots.R"),
                  file.path(base.path, "01_source-example-crossval-sopt.R"))
sapply(script.paths, source)
```

# Setup experiment parameters

```{r, include = FALSE}
# assay parameters
assay.name.lute <- "logcounts"
group.name.experiment <- "sample.id"
validation.sample.id <- c("Br6432", "Br6522", "Br8667")
rd.geneid.var.y <- "Symbol"
rd.geneid.var.sce <- "gene_name"
y.group.variable.name <- "batch.id2"
# mae metadata
cd.mae <- colData(mae)
cd.mae$sample.id.new <- gsub("_.*", "", cd.mae$sample.id)
```

# 1. K2 results

Set up the snRNAseq data with K markers.

```{r, include = FALSE}
# sce
sce <- mae[["sn1.all.rnaseq"]]
sce <- logNormCounts(sce)
sce$sample.id <- sce$Sample

# get y
y.unadj <- mae[["bulk.rnaseq"]]
rownames(y.unadj) <- rowData(y.unadj)[,rd.geneid.var.y]
y.unadj <- y.unadj[rownames(y.unadj) %in% rownames(sce),]
y.unadj <- y.unadj[order(match(rownames(y.unadj), rownames(sce))),]
y.unadj <- logNormCounts(y.unadj)
y.unadj$sample.id <- y.unadj$batch.id2
y.train <- y.unadj[,!y.unadj$BrNum %in% validation.sample.id]
y.validate <- y.unadj[,y.unadj$BrNum %in% validation.sample.id]

# get list.df.true, rnascope data
celltype.variable <- k.variable.name <- "k2"
sce <- sce[,!sce[[celltype.variable]]=="other"]
unique.types <- unique(sce[[celltype.variable]])
list.df.true <- df.true.list(df.rn, unique(y.unadj[[group.name.experiment]]), 
                             celltype.variable, unique.types)

# get sample.id.vector
sample.id.vector <- unique(sce$sample.id)

# set dfs
dfs.rn <- t(df.rn) %>% as.data.frame()
dfs.rn <- dfs.rn[dfs.rn$k.label=="k2",]
dfs.rn <- data.frame(s.glial = dfs.rn[dfs.rn$cell_type=="glial",]$cell_size,
                     s.neuron = dfs.rn[dfs.rn$cell_type=="neuron",]$cell_size,
                     sample.id.dfs.rn = dfs.rn[dfs.rn$cell_type=="neuron",]$sample_id)
for(c in seq(2)){dfs.rn[,c] <- as.numeric(dfs.rn[,c])}
```

## Experiment 1A.

* $P_{true}$ : RNAscope proportions, grouped by `sample.id`.
* $G$ : Batch-robust markers from training ($N$ = 20 genes per celltype $k$).
* $Z$ : Matched or unmatched expression, grouped by `sample.id`.
* $S$ : Tests sizes from RNAscope cell sizes, grouped by `sample.id`.

```{r, include = F}
k2.1a.result.list <- kmatch_experiment(k.variable.name = k.variable.name,
                              sce = sce, 
                              dfs.train = dfs.rn,
                              sample.id.vector = sample.id.vector, 
                              list.df.true = list.df.true,
                              y.eset = y.unadj, y.train = y.train, 
                              y.validate = y.validate, 
                              assay.name = assay.name.lute, 
                              group.name = group.name.experiment)
k2.1a.result.path <- "k2_1a_rnsizes_result_list.rda"
save(k2.1a.result.list, file = k2.1a.result.path)
```

Tabular results summary

```{r}
df.res1 <- k2.1a.result.list$crossval.unmatched.result$df.res.train
df.res2 <- k2.1a.result.list$crossval.matched.result$df.res.train

df.res1$experiment.type <- "matched"
df.res2$experiment.type <- "unmatched"
df.res <- as.data.frame(rbind(df.res1, df.res2))

colnames(df.res)[6] <- "dfs.rn.sample.id"
cd.ytrain <- colData(y.train)
df.res$y.expt.condition <- cd.ytrain[df.res$y.sample.label,]$expt_condition
df.res$cell.compartment <- cd.ytrain[df.res$y.sample.label,]$library_prep
df.res$library.type <- cd.ytrain[df.res$y.sample.label,]$library_type
```

## Summarize matched RNAscope sizes results

Summaries by sample id, treatment

```{r}
df.res.filt <- df.res[df.res$sample.id == df.res$dfs.rn.sample.id,]
dim(df.res.filt)
# get facet summaries
ggplot(df.res.filt, aes(x = experiment.type, y = error.neuron.true.pred)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~y.expt.condition)
ggplot(df.res.filt, aes(x = experiment.type, y = error.neuron.true.pred)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~cell.compartment)
ggplot(df.res.filt, aes(x = experiment.type, y = error.neuron.true.pred)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~library.type)
ggplot(df.res.filt, aes(x = experiment.type, y = error.neuron.true.pred)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~sample.id)
```

Summaries by sample id

```{r}
dft <- aggregate(error.neuron.true.pred~sample.id*experiment.type, data = df.res.filt, FUN = "median")
colnames(dft)[3] <- paste0("median.", colnames(dft)[3])

ggplot(dft, aes(x = experiment.type, y = median.error.neuron.true.pred)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched")
```

## Summarize all RNAscope sizes results

```{r}
dft.all <- df.res[,c("y.sample.label", "sample.id", "error.neuron.true.pred", "experiment.type")]
sample.id.variable <- unique(dft.all$sample.id)
expt.name.variable <- unique(dft.all$experiment.type)

# by sample.id, experiment
error.summary.vector <- do.call(rbind, lapply(sample.id.variable, function(sample.id){
  filter <- dft.all$sample.id==sample.id
  do.call(rbind, lapply(expt.name.variable, function(type.name){
    filter.name <- filter & dft.all$experiment.type==type.name
    median(as.numeric(dft.all[filter.name,]$error.neuron.true.pred))
  }))
}))
dft <- data.frame(median.error.neuron = error.summary.vector,
           sample.id = rep(sample.id.variable, each = length(expt.name.variable)),
           expt.name = rep(expt.name.variable, length(sample.id.variable)))
ggplot(dft, aes(x = expt.name, y = median.error.neuron)) + geom_violin(draw_quantiles = 0.5)
ggplot(dft, aes(x = expt.name, y = median.error.neuron)) + geom_jitter(alpha = 0.5) + geom_boxplot(alpha = 0, color = "cyan")
```

# Session info

```{r, include = F}
sessionInfo()
```
