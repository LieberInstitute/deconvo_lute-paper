---
title: "Compare Experiment Conditions Cohort1"
author: "Sean Maden"
date: "2023-08-28"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
libv <- c("ggplot2", "dplyr", "scuttle", "MultiAssayExperiment", "SingleCellExperiment")
sapply(libv, library, character.only = T)
knitr::opts_chunk$set(echo = TRUE)
folder.name <- "14_compare-expt-conditions-cohort1"
```

```{r, include = FALSE, eval = FALSE}
folder.name <- "14_compare-expt-conditions-cohort1"

# load assays
mae.filename <- "mae_y-rpkm_z-validate_cohort1.rda"
mae.path <- file.path("C:/Users/User/Documents/GitHub/deconvo_method-paper/outputs/01_prepare-datasets", mae.filename)
mae <- get(load(mae.path))

# load
setwd("..")
setwd("..")

# df.rnascope.kdata
df.rn.path <- file.path("outputs", "01_prepare-datasets", "df-rnascope-info_cohort1.rda")
df.rn <- get(load(df.rn.path))

# source scripts
base.path <- file.path("code", folder.name)
list.files(base.path)
script.paths <- c(file.path(base.path, "00_source_example-soptimize-framework-lute.R"),
                  file.path(base.path, "00_source-deconvo-plots.R"),
                  file.path(base.path, "01_source-example-crossval-sopt.R"))
sapply(script.paths, source)
```

# Setup experiment parameters

```{r, include = FALSE, eval = FALSE}
# assay parameters
assay.name.lute <- "logcounts"
group.name.experiment <- "sample.id"
validation.sample.id <- c("Br6432", "Br6522", "Br8667")
rd.geneid.var.y <- "Symbol"
rd.geneid.var.sce <- "gene_name"
y.group.variable.name <- "batch.id2"
# mae metadata
cd.mae <- colData(mae)
cd.mae$sample.id.new <- gsub("_.*", "", cd.mae$sample.id)
```

# 1. K2 results

Set up the snRNAseq data with K markers.

```{r, include = FALSE, eval = FALSE}
# sce
sce <- mae[["sn1.all.rnaseq"]]
sce <- logNormCounts(sce)
sce$sample.id <- sce$Sample

# get y
y.unadj <- mae[["bulk.rnaseq"]]
rownames(y.unadj) <- rowData(y.unadj)[,rd.geneid.var.y]
y.unadj <- y.unadj[rownames(y.unadj) %in% rownames(sce),]
y.unadj <- y.unadj[order(match(rownames(y.unadj), rownames(sce))),]
y.unadj <- logNormCounts(y.unadj)
y.unadj$sample.id <- y.unadj$batch.id2
y.train <- y.unadj[,!y.unadj$BrNum %in% validation.sample.id]
y.validate <- y.unadj[,y.unadj$BrNum %in% validation.sample.id]

# get list.df.true, rnascope data
celltype.variable <- k.variable.name <- "k2"
sce <- sce[,!sce[[celltype.variable]]=="other"]
unique.types <- unique(sce[[celltype.variable]])
list.df.true <- df.true.list(df.rn, unique(y.unadj[[group.name.experiment]]), 
                             celltype.variable, unique.types)

# get sample.id.vector
sample.id.vector <- unique(sce$sample.id)

# set dfs
dfs.rn <- t(df.rn) %>% as.data.frame()
dfs.rn <- dfs.rn[dfs.rn$k.label=="k2",]
dfs.rn <- data.frame(s.glial = dfs.rn[dfs.rn$cell_type=="glial",]$cell_size,
                     s.neuron = dfs.rn[dfs.rn$cell_type=="neuron",]$cell_size,
                     sample.id.dfs.rn = dfs.rn[dfs.rn$cell_type=="neuron",]$sample_id)
for(c in seq(2)){dfs.rn[,c] <- as.numeric(dfs.rn[,c])}
```

## Experiment 1A.

* $P_{true}$ : RNAscope proportions, grouped by `sample.id`.
* $G$ : Batch-robust markers from training ($N$ = 20 genes per celltype $k$).
* $Z$ : Matched or unmatched expression, grouped by `sample.id`.
* $S$ : Tests sizes from RNAscope cell sizes, grouped by `sample.id`.

```{r, include = F, eval = F}
k2.1a.result.list <- kmatch_experiment(k.variable.name = k.variable.name,
                                        sce = sce, 
                                        dfs.train = dfs.rn,
                                        validate.dfs = FALSE,
                                        sample.id.vector = sample.id.vector, 
                                        list.df.true = list.df.true,
                                        y.eset = y.unadj, y.train = y.train, 
                                        y.validate = y.validate, 
                                        assay.name = assay.name.lute, 
                                        group.name = group.name.experiment)
k2.1a.result.path <- "k2_1a_rnsizes_result_list.rda"
save(k2.1a.result.list, file = k2.1a.result.path)
```

## Summarize matched RNAscope sizes results -- train

Tabular results summary

```{r, include = FALSE, eval = FALSE}
env.path <- "k2_1a_rnsizes_result_list.rda"
load(env.path)

df.res1 <- k2.1a.result.list$crossval.unmatched.result$df.res.train
df.res2 <- k2.1a.result.list$crossval.matched.result$df.res.train

df.res1$experiment.type <- "matched"
df.res2$experiment.type <- "unmatched"
df.res <- as.data.frame(rbind(df.res1, df.res2))

colnames(df.res)[6] <- "dfs.rn.sample.id"
cd.ytrain <- colData(y.train)
df.res$y.expt.condition <- cd.ytrain[df.res$y.sample.label,]$expt_condition
df.res$cell.compartment <- cd.ytrain[df.res$y.sample.label,]$library_prep
df.res$library.type <- cd.ytrain[df.res$y.sample.label,]$library_type

df.res.train <- df.res
```

```{r, include = FALSE, eval = F}
# get the validation results for plotting
df.res1 <- k2.1a.result.list$crossval.unmatched.result$df.res.validate
df.res2 <- k2.1a.result.list$crossval.matched.result$df.res.validate

df.res1$experiment.type <- "matched"
df.res2$experiment.type <- "unmatched"
df.res <- as.data.frame(rbind(df.res1, df.res2))

colnames(df.res)[6] <- "dfs.rn.sample.id"
cd.ytrain <- colData(y.validate)
df.res$y.expt.condition <- cd.ytrain[df.res$y.sample.label,]$expt_condition
df.res$cell.compartment <- cd.ytrain[df.res$y.sample.label,]$library_prep
df.res$library.type <- cd.ytrain[df.res$y.sample.label,]$library_type

df.res.validate <- df.res
```

# Export env

```{r, include = F, eval = F}
# save the notebook env
env.name <- "02_notebook.RData"
env.path <- env.name # file.path("outputs", folder.name, env.name)
save.image(file = env.path)
```

# Results

```{r, include = T}
# load env with plot entities
setwd("..")
setwd("..")
env.name <- "02_notebook.RData"
env.path <- file.path("outputs", "14_compare-expt-conditions-cohort1", env.name)
load(file=env.path)
```

## Boxplots

### Training results

Training summaries by sample id, treatment

```{r}
df.res.filt <- df.res[df.res$sample.id == df.res$dfs.rn.sample.id,]
dim(df.res.filt)
# get facet summaries
ggplot(df.res.filt, aes(x = experiment.type, 
                        y = error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~y.expt.condition)
ggplot(df.res.filt, aes(x = experiment.type, 
                        y = error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~cell.compartment)
ggplot(df.res.filt, aes(x = experiment.type, 
                        y = error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~library.type)
ggplot(df.res.filt, aes(x = experiment.type, 
                        y = error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~sample.id)
```

Training summaries by sample id

```{r}
dft <- aggregate(error.neuron.true.pred~sample.id*experiment.type, data = df.res.filt, FUN = "median")
colnames(dft)[3] <- paste0("median.", colnames(dft)[3])

ggplot(dft, aes(x = experiment.type, 
                y = median.error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") + ggtitle("S RNAscope matched")
```

### Validation results

Validation summaries by sample id, treatment

```{r}
df.res.filt <- df.res[df.res$sample.id == df.res$dfs.rn.sample.id,]
dim(df.res.filt)
# get facet summaries
ggplot(df.res.filt, aes(x = experiment.type, 
                        y = error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~y.expt.condition)
ggplot(df.res.filt, aes(x = experiment.type, 
                        y = error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~cell.compartment)
ggplot(df.res.filt, aes(x = experiment.type, 
                        y = error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~library.type)
ggplot(df.res.filt, aes(x = experiment.type, 
                        y = error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") +
  ggtitle("S RNAscope matched") + facet_wrap(~sample.id)
```

Validation summaries by sample id

```{r}
dft <- aggregate(error.neuron.true.pred~sample.id*experiment.type, data = df.res.filt, FUN = "median")
colnames(dft)[3] <- paste0("median.", colnames(dft)[3])

ggplot(dft, aes(x = experiment.type, y = median.error.neuron.true.pred, color = sample.id)) + geom_jitter(alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + xlab("Z reference type") + ggtitle("S RNAscope matched")
```

### Compare matched vs. unmatched S RNAscope scaling results

Summaries by groups

```{r}
df.res.train$group <- "train"
df.res.validate$group <- "validate"
df.res.all <- as.data.frame(rbind(df.res.train, df.res.validate))
df.res.all$s.rn.match <- df.res.all$dfs.rn.sample.id==df.res.all$sample.id
df.res.all$match.by.group <- paste0(df.res.all$s.rn.match,";", df.res.all$group)

# xaxis : match.by.group
ggplot(df.res.all, aes(x = match.by.group, y = error.neuron.true.pred, color = sample.id)) + 
  geom_jitter(alpha = 0.5) + geom_boxplot(color = "cyan", alpha = 0) + facet_wrap(~group) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplot(df.res.all, aes(x = match.by.group, y = error.neuron.true.pred, color = sample.id)) + 
  geom_jitter(alpha = 0.5) + geom_boxplot(color = "cyan", alpha = 0) + facet_wrap(~sample.id) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplot(df.res.all, aes(x = match.by.group, y = error.neuron.true.pred, color = sample.id)) + 
  geom_jitter(alpha = 0.5) + geom_boxplot(color = "cyan", alpha = 0) + facet_wrap(~y.expt.condition) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Aggregate summaries

```{r}
dft.res.all <- aggregate(error.neuron.true.pred~s.rn.match+group+sample.id, 
                         data = df.res.all, FUN = "median")
dft.res.all
ggplot(dft.res.all, aes(x = s.rn.match, y = error.neuron.true.pred, color = sample.id)) + 
  geom_jitter(alpha = 0.5) + geom_boxplot(color = "cyan", alpha = 0) + facet_wrap(~group)
```

## Scatterplots

### Training

```{r}
dfp <- df.res.train

ggplot(dfp, aes(x = neuron.true, y = neuron.pred.nnls, color = sample.id)) + 
  geom_point(alpha = 0.5) + geom_abline(slope = 1, intercept = 0) +
  xlim(0, 1) + ylim(0, 1) + facet_wrap(~y.expt.condition)

ggplot(dfp, aes(x = neuron.true, y = neuron.pred.nnls, color = sample.id)) + 
  geom_point(alpha = 0.5) + geom_abline(slope = 1, intercept = 0) +
  xlim(0, 1) + ylim(0, 1) + facet_wrap(~cell.compartment)

ggplot(dfp, aes(x = neuron.true, y = neuron.pred.nnls, color = sample.id)) + 
  geom_point(alpha = 0.5) + geom_abline(slope = 1, intercept = 0) +
  xlim(0, 1) + ylim(0, 1) + facet_wrap(~library.type)

ggplot(dfp, aes(x = neuron.true, y = neuron.pred.nnls, color = sample.id)) + 
  geom_point(alpha = 0.5) + geom_abline(slope = 1, intercept = 0) +
  xlim(0, 1) + ylim(0, 1) + facet_wrap(~sample.id)
```

### Validation

```{r}
dfp <- df.res.validate

ggplot(dfp, aes(x = neuron.true, y = neuron.pred.nnls, color = sample.id)) + 
  geom_point(alpha = 0.5) + geom_abline(slope = 1, intercept = 0) +
  xlim(0, 1) + ylim(0, 1) + facet_wrap(~y.expt.condition)

ggplot(dfp, aes(x = neuron.true, y = neuron.pred.nnls, color = sample.id)) + 
  geom_point(alpha = 0.5) + geom_abline(slope = 1, intercept = 0) +
  xlim(0, 1) + ylim(0, 1) + facet_wrap(~cell.compartment)

ggplot(dfp, aes(x = neuron.true, y = neuron.pred.nnls, color = sample.id)) + 
  geom_point(alpha = 0.5) + geom_abline(slope = 1, intercept = 0) +
  xlim(0, 1) + ylim(0, 1) + facet_wrap(~library.type)

ggplot(dfp, aes(x = neuron.true, y = neuron.pred.nnls, color = sample.id)) + 
  geom_point(alpha = 0.5) + geom_abline(slope = 1, intercept = 0) +
  xlim(0, 1) + ylim(0, 1) + facet_wrap(~sample.id)
```

### Matched vs. not matched RNAscope

```{r}
dfp <- df.res.all

ggplot(dfp, aes(x = neuron.true, y = neuron.pred.nnls, color = sample.id)) + geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0) + xlim(0, 1) + ylim(0, 1) + facet_wrap(~match.by.group)
```

# Mean and variance summaries

## Heatmaps of medians and variances

```{r}
library(ComplexHeatmap)

```

## Scatterplots of medians and variances

```{r}
```

# Session info

```{r, include = F}
sessionInfo()
```
