---
title: "Compare Experiment Conditions Cohort1"
author: "Sean Maden"
date: "2023-08-28"
output: html_document
---

```{r setup, include=FALSE}
libv <- c("ggplot2", "dplyr", "scuttle")
sapply(libv, library, character.only = T)
knitr::opts_chunk$set(echo = TRUE)
folder.name <- "14_compare-expt-conditions-cohort1"

# load assays
mae.path <- "C:/Users/User/Documents/GitHub/deconvo_method-paper/outputs/01_prepare-datasets/mae_y-rpkm_z-validate_cohort1.rda"
mae <- get(load(mae.path))
# df.rnascope.kdata
df.rn.path <- file.path("outputs", "01_prepare-datasets", "df-rnascope-info_cohort1.rda")
df.rn <- get(load(df.rn.path))
```



```{r}
# load
setwd("..")
setwd("..")
# source scripts
base.path <- file.path("code", folder.name)
list.files(base.path)
script.paths <- c(file.path(base.path, "00_source_example-soptimize-framework-lute.R"),
                  file.path(base.path, "00_source-deconvo-plots.R"),
                  file.path(base.path, "01_source-example-crossval-sopt.R"))
sapply(script.paths, source)
```

# Setup experiment parameters

```{r}
# assay parameters
assay.name.lute <- "logcounts"
group.name.experiment <- "sample.id"
validation.sample.id <- c("Br6432", "Br6522", "Br8667")
rd.geneid.var.y <- "Symbol"
rd.geneid.var.sce <- "gene_name"
y.group.variable.name <- "batch.id2"
# mae metadata
cd.mae <- colData(mae)
cd.mae$sample.id.new <- gsub("_.*", "", cd.mae$sample.id)
```

# 1. K2 results

Set up the snRNAseq data with K markers.

```{r}
# sce
sce <- mae[["sn1.all.rnaseq"]]
sce <- logNormCounts(sce)
sce$sample.id <- sce$Sample

# get y
y.unadj <- mae[["bulk.rnaseq"]]
rownames(y.unadj) <- rowData(y.unadj)[,rd.geneid.var.y]
y.unadj <- y.unadj[rownames(y.unadj) %in% rownames(sce),]
y.unadj <- y.unadj[order(match(rownames(y.unadj), rownames(sce))),]
y.unadj <- logNormCounts(y.unadj)
y.unadj$sample.id <- y.unadj$batch.id2
y.train <- y.unadj[,!y.unadj$BrNum %in% validation.sample.id]
y.validate <- y.unadj[,y.unadj$BrNum %in% validation.sample.id]

# get list.df.true, rnascope data
celltype.variable <- k.variable.name <- "k2"
sce <- sce[,!sce[[celltype.variable]]=="other"]
unique.types <- unique(sce[[celltype.variable]])
list.df.true <- df.true.list(df.rn, unique(y.unadj[[group.name.experiment]]), 
                             celltype.variable, unique.types)

# get sample.id.vector
sample.id.vector <- unique(sce$sample.id)
```

## Experiment 1A.

* $P_{true}$ : RNAscope proportions
* $G$ : Batch-robust markers
* $Z$ : Matched or unmatched expression

```{r, include = F}
k2.result.list <- kmatch_experiment(k.variable.name = "k2",
                              sce = sce, 
                              sample.id.vector = sample.id.vector, 
                              list.df.true = list.df.true,
                              y.eset = y.unadj, y.train = y.train, 
                              y.validate = y.validate, 
                              assay.name = assay.name.lute, 
                              group.name = group.name.experiment,
                              plot.option = TRUE)

k2.result.plots <- kmatch_experiment_plots(k2.result.list)
```

## Experiment 1B.

* $P_{true}$ : snRNAseq proportions
* $G$ : Batch-robust markers
* $Z$ : Matched or unmatched expression

```{r}
list.df.true <- lapply(list.df.true, function(item){return()})
names(list.df.true) <- names(list.df.true)
k2.result.list <- kmatch_experiment(k.variable.name = "k2",
                              sce = sce, 
                              sample.id.vector = sample.id.vector, 
                              list.df.true = list(), dfs = dfs,
                              y.eset = y.unadj, y.train = y.train, 
                              y.validate = y.validate, 
                              assay.name = assay.name, 
                              celltype.variable = k.variable.name, 
                              group.name = group.name)

k2.result.plots <- kmatch_experiment_plots(k2.result.list)
```

## Experiment 1C.

* $P_{true}$ : RNAscope proportions
* $G$ : De novo markers ($N$ = 20 genes)
* $Z$ : Matched or unmatched expression

```{r}
get(load())
```

## Experiment 1D.

* $P_{true}$ : snRNAseq proportions
* $G$ : De novo markers ($N$ = 20 genes)
* $Z$ : Matched or unmatched expression

```{r}
get(load())
```

# K3 results

```{r, include = F}
k3.result.list <- kmatch_experiment(k.variable.name = "k3",
                              sce = sce, 
                              sample.id.vector = sample.id.vector, 
                              list.df.true = list.df.true, dfs = dfs,
                              y.eset = y.unadj, y.train = y.train, 
                              y.validate = y.validate, 
                              assay.name = assay.name, 
                              celltype.variable = k.variable.name, 
                              group.name = group.name)
k3.result.plots <- kmatch_experiment_plots(k3.result.list)
```

```{r}
```

# K4 results

```{r}
```

```{r}
```

# Other plots

# Session info

```{r, include = F}
sessionInfo()
```
