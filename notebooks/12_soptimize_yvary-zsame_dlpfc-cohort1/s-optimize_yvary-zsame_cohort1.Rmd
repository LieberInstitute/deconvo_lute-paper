---
title: "s-optimize_yvary-zsame_cohort1"
author: "Sean Maden"
date: "2023-08-09"
output: html_document
---

# Key experiment notes

This notebooks shows results summaries from S (cell size scale factor normalization) optimization experiments with the following conditions:

* Z is held constant (from a single snRNAseq sample).
* Y is varied (from real RNAseq data)

```{r setup, include=FALSE}
libv <- c("ggplot2")
sapply(libv, library, character.only = T)
knitr::opts_chunk$set(echo = TRUE)
```

# Plot settings

This is the chunk that toggles plot settings

```{r}
highlight.color.low <- "red"
highlight.color.high <- "blue"
background.color.highlights <- "gray"
```

# Load results

```{r}
setwd("..")
setwd("..")
load.filename <- "df-sopt-result_yvary-zsame_cohort1.rda"
load.path <- file.path("outputs", "12_soptimize_yvary-zsame_dlpfc-cohort1", load.filename)
df.res <- get(load(load.path))
```

This is the chunk that sets more operants in `df.res`.

```{r}
df.res$s.fraction.neuron.glial <- df.res$neuron/df.res$glial
df.res$log.s.fraction <- log(df.res$s.fraction.neuron.glial)
df.res$minimum.error <- df.res$error.neuron==min(df.res$minimum.error)
df.res$maximum.error <- df.res$error.neuron==max(df.res$maximum.error)
deciles.error.neuron <- quantile(df.res$error.neuron, seq(0, 1, 0.1))
df.res$minimum.decile.error <- df.res$error.neuron <= deciles.error.neuron[2]
df.res$maximum.decile.error <- df.res$error.neuron >= deciles.error.neuron[9]
```

# Plot results within a "sample-region-compartment-library"

```{r}
# This is the filter step
sample.id <- df.res$sample.labels[1]
df.res.filter <- df.res$sample.labels==sample.id
df.plot <- df.res[df.res.filter,]
# This is the inspect plot data step
message("dimensions:\n")
dim(df.plot)
message("sample ids:\n")
unique(df.plot$sample.id)
message("sample id frequencies:\n")
table(df.res$sample.id) %>% head()
message("number of unique sample ids:\n")
length(unique(df.res$sample.id))
message("summary of glial values:\n")
summary(df.res$s.fraction.neuron.glial)
message("summary of log s.fractions:\n")
summary(log(df.res$s.fraction.neuron.glial))
```

Plot heatmap -- error.neuron

```{r}
ggplot(df.plot, aes(x = glial, y = neuron)) + theme_bw() +
  geom_raster(aes(fill = error.neuron)) +
  scale_fill_gradientn(colours = rainbow(5)) + facet_wrap(~sample.id) + 
  geom_vline(xintercept = 3) + geom_hline(yintercept = 10)
```
Plot point and lineplots

```{r}
ggplot(df.plot, aes(x = neuron, y = bias.neuron.true.pred, group = glial)) + 
  geom_point(alpha = 1) + geom_line() + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

Plot points with glial value as color

```{r}
ggplot(df.plot, aes(x = neuron, y = bias.neuron.true.pred, color = glial)) + 
  geom_point(size = 2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

Plot points with s.fraction value as color

```{r}
ggplot(df.plot, aes(x = neuron, y = bias.neuron.true.pred, color = s.fraction.neuron.glial)) + 
  geom_point(size = 2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

Plot fraction versus bias

```{r}
ggplot(df.plot, aes(x = log.s.fraction, y = bias.neuron.true.pred)) + 
  geom_point(size = 2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

# Plot results across regions within a "sample-compartment-library"

This is the filter step

```{r}
# This is the filter step
cond1 <- df.res$sample.id=="Br2720"
cond2 <- grepl(".*_Bulk$", df.res$sample.labels)
df.plot <- df.res[cond1 & cond2,]
# This is the inspect plot data step
message("dimensions:\n")
dim(df.plot)
message("sample ids:\n")
unique(df.plot$sample.id)
message("sample id frequencies:\n")
table(df.plot$sample.id) %>% head()
message("number of unique sample ids:\n")
length(unique(df.plot$sample.id))
message("summary of glial values:\n")
summary(df.plot$s.fraction.neuron.glial)
message("summary of log s.fractions:\n")
summary(log(df.plot$s.fraction.neuron.glial))


```

Plot heatmap -- error.neuron, lowest value

```{r}
# recompute min/max/decile errors
df.plot$minimum.error <- df.plot$error.neuron==min(df.plot$error.neuron)
df.plot$maximum.error <- df.plot$error.neuron==max(df.plot$error.neuron)
deciles.error.neuron <- quantile(df.plot$error.neuron, seq(0, 1, 0.1))
df.plot$minimum.decile.error <- df.plot$error.neuron <= deciles.error.neuron[2]
df.plot$maximum.decile.error <- df.plot$error.neuron >= deciles.error.neuron[10]


# minimum
ggplot(df.plot, aes(x = glial, y = neuron, color = minimum.error)) + 
  geom_point(alpha = 1) + scale_color_manual(values = c("TRUE" = highlight.color.low, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
# min decile
ggplot(df.plot, aes(x = glial, y = neuron, color = minimum.decile.error)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color.low, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
# maximum
ggplot(df.plot, aes(x = glial, y = neuron, color = maximum.error)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color.high, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
# max decile
ggplot(df.plot, aes(x = glial, y = neuron, color = maximum.decile.error)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color.high, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
```
