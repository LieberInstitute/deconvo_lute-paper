---
title: "s-optimize_yvary-zsame_cohort1"
author: "Sean Maden"
date: "2023-08-09"
output: html_document
---

# Key experiment notes

This notebook shows summaries from single experiment conditions.

Results summaries from S (cell size scale factor normalization) optimization 
experiments with the following conditions:

* Z is held constant (from a single snRNAseq sample).
* Y is varied (from real RNAseq data)

```{r setup, include=FALSE}
libv <- c("ggplot2", "dplyr")
sapply(libv, library, character.only = T)
knitr::opts_chunk$set(echo = TRUE)
```

Important commented text in a code chunk:

```
IMPORTANT: this is your sample identifier manifest
* sample: Brnum, the brain identifier, specific to donor
* position: DLPFC region, anatomic region within DLPFC region, (mid, ant, post)
* cell.compartment: cellular compartment, (nuc, cyto, bulk)
* library.prep: DNA library preparation type (polyA, ribozero)

THESE ARE EQUIVALENT:
[sample]-[position]-[cell.compartment]-[library.prep]
[BLOCK_ID]-[cell.compartment]-[library.prep]
[BLOCK_ID]-[EXPERIMENT_CONDITION]
```

# Load data, postprocess, and set plot parameters

```{r}
# load results
setwd("..")
setwd("..")
load.filename <- "df-sopt-result_yvary-zsame_cohort1.rda"
load.path <- file.path("outputs", "12_soptimize_yvary-zsame_dlpfc-cohort1", load.filename)
df.res <- get(load(load.path))

# postprocess df.res
df.res$s.fraction.neuron.glial <- df.res$neuron/df.res$glial
df.res$s.fraction.neuron.glial.discrete <- as.character(round(df.res$s.fraction.neuron.glial, 2))
df.res$log.s.fraction <- log(df.res$s.fraction.neuron.glial)
df.res$minimum.error <- df.res$error.neuron==min(df.res$minimum.error)
df.res$maximum.error <- df.res$error.neuron==max(df.res$maximum.error)
deciles.error.neuron <- quantile(df.res$error.neuron, seq(0, 1, 0.1))
df.res$minimum.decile.error <- df.res$error.neuron <= deciles.error.neuron[2]
df.res$maximum.decile.error <- df.res$error.neuron >= deciles.error.neuron[9]
df.res$glial.group.label <- as.character(df.res$glial)
df.res$neuron.group.label <- as.character(df.res$neuron)

# df.res$all.highlight.categories <- ifelse(df.res$minimum.error, "min",ifelse(,,ifelse(,,ifelse())))
df.res$all.highlight.categories <- ifelse(df.res$minimum.error, "min", 
                                          ifelse(df.res$maximum.error, "max", 
                                                 ifelse(df.res$minimum.decile.error, "min.dec", 
                                                        ifelse(df.res$maximum.decile.error, "max.dec", "mid"))))
df.res$all.highlight.sizes <- ifelse(df.res$minimum.error|df.res$maximum.error, "min/max", "min.dec/max.dec/mid")

# set standard column labels
df.res$cell.compartment.id <- df.res$library.preparation
df.res$library.preparation.id <- gsub(".*_", "", df.res$cell.compartment)
df.res$block.id <- df.res$sample.id.brnum
df.res$experiment.id <- paste0(df.res$cell.compartment.id,"_",df.res$library.preparation.id)
df.res$sample.experiment <- paste0(df.res$sample.id,"_",df.res$experiment.id)
df.res$block.experiment <- paste0(df.res$block.id,"_",df.res$experiment.id)
df.res$sample.compartment <- paste0(df.res$sample.id,"_",df.res$cell.compartment.id)

# set plot parameters
highlight.color.low <- "red"
highlight.color.high <- "blue"
background.color.highlights <- "gray"

# helper functions
text.to.make.new.dfp <- function(variable.name="sample.id", value.index=1, dfp.index=1){
  text.vector1 <- paste0("id.to.get <- df.res[,'",variable.name,"'][",value.index,"]")
  text.vector2 <- paste0("filter.variable.vector <- df.res[,'",variable.name,"']==id.to.get")
  text.vector3 <- paste0("dfp",dfp.index," <- df.res[filter.variable.vector,]")
  text.vector.list <- as.list(c(text.vector1, text.vector2, text.vector3))
  return(paste0(text.vector.list, collapse = ";"))
}
```

```{r}
# viz wrapper function
deconvo_plots_list <- function(dfp, facet.variable, script.path = "deconvo_plots.R"){
  source(script.path)
  list(heatmaps = deconvo_heatmaps(dfp, facet.variable),
       scatterplots = deconvo_scatterplots(dfp),
       lineplots = deconvo_lineplots(dfp),
       deconvocanos = deconvocanos(dfp))
}

# dataset summaries function
source("dataset_summaries.R")
```

# Get the data subsets and summaries

## FILTER

This is the crucial data filter section. Could go into a script.

```{r}
## Get plot data for `[BLOCK_ID]-[EXPERIMENT_CONDITION]`
# Gets the first ID in the "sample-region-compartment-library" designation, saves as `dfp1`.
dfp1 <- parse(text=text.to.make.new.dfp("block.experiment")) %>% eval()

## Get plot data for `[SAMPLE]-[EXPERIMENT_CONDITION]` "sample-compartment-library" as
dfp2 <- parse(text=text.to.make.new.dfp("sample.experiment")) %>% eval()

## Get plot data for `[SAMPLE]-[COMPARTMENT]`
dfp3 <- parse(text=text.to.make.new.dfp("sample.compartment")) %>% eval()

## Get plot data for `[SAMPLE]`
dfp4 <- parse(text=text.to.make.new.dfp("sample.id")) %>% eval()
```

## SUMMARIZE

```{r}
list.summaries.dfp1 <- get_data_summaries(dfp1, "block.experiment")
list.summaries.dfp2 <- get_data_summaries(dfp2, "sample.experiment")
list.summaries.dfp3 <- get_data_summaries(dfp3, "sample.compartment")
list.summaries.dfp4 <- get_data_summaries(dfp4, "sample.id")
```

# Plot filtered data

## `[BLOCK_ID]-[EXPERIMENT_CONDITION]`

```{r}
list.plots.dfp1 <- deconvo_plots_list(dfp1, "anatomic.region")
```

## `[SAMPLE]-[EXPERIMENT_CONDITION]`

```{r}
list.plots.dfp2 <- deconvo_plots_list(dfp2)
```

## `[SAMPLE]-[COMPARTMENT]`

```{r}
list.plots.dfp3 <- deconvo_plots_list(dfp3)
```

## `[SAMPLE]`

```{r}
list.plots.dfp4 <- deconvo_plots_list(dfp4)
```


