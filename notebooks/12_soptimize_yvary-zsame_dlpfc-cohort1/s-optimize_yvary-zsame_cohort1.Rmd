---
title: "s-optimize_yvary-zsame_cohort1"
author: "Sean Maden"
date: "2023-08-09"
output: html_document
---

# Key experiment notes

This notebook shows summaries from single experiment conditions.

Results summaries from S (cell size scale factor normalization) optimization 
experiments with the following conditions:

* Z is held constant (from a single snRNAseq sample).
* Y is varied (from real RNAseq data)

```{r setup, include=FALSE}
libv <- c("ggplot2", "dplyr")
sapply(libv, library, character.only = T)
knitr::opts_chunk$set(echo = TRUE)
```

Important commented text in a code chunk:

```
IMPORTANT: this is your sample identifier manifest
* sample: Brnum, the brain identifier, specific to donor
* position: DLPFC region, anatomic region within DLPFC region, (mid, ant, post)
* cell.compartment: cellular compartment, (nuc, cyto, bulk)
* library.prep: DNA library preparation type (polyA, ribozero)

THESE ARE EQUIVALENT:
[sample]-[position]-[cell.compartment]-[library.prep]
[BLOCK_ID]-[cell.compartment]-[library.prep]
[BLOCK_ID]-[EXPERIMENT_CONDITION]
```

# Load data, postprocess, and set plot parameters

```{r}
# load results
setwd("..")
setwd("..")
load.filename <- "df-sopt-result_yvary-zsame_cohort1.rda"
load.path <- file.path("outputs", "12_soptimize_yvary-zsame_dlpfc-cohort1", load.filename)
df.res <- get(load(load.path))

# postprocess df.res
df.res$s.fraction.neuron.glial <- df.res$neuron/df.res$glial
df.res$s.fraction.neuron.glial.discrete <- as.character(round(df.res$s.fraction.neuron.glial, 2))
df.res$log.s.fraction <- log(df.res$s.fraction.neuron.glial)
df.res$minimum.error <- df.res$error.neuron==min(df.res$minimum.error)
df.res$maximum.error <- df.res$error.neuron==max(df.res$maximum.error)
deciles.error.neuron <- quantile(df.res$error.neuron, seq(0, 1, 0.1))
df.res$minimum.decile.error <- df.res$error.neuron <= deciles.error.neuron[2]
df.res$maximum.decile.error <- df.res$error.neuron >= deciles.error.neuron[9]
df.res$glial.group.label <- as.character(df.res$glial)
df.res$neuron.group.label <- as.character(df.res$neuron)

# set standard column labels
df.res$cell.compartment.id <- df.res$library.preparation
df.res$library.preparation.id <- gsub(".*_", "", df.res$cell.compartment)
df.res$block.id <- df.res$sample.id.brnum
df.res$experiment.id <- paste0(df.res$cell.compartment.id,"_",df.res$library.preparation.id)
df.res$sample.experiment <- paste0(df.res$sample.id,"_",df.res$experiment.id)
df.res$block.experiment <- paste0(df.res$block.id,"_",df.res$experiment.id)
df.res$sample.compartment <- paste0(df.res$sample.id,"_",df.res$cell.compartment.id)

# set plot parameters
highlight.color.low <- "red"
highlight.color.high <- "blue"
background.color.highlights <- "gray"

# helper function
text.to.make.new.dfp <- function(variable.name="sample.id", value.index=1, dfp.index=1){
  text.vector1 <- paste0("id.to.get <- df.res[,'",variable.name,"'][",value.index,"]")
  text.vector2 <- paste0("filter.variable.vector <- df.res[,'",variable.name,"']==id.to.get")
  text.vector3 <- paste0("dfp",dfp.index," <- df.res[filter.variable.vector,]")
  text.vector.list <- as.list(c(text.vector1, text.vector2, text.vector3))
  return(paste0(text.vector.list, collapse = ";"))
}
```

# Define data subsets

This is the crucial data filter section. Could go into a script.

## Get plot data for `[BLOCK_ID]-[EXPERIMENT_CONDITION]`

Gets the first ID in the "sample-region-compartment-library" designation, saves as `dfp1`.

```{r}
dfp1 <- parse(text=text.to.make.new.dfp("block.experiment")) %>% eval()
```

## Get plot data for `[SAMPLE]-[EXPERIMENT_CONDITION]` "sample-compartment-library" as

```{r}
dfp2 <- parse(text=text.to.make.new.dfp("sample.experiment")) %>% eval()
```

## Get plot data for `[SAMPLE]-[COMPARTMENT]`

```{r}
dfp3 <- parse(text=text.to.make.new.dfp("sample.compartment")) %>% eval()
```

## Get plot data for `[SAMPLE]`

```{r}
dfp4 <- parse(text=text.to.make.new.dfp("sample.id")) %>% eval()
```


# Plot filtered data

HEATLUTION PLOTS

```{r, eval = F}
# Plot heatmap -- error.neuron
ggplot(dfp1, aes(x = glial, y = neuron)) + theme_bw() +
  geom_raster(aes(fill = error.neuron)) +
  scale_fill_gradientn(colours = rainbow(5)) + 
  geom_vline(xintercept = 3) + geom_hline(yintercept = 10) +
  ggtitle(dfp1$block.experiment)

# prep heatlution plots with highlights
# recompute min/max/decile errors
dfp1$minimum.error <- dfp1$error.neuron==min(dfp1$error.neuron)
dfp1$maximum.error <- dfp1$error.neuron==max(dfp1$error.neuron)
deciles.error.neuron <- quantile(dfp1$error.neuron, seq(0, 1, 0.1))
dfp1$minimum.decile.error <- dfp1$error.neuron <= deciles.error.neuron[2]
dfp1$maximum.decile.error <- dfp1$error.neuron >= deciles.error.neuron[10]
# min highlights
ggplot(dfp1, aes(x = glial, y = neuron, color = minimum.error)) + 
  geom_point(alpha = 1) + scale_color_manual(values = c("TRUE" = highlight.color.low, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
ggplot(dfp1, aes(x = glial, y = neuron, color = minimum.decile.error)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color.low, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
# max highlights
ggplot(dfp1, aes(x = glial, y = neuron, color = maximum.error)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color.high, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
ggplot(dfp1, aes(x = glial, y = neuron, color = maximum.decile.error)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color.high, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
```




```{r, eval = F}
# SCATTERLUTION PLOTS
ggplot(dfp1, aes(x = neuron, y = bias.neuron.true.pred, group = glial)) + 
  geom_point(alpha = 1) + geom_line() + theme_bw() + 
  facet_wrap(~sample.id) + geom_hline(yintercept = 0)
# Plot points with s.fraction value as color
# continuous grouping
ggplot(dfp1, aes(x = neuron, y = bias.neuron.true.pred, 
                 color = s.fraction.neuron.glial, group = s.fraction.neuron.glial)) + 
  geom_point(size = 2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

```{r}
# DECONVOLINE PLOTS
ggplot(dfp1, aes(x = neuron, y = bias.neuron.true.pred, group = glial)) + 
  geom_line() + theme_bw() + 
  facet_wrap(~sample.id) + geom_hline(yintercept = 0)
ggplot(dfp1, aes(x = neuron, y = bias.neuron.true.pred, group = glial, color = glial)) + 
  geom_line() + theme_bw() + 
  facet_wrap(~sample.id) + geom_hline(yintercept = 0)
# discrete grouping
ggplot(dfp1, aes(x = neuron, y = bias.neuron.true.pred, group = glial.group.label, color = glial.group.label)) + 
  geom_line() + theme_bw() + 
  facet_wrap(~sample.id) + geom_hline(yintercept = 0)
ggplot(dfp1, aes(x = neuron, y = bias.neuron.true.pred, group = glial.group.label, color = glial.group.label)) + 
  geom_line() + theme_bw() + 
  facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

DECONVOCANO PLOTS

```{r, eval = F}
# DECONVOCANO_PLOTS
# Scatterplot of fraction versus bias.
ggplot(dfp1, aes(x = log.s.fraction, y = bias.neuron.true.pred)) + 
  geom_point(size = 2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
# Scatterplot of fraction versus error
ggplot(dfp1, aes(x = log.s.fraction, y = error.neuron)) + 
  geom_point(size = 2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```
