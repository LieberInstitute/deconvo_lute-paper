---
title: "s-optimize_yvary-zsame_cohort1"
author: "Sean Maden"
date: "2023-08-09"
output: html_document
---

# Key experiment notes

This notebooks shows results summaries from S (cell size scale factor normalization) optimization experiments with the following conditions:

* Z is held constant (from a single snRNAseq sample).
* Y is varied (from real RNAseq data)

```{r setup, include=FALSE}
libv <- c("ggplot2", "dplyr")
sapply(libv, library, character.only = T)
knitr::opts_chunk$set(echo = TRUE)
```

Important commented text in a code chunk:

```
IMPORTANT: this is your sample identifier manifest
* sample: Brnum, the brain identifier, specific to donor
* position: DLPFC region, anatomic region within DLPFC region, (mid, ant, post)
* cell.compartment: cellular compartment, (nuc, cyto, bulk)
* library.prep: DNA library preparation type (polyA, ribozero)

THESE ARE EQUIVALENT:
[sample]-[position]-[cell.compartment]-[library.prep]
[BLOCK_ID]-[cell.compartment]-[library.prep]
[BLOCK_ID]-[EXPERIMENT_CONDITION]
```

# Load data, postprocess, and set plot parameters

```{r}
# load results
setwd("..")
setwd("..")
load.filename <- "df-sopt-result_yvary-zsame_cohort1.rda"
load.path <- file.path("outputs", "12_soptimize_yvary-zsame_dlpfc-cohort1", load.filename)
df.res <- get(load(load.path))

# This is the chunk that sets more operants in `df.res`.
df.res$s.fraction.neuron.glial <- df.res$neuron/df.res$glial
df.res$log.s.fraction <- log(df.res$s.fraction.neuron.glial)
df.res$minimum.error <- df.res$error.neuron==min(df.res$minimum.error)
df.res$maximum.error <- df.res$error.neuron==max(df.res$maximum.error)
deciles.error.neuron <- quantile(df.res$error.neuron, seq(0, 1, 0.1))
df.res$minimum.decile.error <- df.res$error.neuron <= deciles.error.neuron[2]
df.res$maximum.decile.error <- df.res$error.neuron >= deciles.error.neuron[9]

# set standard column labels
df.res$cell.compartment <- df.res$library.preparation
df.res$library.preparation <- gsub(".*_", "", df.res$cell.compartment)

# set plot parameters
highlight.color.low <- "red"
highlight.color.high <- "blue"
background.color.highlights <- "gray"

# helper function
text.to.make.new.dfp <- function(variable.name="sample.id", value.index=1, dfp.index=1){
  text.vector1 <- paste0("id.to.get <- df.res[,'",variable.name,"'][",value.index,"]")
  text.vector2 <- paste0("filter.variable.vector <- df.res[,'",variable.name,"']==id.to.get")
  text.vector3 <- paste0("dfp",dfp.index," <- df.res[filter.variable.vector,]")
  text.vector.list <- as.list(c(text.vector1, text.vector2, text.vector3))
  return(paste0(text.vector.list, collapse = ";"))
}
```

# Define data subsets

This is the crucial data filter section. Could go into a script.

## Get plot data for `[BLOCK_ID]-[EXPERIMENT_CONDITION]`

Gets the first ID in the "sample-region-compartment-library" designation, saves as `dfp1`.

```{r}
dfp1 <- parse(text=text.to.make.new.dfp("sample.labels")) %>% eval()
```

## Get plot data for "sample-compartment-library" as

```{r}
dfp2 <- parse(text=text.to.make.new.dfp("sample.id")) %>% eval()
```

## Get plot data for "sample-compartment"

```{r}
dfp3 <- parse(text=text.to.make.new.dfp("sample.id.brnum")) %>% eval()
```

## Get plot data for "sample" 

```{r}
dfp3 <- parse(text=text.to.make.new.dfp("sample.id")) %>% eval()
```


# Plot filtered data

Plot heatmap -- error.neuron

```{r, eval = F}
ggplot(df.plot, aes(x = glial, y = neuron)) + theme_bw() +
  geom_raster(aes(fill = error.neuron)) +
  scale_fill_gradientn(colours = rainbow(5)) + facet_wrap(~sample.id) + 
  geom_vline(xintercept = 3) + geom_hline(yintercept = 10)
```

Plot point and lineplots

```{r, eval = F}
ggplot(df.plot, aes(x = neuron, y = bias.neuron.true.pred, group = glial)) + 
  geom_point(alpha = 1) + geom_line() + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

Plot points with glial value as color

```{r, eval = F}
ggplot(df.plot, aes(x = neuron, y = bias.neuron.true.pred, color = glial)) + 
  geom_point(size = 2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

Plot points with s.fraction value as color

```{r, eval = F}
ggplot(df.plot, aes(x = neuron, y = bias.neuron.true.pred, color = s.fraction.neuron.glial)) + 
  geom_point(size = 2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

Plot fraction versus bias

```{r, eval = F}
ggplot(df.plot, aes(x = log.s.fraction, y = bias.neuron.true.pred)) + 
  geom_point(size = 2) + theme_bw() + facet_wrap(~sample.id) + geom_hline(yintercept = 0)
```

## "sample-region-compartment-library"

## "sample-compartment-library"

##

##

Plot heatmap -- error.neuron, lowest value

```{r, eval = F}
# recompute min/max/decile errors
df.plot$minimum.error <- df.plot$error.neuron==min(df.plot$error.neuron)
df.plot$maximum.error <- df.plot$error.neuron==max(df.plot$error.neuron)
deciles.error.neuron <- quantile(df.plot$error.neuron, seq(0, 1, 0.1))
df.plot$minimum.decile.error <- df.plot$error.neuron <= deciles.error.neuron[2]
df.plot$maximum.decile.error <- df.plot$error.neuron >= deciles.error.neuron[10]


# minimum
ggplot(df.plot, aes(x = glial, y = neuron, color = minimum.error)) + 
  geom_point(alpha = 1) + scale_color_manual(values = c("TRUE" = highlight.color.low, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
# min decile
ggplot(df.plot, aes(x = glial, y = neuron, color = minimum.decile.error)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color.low, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
# maximum
ggplot(df.plot, aes(x = glial, y = neuron, color = maximum.error)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color.high, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
# max decile
ggplot(df.plot, aes(x = glial, y = neuron, color = maximum.decile.error)) + 
  geom_point() + scale_color_manual(values = c("TRUE" = highlight.color.high, 
                                               "FALSE" = background.color.highlights)) +
  facet_wrap(~anatomic.region)
```
