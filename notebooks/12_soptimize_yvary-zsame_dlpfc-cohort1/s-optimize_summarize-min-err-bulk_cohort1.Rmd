---
title: "s-optimize_summarize-err-min-bybulk_cohort1"
author: "Sean Maden"
date: "2023-08-14"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
libv <- c("ggplot2", "dplyr")
sapply(libv, library, character.only = T)
knitr::opts_chunk$set(echo = TRUE)
```

# Key experiment notes

This notebook shows summaries from SINGLE EXPERIMENT CONDITIONS in the bulk data.

Results summaries from S (cell size scale factor normalization) optimization 
experiments with the following conditions:
* Z is held constant (from a single snRNAseq sample).
* Y is varied (from real RNAseq data)

Important commented text in a code chunk:

```
#--------------------
# Experiment Manifest
#--------------------
IMPORTANT: this is your sample identifier manifest

DATA DICTIONARY
* sample: Brnum, the brain identifier, specific to donor
* position: DLPFC region, anatomic region within DLPFC region, (mid, ant, post)
* cell.compartment: cellular compartment, (nuc, cyto, bulk)
* library.prep: DNA library preparation type (polyA, ribozero)

COLUMN IDENTIFIERS
* base identifer pattern:
[sample.id]-[anatomic.position.id]-[cell.compartment.id]-[library.prep.id]

* primary identifier consolidation
[BLOCK_ID]-[cell.compartment.id]-[library.prep.id]

* secondary identifier consolidation
[BLOCK_ID]-[EXPERIMENT_CONDITION]

```

# Load

```{r}
# load results
setwd("..")
setwd("..")
load.filename <- "df-sopt-result_yvary-zsame_cohort1.rda"
load.path <- file.path("outputs", "12_soptimize_yvary-zsame_dlpfc-cohort1", load.filename)
df.res <- get(load(load.path))
```

# Source

Source visualization and helper functions

```{r}
# set plot parameters
highlight.color.low <- "red"
highlight.color.high <- "blue"
background.color.highlights <- "gray"
# viz wrapper functions
source("deconvo_plots.R")
# dataset summaries function(s)
source("dataset_summaries.R")
```

# Get minima by label

```{r}
length(unique(df.res$sample.labels))
labels.vector <- unique(df.res$sample.labels)
df.min <- do.call(rbind, lapply(labels.vector, function(label.iter){
  df.iter <- df.res[df.res$sample.labels==label.iter,]
  df.iter[df.iter$error.neuron == min(df.iter$error.neuron),,drop=F]
}))
df.min$min.error.neuron <- df.min$error.neuron
```

## Show field-gradient plots of highest minima

```{r}
# subset/filter
df.min.filter <- df.min$min.error.neuron==max(df.min$min.error.neuron)
sample.label.highest <- df.min[df.min.filter,]$sample.labels[1]
df.res.filter <- df.res$sample.labels==sample.label.highest
df.res.highest <- df.res[df.res.filter,]
list.plots.dfp1 <- deconvo_plots_list(df.res.highest, "sample.labels")
# plot
list.plots.dfp1$heatmaps$heatmap1
```

## Show field-gradient plots of lowest minima


```{r}
# subset/filter
df.min.filter <- df.min$min.error.neuron==min(df.min$min.error.neuron)
sample.label.highest <- df.min[df.min.filter,]$sample.labels[1]
df.res.filter <- df.res$sample.labels==sample.label.highest
df.res.highest <- df.res[df.res.filter,]
list.plots.dfp1 <- deconvo_plots_list(df.res.highest, "sample.labels")
# plot
list.plots.dfp1$heatmaps$heatmap1
```

# Plots by `sample.id`

Violin plots, by sample.id

```{r}
ggplot(df.min, aes(x = sample.id, y = min.error.neuron)) + 
  geom_jitter(alpha = 0.5) + geom_boxplot(alpha = 0, color = "cyan")
```

# Plots by `library.prep`

```{r}
df.min$library.prep <- gsub(".*_", "", df.min$cell.compartment)
ggplot(df.min, aes(x = library.prep, y = min.error.neuron)) + 
  geom_jitter(alpha = 0.5) + geom_boxplot(alpha = 0, color = "cyan")
```

# Plots by `cell.compartment`

```{r}
df.min$cell.compartment <- gsub("_.*", "", df.min$cell.compartment)
ggplot(df.min, aes(x = cell.compartment, y = min.error.neuron)) + 
  geom_jitter(alpha = 0.5) + geom_boxplot(alpha = 0, color = "cyan")
```

# Plots by `anatomic.region`

```{r}
ggplot(df.min, aes(x = anatomic.region, y = min.error.neuron)) + 
  geom_jitter(alpha = 0.5) + geom_boxplot(alpha = 0, color = "cyan")
```

# Plots by `library.prep*cell.compartment`

```{r}
df.min$library.prep.x.cell.compartment <- paste0(df.min$library.prep, ";",df.min$cell.compartment)
ggplot(df.min, aes(x = library.prep.x.cell.compartment, y = min.error.neuron)) + 
  geom_jitter(alpha = 0.5) + geom_boxplot(alpha = 0, color = "cyan") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
