---
title: "Shuffles S pseudobulk term"
author: "Sean Maden"
date: "2023-09-03"
output: html_document
---


Shuffles the $S_{pseudobulk}$ term from 1 sample. Uses 1 sample with high and 1 sample with low neuron proportion.

This notebook shows a pseudobulk shuffle experiment in which $S_{pseudobulk}$ is shuffled.

# Load

```{r setup, include=FALSE}
setwd("..")
setwd("..")
env.name <- "00_figab_s-pseudobulk.RData"
env.path <- file.path("notebooks", "13_shuffle", env.name)
if(file.exists(env.path)){
  knitr::opts_chunk$set(echo = F, eval = F, include = F)
  load(file = env.path)
} else{
  knitr::opts_chunk$set(echo = T)
}

knitr::opts_chunk$set(echo = TRUE)
libv <- c("snow", "dplyr", "parallel", "doParallel", "lute", "dplyr", "scuttle")
sapply(libv, library, character.only = T)
# 
#----------
# load data
#----------
# load mae (SEE CODE 01 OUTPUTS)
mae.filename <- "mae_final.rda"
mae.path <- file.path("data", "outputs", "00_preprocess", mae.filename)
list.files()
mae <- get(load(mae.path))

# load rnascope cell sizes
folder.name <- "13_shuffle"
celltype.variable <- "k2"
sample.id.variable <- "Sample"
assay.name <- "logcounts"
sce <- mae[["sn1.rnaseq"]]
sample.id.variable.rn <- "sample.id"
celltype.variable <- "k2"
# df.rnascope.kdata
df.rn.path <- file.path("data", "outputs", "00_preprocess", "df-rnascope-info_cohort1.rda")
df.rn <- get(load(df.rn.path))
dfs.rn <- t(df.rn) %>% as.data.frame()
dfs.rn <- dfs.rn[dfs.rn$k.label==celltype.variable,]
dfs.rn <- data.frame(s.glial = dfs.rn[dfs.rn$cell_type=="glial",]$cell_size,
                     s.neuron = dfs.rn[dfs.rn$cell_type=="neuron",]$cell_size,
                     sample.id.column = dfs.rn[dfs.rn$cell_type=="neuron",]$sample_id)
colnames(dfs.rn)[3] <- sample.id.variable.rn
for(c in seq(2)){dfs.rn[,c] <- as.numeric(dfs.rn[,c])}
# 
source(file.path("scripts","02_pseudobulk","00_param.R"))
# 
```

```{r, include=FALSE}
sce.k2 <- sce
sample.id.variable <- "Sample"
assay.name <- "logcounts"
celltype.variable <- "k2"
algorithm.name <- "nnls"
return.dimensions <- "tall"
```

# High neuron proportion

The $S_{pseudobulk}$ sample has high neuron proportion.

```{r, include = FALSE}
sample.id.iter <- "Br3942_mid"
s.vector <- dfs.rn[dfs.rn$sample.id==sample.id.iter,]
s.vector <- c("glial" = as.numeric(s.vector[1]), "neuron" = as.numeric(s.vector[2]))
dfp.tall <- get_ypb_experiment_series(sce.k2, 
                                      sample.id.variable = sample.id.variable,
                                      celltype.variable = celltype.variable, 
                                      assay.name = assay.name,
                                      s.vector = s.vector,
                                      algorithm.name = algorithm.name, 
                                      return.dimensions = return.dimensions)
dfp.tall$s.sample.id <- sample.id.iter
dfp.tall$matched.id <- dfp.tall$s.sample.id==dfp.tall$sample.id
dfp.tall.high <- dfp.tall
```

```{r, include=TRUE}
sample.id.iter <- "Br3942_mid"
ggplot(dfp.tall.high, aes(x = neuron.true, y = neuron.pred, color = sample.id, size = matched.id)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0) + facet_wrap(~type) +
  ggtitle(paste0("S_pseudobulk id :", sample.id.iter))
```

Save formatted plot.

```{r, include = FALSE}
setwd(".."); setwd("..")
###
sample.id.iter <- "Br3942_mid"
new.plot.filename <- "fig3_shuffle_s-pseudobulk_high-proportion_cohort1.jpg"
new.plot.path <- file.path("figures", "03_shuffle", new.plot.filename)
jpeg(new.plot.path, width = 5, height = 3, units = "in", res = 400)
ggplot(dfp.tall.high, aes(x = neuron.true, y = neuron.pred, shape = matched.id)) + 
  geom_point(size = 5, alpha = 0.5) + geom_abline(slope = 1, intercept = 0) + facet_wrap(~type) + theme_bw() +
  ggtitle(paste0("S pseudobulk id: ", sample.id.iter)) + xlim(0.2, 1) + ylim(0.2, 1)
dev.off()
```

# Low neuron proportion

The $S_{pseudobulk}$ sample has low neuron proportion.

```{r, include = FALSE}
sample.id.iter <- "Br2743_ant"
s.vector <- dfs.rn[dfs.rn$sample.id==sample.id.iter,]
s.vector <- c("glial" = as.numeric(s.vector[1]), "neuron" = as.numeric(s.vector[2]))
dfp.tall <- get_ypb_experiment_series(sce.k2, 
                                      sample.id.variable = sample.id.variable,
                                      celltype.variable = celltype.variable, 
                                      assay.name = assay.name,
                                      s.vector = s.vector,
                                      algorithm.name = algorithm.name, 
                                      return.dimensions = return.dimensions)
dfp.tall$s.sample.id <- sample.id.iter
dfp.tall$matched.id <- dfp.tall$s.sample.id==dfp.tall$sample.id
dfp.tall.low <- dfp.tall
```

```{r, include=TRUE}
sample.id.iter <- "Br2743_ant"
ggplot(dfp.tall.low, aes(x = neuron.true, y = neuron.pred, color = sample.id, size = matched.id)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0) + facet_wrap(~type) +
  ggtitle(paste0("S_pseudobulk id: ", sample.id.iter))
```

Save formatted plot.

```{r, include = FALSE}
setwd(".."); setwd("..")
###
sample.id.iter <- "Br2743_ant"
new.plot.filename <- "fig3_shuffle_s-pseudobulk_low-proportion_cohort1.jpg"
new.plot.path <- file.path("figures", "03_shuffle", new.plot.filename)
jpeg(new.plot.path, width = 5, height = 3, units = "in", res = 400)
ggplot(dfp.tall.low, aes(x = neuron.true, y = neuron.pred, shape = matched.id)) + 
  geom_point(size = 5, alpha = 0.5) + geom_abline(slope = 1, intercept = 0) + facet_wrap(~type) + theme_bw() +
  ggtitle(paste0("S pseudobulk id: ", sample.id.iter)) + xlim(0.2, 1) + ylim(0.2, 1)
dev.off()
```

# Session info

```{r, include = FALSE}
sessionInfo()
```