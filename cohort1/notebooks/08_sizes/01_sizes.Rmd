---
title: "Cell type proportion summaries"
author: "Sean Maden"
date: "2023-09-21"
output:
  pdf_document: default
  html_document: default
---

Cell type proportions from snRNAseq and RNAscope.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("dplyr", "ggplot2", "GGally", "ggcorrplot")
sapply(libv, library, character.only = TRUE)
```

```{r}
setwd("..")
setwd("..")
load("./env/08_sizes/01_sizes_script.RData")
dfp.wide <- list.dfp$dfp.wide
dfp.tall <- list.dfp$dfp.tall
```

# Summaries

## Summary statistics

```{r}
summary(dfp.tall[]$neuron)
```

## Rank difference

```{r}

dfp.wide <- dfp.wide[order(dfp.wide$sn.neuron),]
dfp.wide$rank.snrnaseq <- seq(nrow(dfp.wide))

dfp.wide <- dfp.wide[order(dfp.wide$rn.neuron),]
dfp.wide$rank.rnascope <- seq(nrow(dfp.wide))

dfp.wide$rank.difference.snranseq.rnascope <- dfp.wide$rank.snrnaseq-dfp.wide$rank.rnascope
dfp.wide$abs.rank.difference.snranseq.rnascope <- abs(dfp.wide$rank.difference.snranseq.rnascope)

summary(dfp.wide$abs.rank.difference.snranseq.rnascope)

sd(dfp.wide$abs.rank.difference.snranseq.rnascope)

```

# Additional processing

Drop columns, get size ratios.

```{r}

columns.keep <- c(1:2, 5:6, 9:13)

dfp.wide <- dfp.wide[,columns.keep]

dfp.wide$sn.ratio.glial.neuron <- dfp.wide$sn.glial/dfp.wide$sn.neuron
dfp.wide$rn.ratio.glial.neuron <- dfp.wide$rn.glial/dfp.wide$rn.neuron

dfp.tall$ratio.glial.neuron <- dfp.tall$glial/dfp.tall$neuron

```

# Write table

Save supplemental table.

```{r}

dfp.wide$sn.ratio.glial.neuron <- dfp.wide$sn.glial/dfp.wide$sn.neuron
dfp.wide$rn.ratio.glial.neuron <- dfp.wide$rn.glial/dfp.wide$rn.neuron

setwd("..")
setwd("..")
write.csv(
  dfp.wide, file = "./outputs/08_sizes/tables_cell_sizes.csv", row.names = FALSE
  )

```

# Plots -- by subject

Cell sizes from snRNAseq

```{r}

filter.plot <- dfp.tall$size.type.label=="snrnaseq"
dfp <- dfp.tall[filter.plot,]

new.plot1 <- ggplot(dfp, aes(x = subject.id, y = neuron)) + 
  geom_jitter() + 
  geom_boxplot(alpha = 0, color = "cyan") + 
  facet_wrap(~size.type.label) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

new.plot2 <- ggplot(dfp, aes(x = subject.id, y = glial)) + 
  geom_jitter() + 
  geom_boxplot(alpha = 0, color = "cyan") + 
  facet_wrap(~size.type.label) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

new.plot1

new.plot2
```

snRNAseq glial by neuron scatterplot

```{r}

new.plot3 <- ggplot(dfp, aes(x = neuron, y = glial)) + 
  geom_point(size = 4, alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_abline(slope = 1, intercept = 0) + 
  ggtitle("snRNAseq")

new.plot3

# save
setwd("..")
setwd("..")
jpeg("./figures/08_sizes/figures_snrnaseq_size_scatterplot.jpg", 
     width = 3, height = 3, units = "in", res = 400)
new.plot3
dev.off()

```

Cell sizes from RNAscope

```{r}

filter.plot <- dfp.tall$size.type.label=="rnascope"
dfp <- dfp.tall[filter.plot,]

new.plot1 <- ggplot(dfp, aes(x = subject.id, y = neuron)) + 
  geom_point(size = 2, alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + 
  facet_wrap(~size.type.label) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

new.plot2 <- ggplot(dfp, aes(x = subject.id, y = glial)) + 
  geom_point(size = 2, alpha = 0.5) + 
  geom_boxplot(alpha = 0, color = "cyan") + 
  facet_wrap(~size.type.label) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

new.plot1

new.plot2
```

```{r}

new.plot3 <- ggplot(dfp, aes(x = neuron, y = glial)) + 
  geom_point(size = 4, alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("RNAscope")

new.plot3

# save
setwd("..")
setwd("..")
jpeg("./figures/08_sizes/figures_rnascope_size_scatterplot.jpg", 
     width = 3, height = 3, units = "in", res = 400)
new.plot3
dev.off()

```

Proportions scatter plot, snRNAseq and RNAscope

```{r}

dfp <- dfp.wide

new.plot1 <- ggplot(dfp, 
                    aes(x = sn.ratio.glial.neuron, y = rn.ratio.glial.neuron)) + 
  geom_point(size = 4, alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_abline(slope = 1, intercept = 0) +
  xlab("snRNAseq") +
  ylab("RNAscope")

new.plot1

# save
setwd("..")
setwd("..")
jpeg("./figures/08_sizes/figures_size_ratios_rnascope_snrnaseq_scatterplot.jpg", 
     width = 3, height = 3, units = "in", res = 400)
new.plot1
dev.off()

```

Proportions scatter plot, by region, snRNAseq and RNAscope

```{r}

dfp <- dfp.wide

new.plot1 <- ggplot(dfp, 
                    aes(x = sn.ratio.glial.neuron, y = rn.ratio.glial.neuron)) + 
  geom_point(size = 4, alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_abline(slope = 1, intercept = 0) +
  xlab("snRNAseq") +
  ylab("RNAscope") +
  facet_wrap(~br.region)

new.plot1

# save
setwd("..")
setwd("..")
jpeg("./figures/08_sizes/figures_size_ratios_rnascope_snrnaseq_scatterplot.jpg", 
     width = 4.5, height = 2.8, units = "in", res = 400)
new.plot1
dev.off()

```



# Cell ratios, by brain region

```{r}

dfp <- dfp.tall
dfp$ratio.glial.neuron <- dfp$glial/dfp$neuron

new.plot1 <- ggplot(dfp, 
                    aes(x = size.type.label, y = ratio.glial.neuron)) + 
  geom_jitter() + 
  geom_boxplot(alpha = 0, color = "cyan") +
  geom_hline(yintercept = 1)

new.plot1

```

```{r}

dfp <- dfp.wide

new.plot1 <- ggplot(dfp, 
                    aes(x = sn.ratio.glial.neuron, y = rn.ratio.glial.neuron,
                        color = br.region)) + 
  geom_point(size = 4, alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_abline(slope = 1, intercept = 0) +
  xlab("snRNAseq") + ylab("RNAscope") + ggtitle("Ratio (glial/neuron)")

new.plot1

```

```{r}

dfp <- dfp.wide

new.plot1 <- ggplot(dfp, 
                    aes(x = sn.ratio.glial.neuron, y = rn.ratio.glial.neuron,
                        color = subject.id)) + 
  geom_point(size = 4, alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_abline(slope = 1, intercept = 0) +
  xlab("snRNAseq") + ylab("RNAscope") + ggtitle("Ratio (glial/neuron)")

new.plot1

```

```{r}

dfp <- dfp.wide

new.plot1 <- ggplot(dfp, 
                    aes(x = sn.ratio.glial.neuron, y = rn.ratio.glial.neuron,
                        color = br.region)) + 
  geom_point(size = 4, alpha = 0.5) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_abline(slope = 1, intercept = 0) +
  xlab("snRNAseq") + ylab("RNAscope") + ggtitle("Ratio (glial/neuron)") +
  facet_wrap(~subject.id)

new.plot1

# save
setwd("..")
setwd("..")
jpeg("./figures/08_sizes/figures_size_ratios_rnascope_snrnaseq_bysourceid_scatterplot.jpg", 
     width = 6, height = 5, units = "in", res = 400)
new.plot1
dev.off()

```

```{r}

dfp <- dfp.wide

new.plot1 <- ggplot(dfp, 
                    aes(x = sn.ratio.glial.neuron, y = rn.ratio.glial.neuron,
                        color = subject.id)) + 
  geom_point() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(method = "lm") +
  facet_wrap(~br.region)

new.plot1

```

# Pairs plots

```{r}

dfp <- dfp.wide

columns.plot <- c(1,2,3,4,8,9)

dfp <- dfp[,columns.plot]

new.plot1 <- ggpairs(dfp)

new.plot1

```

# Centered measures

```{r}
ratio.yintercept.ref = 1
```

```{r}
ggplot(dfp.tall, aes(x = br.region, y = ratio.glial.neuron)) + 
  geom_jitter() + geom_boxplot(alpha = 0, color = "cyan") + facet_wrap(~size.type.label) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept = ratio.yintercept.ref)
```

```{r}
new.plot1 <- ggplot(dfp.tall, aes(x = br.region, y = ratio.neuron.glial)) + 
  geom_jitter() + geom_boxplot(alpha = 0, color = "cyan") + facet_wrap(~size.type.label) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept = ratio.yintercept.ref)
new.plot1
```

# Session info

```{r}
sessionInfo()
```
