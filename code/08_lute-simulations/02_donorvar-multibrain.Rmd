---
title: "Donor variance adjustments"
author: "Sean Maden"
date: "2023-01-19"
output: html_document
---

Evaluate the multibrain DLPFC dataset, and repeat donor variance simulations with
appropriate coefficients from observations.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("lute", "ggpubr", "gridExtra", "DeconvoBuddies", "SingleCellExperiment")
sapply(libv, library, character.only = TRUE)

# manage paths
code.dname <- "08_lute-simulations"
proj.dname <- "deconvo_method-paper"
save.dpath <- file.path(proj.dname, "outputs", code.dname)
source.dpath <- file.path(proj.dname, "source")

# get data
sce.fname <- "sce-mrb_dlpfc.rda"
sce.fpath <- file.path(save.dpath, sce.fname)
sce <- get(load(sce.fpath))
mr.fname <- "markers-k2_db-mr2_sce-dlpfc-mrb.rda"
mr.fpath <- file.path(save.dpath, mr.fname)
mr <- get(load(mr.fpath))
```

# Get multibrain data

Loads the multibrain dataset from Tran et al 2021.

```{r}
sce <- get(load("SCE_DLPFC-n3_tran-etal.rda"))
```

```{r}
names(assays(sce))
```

```{r}
table(sce[["k2"]])
```

```{r}

```

# Get PCA summaries

This section shows the impact of varying the donor offset/variance on the results
of PCA performed on each type and donor. We will use a low offset of one and a 
high offset of 10, 10 donors, and two markers.

Make the initial, unadjusted donor signals `data.frame`'s for each offset as 
follows.

```{r}
df.unadj.1 <- rand_donor_marker_table(ndonor = 10, gindexv = c(1, 2),
                                      gamma.pos = 20, gamma.neg = 2)
df.unadj.10 <- rand_donor_marker_table(ndonor = 10, gindexv = c(1, 2),
                                       lambda.sdoff.pos = 5, 
                                       lambda.sdoff.neg = 5,
                                       gamma.pos = 10, 
                                       gamma.neg = 10)
```

Let's also get the adjusted signals, or the signals adjusted on donor-specific
variances and preserving type-specific variances using the `sva::ComBat` method.

```{r}
df.adj.1 <- donoradj_combat(df.unadj.1, return.type = "donordf")
df.adj.10 <- donoradj_combat(df.unadj.10, return.type = "donordf")
```

View and compare the heatmaps in each case.

```{r}
ldf <- list(df1 = df.unadj.1, 
            df2 = df.unadj.10,
            df3 = df.adj.1,
            df4 = df.adj.10)

lhm <- lapply(ldf, function(dfi){
  mi <- mexpr_from_donordf(dfi)
  seti <- SummarizedExperimentTypes(assays = list(counts = mi))
  hmi <- get_set_heatmap(seti, scale.hmdata = F)
  return(hmi)
})

plot.fname <- "chm-list_donor-var-low-high_lute-sim.jpg"
jpeg(plot.fname, width = 8, height = 8, units = "in", res = 400)
draw(lhm[[1]] + lhm[[2]] + lhm[[3]] + lhm[[4]])
dev.off()
```


Now perform PCA for each experiment group (offset;type)

```{r}
ggpca.unadj.1 <- pcaplots_donor(dt = df.unadj.1)$pca.bydonortype$scatterplot.pc1.pc2
ggpca.unadj.10 <- pcaplots_donor(dt = df.unadj.10)$pca.bydonortype$scatterplot.pc1.pc2
ggpca.adj.1 <- pcaplots_donor(dt = df.adj.1)$pca.bydonortype$scatterplot.pc1.pc2
ggpca.adj.10 <- pcaplots_donor(dt = df.adj.10)$pca.bydonortype$scatterplot.pc1.pc2
```

Make a composite plot

```{r}
pc1 <- ggpca.unadj.1 + scale_shape_discrete(name = "celltype",
                                            labels = c("Neuron", "Non-neuron"))
pca.leg <- get_legend(pc1)
pc1 <- ggpca.unadj.1 + theme(legend.position = "none") +
  ggtitle("Offset = 1; Unadjusted")
pc2 <- ggpca.unadj.10 + theme(legend.position = "none") + 
  ggtitle("Offset = 10; Unadjusted")
pc3 <- ggpca.adj.1 + theme(legend.position = "none") +
  ggtitle("Offset = 1; Bias-adjusted")
pc4 <- ggpca.adj.10 + theme(legend.position = "none") +
  ggtitle("Offset = 10; Bias-adjusted")

lm <- matrix(c(1, 3, 1, 3, 2, 4, 2, 4, 5, 5, 5, 5), nrow = 2)

plot.fname <- "ggpca-composite_donor-offset-1-10_lutesim.jpg"
jpeg(plot.fname, width = 8, height = 5, units = "in", res = 400)
grid.arrange(pc1, pc2, pc3, pc4, pca.leg, layout_matrix = lm)
dev.off()

```
# Impact of offset on bias~proportions

Evaluate the impact of the offset on the function of bias~proportions. 

First, we define a vector of true proportions for type 1 which is centered on
0.75, with a minimum of 0.6 and a maximum of 0.9, with steps of 0.001 in-between.

```{r}
p1v <- seq(0.6, 0.9, 5e-3)
dfres <- do.call(rbind, lapply(p1v, function(p1i){
  Pi <- c(p1i, 1-p1i)
  df1 <- donor_marker_biasexpt(P = Pi,
                               donor.adj.method = "combat",
                               ndonor = 10, 
                               gindexv = c(1, 2),
                               gamma.pos = 20, 
                               gamma.neg = 2,
                               plot.biasadj = F,
                               plot.pca = F)$dfres
  df2 <- donor_marker_biasexpt(P = Pi,
                               donor.adj.method = "combat",
                               ndonor = 10, gindexv = c(1, 2),
                               lambda.sdoff.pos = 5,
                               lambda.sdoff.neg = 5,
                               gamma.pos = 10,
                               gamma.neg = 10,
                               plot.biasadj = F,
                               plot.pca = F)$dfres
  df1$expt <- "low.var"; df2$expt <- "high.var"
  rbind(df1, df2)
}))

```

Let's generate a series of faceted bias scatterplots for each offset level.

```{r}
dfp <- dfres
dfp$prop.type <- ifelse(dfp$prop.type=="padj", "Bias-adjusted", "Unadjusted")
dfp$offset <- paste0("expt=",dfp$expt)
dfp$celltype <- ifelse(dfp$type.index==1, "Neuron", "Non-neuron")
ggpt <- ggplot(dfp, aes(x = prop.true, y = prop.pred, 
                color = celltype, shape = celltype)) +
  theme_bw() + geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "black")
ggpt + facet_wrap(~prop.type+offset)

plot.fname <- "ggpt-bias_donorbias-1-10_lutesim.jpg"
jpeg(plot.fname, width = 6, height = 4, units = "in", res = 400)
ggpt + facet_wrap(~prop.type+offset); dev.off()
```

Now let's plot the bias directly for adjusted and unadjusted proportions.

```{r}
# match results for each expt group/adj type
df.unadj <- dfres[dfres$prop.type == "punadj",]
df.adj <- dfres[dfres$prop.type == "padj",]
df.unadj <- df.unadj[order(df.unadj$prop.true, df.unadj$expt),]
df.adj <- df.adj[order(df.adj$prop.true, df.unadj$expt),]
identical(df.unadj$prop.true, df.adj$prop.true)
# get plot data
dfp <- data.frame(unadj = df.unadj$bias, adj = df.adj$bias,
                  offset = df.unadj$expt, type = df.unadj$type.index)
dfp$offset = paste0("offset=",dfp$offset)
dfp$celltype <- ifelse(dfp$type==1, "Neuron", "Non-neuron")
# make new plot
ggpt <- ggplot(dfp, aes(x = unadj, y = adj, color = celltype,
                        shape = celltype)) + theme_bw() +
  geom_point(alpha = 0.5, size = 2) + 
  scale_color_manual(values = c("blue", "red")) +
  geom_abline(slope = 1, intercept = 0, color = "black") +
  geom_hline(yintercept = 0, color = "black") +
  geom_vline(xintercept = 0, color = "black") +
  xlab("Unadjusted") + ylab("Bias-adjusted")
ggpt + facet_wrap(~offset) + ggtitle("Bias by offset amount")

plot.fname <- "ggpt-biasamt_donorbias-1-10_lutesim.jpg"
jpeg(plot.fname, width = 4.5, height = 2.2, units = "in", res = 400)
ggpt + facet_wrap(~offset) + ggtitle("Deconvolution bias") + 
  ylab("Donor-adjusted") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
dev.off()
```