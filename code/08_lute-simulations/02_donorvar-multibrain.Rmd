---
title: "Donor variance adjustments"
author: "Sean Maden"
date: "2023-01-19"
output: html_document
---

Analyzes data from top markers in DLPFC multi-region brain dataset (Tran et al 2021).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("lute", "ggpubr", "gridExtra", "ggrepel",
          "SingleCellExperiment", "SummarizedExperiment",
          "glmGamPoi")
sapply(libv, library, character.only = TRUE)

# manage paths
# source and save paths
code.dname <- "08_lute-simulations"
proj.dname <- "deconvo_method-paper"
save.dpath <- file.path(proj.dname, "outputs", code.dname)
source.dpath <- file.path(proj.dname, "source")

# load scef
scef.fname <- "scef-mrb_gmr2-k2-t20_dlpfc.rda"
scef <- get(load(file.path(save.dpath, scef.fname)))
```

Format the assay matrices.

```{r}
for(ai in names(assays(scef))){
  assays(scef)[[ai]] <- as.matrix(assays(scef)[[ai]])
}
```

# Get donor-wise summary statistics by cell types.

```{r}
groupstatv <- c("count", "zerocount", "var")
dfs.short <- sce_groupstat(scef, group.variable = "donor", type.variable = "k2",
                     groupstat = groupstatv, summarytype = "colData",
                     return.tall = FALSE, assayname = "logcounts")
dfs.tall <- sce_groupstat(scef, group.variable = "donor", type.variable = "k2",
                     groupstat = groupstatv, summarytype = "colData",
                     return.tall = TRUE, assayname = "logcounts")
```

# Plot donor variances by cell types

Plot variances by type

```{r}
# barplot
ggbp <- ggplot(dfs.tall, aes(x = group, y = var, fill = group)) +
  geom_bar(stat = "identity") + theme_bw()
ggbp + facet_wrap(~type, ncol = 1)
```

```{r}
# scatterplot
# prep dfp
dfp <- as.data.frame(t(dfs.short))
for(i in seq(2)){dfp[,i] <- as.numeric(dfp[,i])}
dfp <- dfp[grepl(".*var$", rownames(dfp)),]
colnames(dfp) <- dfs.short$type
dfp$group <- gsub(";.*", "", rownames(dfp))
# make plot object
ggpt <- ggplot(dfp, aes(x = neuron, y = other, color = group)) +
  geom_point(alpha = 0.5, size = 3) +  theme_bw() +
  geom_abline(slope = 1, intercept = 0, color = "black") +
  xlim(0, 0.2) + ylim(0, 0.2) +
  geom_label_repel(aes(label = group), box.padding   = 0.35, 
                  point.padding = 0.5, segment.color = 'black') +
  theme(legend.position = "none") +
  ggtitle("Variance by donor")
ggpt
```
# Donor variances by marker

Get variance summaries by donor, for each marker and type.

## Donor variance summaries by type, across genes

```{r}
groupstatv <- c("count", "zerocount", "var", "mean")
dfs.short <- sce_groupstat(scef, group.variable = "donor", type.variable = "k2",
                     groupstat = groupstatv, summarytype = "rowData",
                     return.tall = FALSE, assayname = "logcounts")
dfs.tall <- sce_groupstat(scef, group.variable = "donor", type.variable = "k2",
                     groupstat = groupstatv, summarytype = "rowData",
                     return.tall = TRUE, assayname = "logcounts")
```

## Plot donor variances across genes

Make a violin plot, jittered scatter plot, and boxplot

```{r}
dfp <- dfs.tall

# get plot objects
# violin plots
ggvp <- ggplot(dfp, aes(x = group, y = var, color = group)) +
  geom_violin(draw_quantiles = 0.5) + theme_bw() +
  theme(legend.position = "none")
# jitter plots
ggbox <- ggplot(dfp, aes(x = group, y = var, color = group)) +
  geom_boxplot() + theme_bw() +
  theme(legend.position = "none")
# boxplots
dfp.hline <- do.call(rbind, lapply(unique(dfp$group), function(gi){
  data.frame(group = gi, hline = median(dfp[dfp$group==gi,]$var))
}))
ggjp <- ggplot(dfp, aes(x = group, y = var, color = group)) +
  geom_jitter(alpha = 0.5, position = position_jitter(width = 0.15)) + 
  theme_bw() +
  theme(legend.position = "none") +
  geom_point(data = dfp.hline, aes(x = group, y = hline), 
             shape=95, size=25, color = "black", alpha = 0.5)

ggvp
ggbox
ggjp
```

Make scatter plot of variances by types.

```{r}
# scatterplot
# prep dfp
dfp <- data.frame(other = dfs.tall[dfs.tall$type=="other",]$var,
                  neuron = dfs.tall[dfs.tall$type=="neuron",]$var,
                  group = dfs.tall[dfs.tall$type=="other",]$group)

ggpt <- ggplot(dfp, aes(x = neuron, y = other, color = group)) +
  geom_point(alpha = 0.5) + theme_bw() +
  geom_abline(slope = 1, intercept = 0, color = "black")

ggpt 
ggpt + facet_wrap(~group, nrow = 1)
```

Scatter plot of dispersion (mean vs. variance)

```{r}
dfp <- dfs.tall

ggpt <- ggplot(dfp, aes(x = mean, y = var)) + theme_bw() +
  geom_abline(slope = 1, intercept = 0, color = "black")

ggpt + geom_point(alpha = 0.5)

ggpt + geom_point(data = dfp, alpha = 0.5, aes(color = group))

ggpt.sm <- ggpt + geom_smooth(aes(color = group))
ggpt.sm

ggpt.sm + facet_wrap(~group) + theme(legend.position = "none")

ggpt.sm + facet_wrap(~type + group) + theme(legend.position = "none")

ggpt.fw <- ggpt + geom_point(data = dfp, alpha = 0.5, aes(color = group)) + 
  facet_wrap(~type + group, nrow = 2) + theme(legend.position = "none")
ggpt.fw

ggpt.fw + geom_smooth(color = "purple")
  
```

# Use `gmlGamPoi` to extract distribution information

## Fit NB on cells

```{r}
fit <- glm_gp(assays(scef)$logcounts, on_disk = FALSE)
summary(fit)
```

## Fit NB on donors

```{r}
groupstatv = c("mean")
scef[["donor"]] <- as.character(scef[["donor"]])
scef[["k2"]] <- as.character(scef[["k2"]])
dfs <- sce_groupstat(scef, group.variable = "donor", type.variable = "k2",
                     groupstat = groupstatv, summarytype = "rowData",
                     return.tall = FALSE, assayname = "logcounts")
```
