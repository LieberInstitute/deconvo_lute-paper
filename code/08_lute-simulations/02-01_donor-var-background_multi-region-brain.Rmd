---
title: "multiregion brain, donor var background"
author: "Sean Maden"
date: "2023-01-30"
output:
  pdf_document: default
  html_document: default
---

Shows the background dispersions for all available genes from the multi-region
brain DLPFC snRNAseq `SingleCellExperiment` data (Tran et al 2021). Determines 
the empirical means and variances by gene after down-sampling either expression
counts or logcounts.

```{r}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("SingleCellExperiment", "SummarizedExperiment", "lute", "ggplot2")
sapply(libv, library, character.only = TRUE)
```

# Setup

## Load data

```{r}
code.dname <- "08_lute-simulations"
proj.dname <- "deconvo_method-paper"
save.dpath <- file.path(proj.dname, "outputs", code.dname)
sce.fname <- "sce-mrb_dlpfc.rda"
sce.fpath <- file.path(save.dpath, sce.fname)
sce <- get(load(sce.fpath))
```

## Compare down-sampling functions

```{r}
Down_Sample_Matrix<-function(expr_mat,min_lib_size=NULL){
  min_sz<-min(colSums(expr_mat))
  if(is.null(min_lib_size)){
    min_lib_size<-min_sz
  } else {
    stopifnot(min_lib_size<=min_sz)
  }
  down_sample<-function(x){
    prob <- min_lib_size/sum(x)
    unlist(lapply(x,function(y){rbinom(1, y, prob)}))
  }
  apply(expr_mat, 2, down_sample)
}
mect.ds1 <- as.matrix(Down_Sample_Matrix(mect[,seq(10)]))
mect.ds2 <- as.matrix(downsampleMatrix(mect, min_lib_size/sumv, bycol = T))
```

```{r}
dfp <- data.frame(ds1 = as.numeric(mect.ds1[,seq(10)]), 
                  ds2 = as.numeric(mect.ds2[,seq(10)]),
                  cellid = rep(colnames(mect.ds1)[seq(10)], 
                               each = nrow(mect.ds1)))
ggplot(dfp, aes(x = ds1, y = ds2)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, col = "red") + theme_bw() +
  xlab("Down_Sample_Matrix()") + ylab("scuttle::downsampleMatrix()") +
  ggtitle("Compare d.s. counts")
```

```{r}
ggplot(dfp, aes(x = ds1, y = ds2)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, col = "red") + theme_bw() +
  xlab("Down_Sample_Matrix()") + ylab("scuttle::downsampleMatrix()") +
  ggtitle("Compare d.s. counts") + facet_wrap(~cellid) + geom_smooth()
```

## Get down-sampled expression

Down-sample the counts matrix.

```{r}
mect <- assays(sce)[["counts"]]
sumv <- colSums(mect)
mect.ds <- downsampleMatrix(mect, min_lib_size/sumv, bycol = T)
mect.ds <- as.matrix(mect.ds)
```

Down-sample the logcounts matrix.

```{r}
melc <- assays(sce)[["logcounts"]]
sumv <- colSums(melc)
melc.ds <- downsampleMatrix(melc, min_lib_size/sumv, bycol = T)
melc.ds <- as.matrix(melc.ds)
```

## Get broad cell types

```{r}
ctvarname <- "cellType"
sce[["cellType"]] <- as.character(sce[["cellType"]])
sce[["ctbroad"]] <- ifelse(grepl("Excit", sce[[ctvarname]]), "Excit",
                           ifelse(grepl("Inhib", sce[[ctvarname]]), "Inhib",
                                  sce[[ctvarname]]))
```

```{r}
knitr::kable(as.data.frame(table(sce[["ctbroad"]])))
```

# Dispersion of counts

Plot mean vs. variance for counts expression.

```{r}
assayname <- "d.s. counts"
title.str.all <- paste0("All genes, ", assayname)
title.str.trim <- paste0("Trimmed (<=Q90) genes, ", assayname)
```

## Global mean vs. var

Plot global expression means and variances.

```{r}
# get main df
df <- data.frame(var = rowVars(mect.ds), mean = rowMeans(mect.ds))
# get trimmed df
filt <- df$mean <= quantile(df$mean, seq(0,1,0.1))[10]
filt <- filt & df$var <= quantile(df$var, seq(0,1,0.1))[10]
df.trim <- df[filt,]
```

Plot points and smooths of all genes.

```{r}
ggplot(df, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "blue") + theme_bw() + 
  geom_smooth() + ggtitle(title.str.all)
```

## Global mean vs. var -- trimmed

Plot the trimmed (<= 90th quantile) global means and variances.

Plot points and smooths of all genes.

```{r}
ggplot(df.trim, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + ggtitle(title.str.trim)
```

## Dispersion by cell type

Show means and variances by broad cell type.

```{r}
# get main df
ctv <- unique(sce[["ctbroad"]])
df <- do.call(rbind, lapply(ctv, function(ci){
  me <- counts(sce[,sce[["ctbroad"]]==ci])
  df <- data.frame(var = rowVars(me), mean = rowMeans(me))
  df$ct <- ci; df
}))
# get trimmed df
filt <- df$mean <= quantile(df$mean, seq(0,1,0.1))[10]
filt <- filt & df$var <= quantile(df$var, seq(0,1,0.1))[10]
df.trim <- df[filt,]
```

```{r}
ggplot(df, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str.all)
```

```{r}
ggplot(df, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str.all) +
  scale_x_log10() + scale_y_log10()
```

```{r}
ggplot(df, aes(x = mean, y = var, color = ct)) + geom_smooth() +
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() +
  ggtitle(title.str.all)
```

## Dispersion by cell type, trimmed

Show trimmed (<= 90th quantile) means and variances by broad cell type.

```{r}
ggplot(df.trim, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str.trim)
```

```{r}
ggplot(df.trim, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str.trim) +
  scale_x_log10() + scale_y_log10()
```

```{r}
ctfilt <- c("Tcell", "Mural", "Macrophage")
ggplot(df.trim[!df.trim$ct %in% ctfilt,], aes(x = mean, y = var, color = ct)) + 
  geom_smooth() + geom_abline(slope = 1, intercept = 0, color = "red") + 
  theme_bw() + ggtitle(title.str.trim)
```

## Dispersion by cell type, donor

Plot mean and variance summaries by donor.

```{r}
# get main df
ctv <- unique(sce[["ctbroad"]])
dv <- unique(sce[["donor"]])
df <- do.call(rbind, lapply(ctv, function(ci){
  do.call(rbind, lapply(dv, function(di){
    filt <- sce[["ctbroad"]]==ci & sce[["donor"]]==di; me <- counts(sce[,filt])
    df <- data.frame(var = rowVars(me, na.rm = T), mean = rowMeans(me, na.rm = T))
    df$ct <- ci; df$donor <- di; df
  }))
}))
# get trimmed df
filt <- df$mean <= quantile(df$mean, seq(0,1,0.1))[10]
filt <- filt & df$var <= quantile(df$var, seq(0,1,0.1), na.rm = T)[10]
df.trim <- df[filt,]
```

```{r}
ggplot(df, aes(x = mean, y = var, color = donor)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str.all)
```

```{r}
ggplot(df, aes(x = mean, y = var, color = ct)) + geom_smooth() +
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  facet_wrap(~donor) + ggtitle(title.str.all)
```

## Dispersion by cell type, donor -- trimmed

Plot trimmed (<= 90th quantile filtered) means and variances by donor.

```{r}
ggplot(df.trim, aes(x = mean, y = var, color = donor)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str)
```

```{r}
ggplot(df, aes(x = mean, y = var, color = ct)) + geom_smooth() +
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  facet_wrap(~donor) + ggtitle(title.str)
```

# Dispersion of logcounts

Show mean and variance summaries for logcounts expression.

```{r}
assayname <- "logcounts"
title.str.all <- paste0("All genes, d.s. ", assayname)
title.str.trim <- paste0("Trimmed (<=Q90) genes, d.s. ", assayname)
```

## Global mean vs. var

Plot mean and variance summaries across all cells.

```{r}
# get main df
me <- melc.ds
df <- data.frame(var = rowVars(me), mean = rowMeans(me))
# get trimmed df
filt <- df$mean <= quantile(df$mean, seq(0,1,0.1))[10]
filt <- filt & df$var <= quantile(df$var, seq(0,1,0.1), na.rm = T)[10]
df.trim <- df[filt,]
```

Plot empirical means and variances for genes across all cells, scatter plot, smooth, and reference line.

```{r}
ggplot(df, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + ggtitle(title.str.all)
```

## Global mean vs. var -- trimmed

Plot the trimmed mean and variance summaries across all cells.

```{r}
ggplot(df.trim, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + ggtitle(title.str.trim)
```

## Dispersion by cell type

Plot the mean and variance summaries by cell type.

```{r}
# get main df
ctv <- unique(sce[["ctbroad"]])
df <- do.call(rbind, lapply(ctv, function(ci){
  filt <- sce[["ctbroad"]]==ci; me <- melc.ds[, filt]
  df <- data.frame(var = rowVars(me), mean = rowMeans(me));df$ct <- ci; df
}))
# get trimmed df
title.str <- paste0("Trimmed (<=Q90) genes, ", assayname)
filt <- df$mean <= quantile(df$mean, seq(0,1,0.1))[10]
filt <- filt & df$var <= quantile(df$var, seq(0,1,0.1), na.rm = T)[10]
df.trim <- df[filt,]
```

```{r}
ggplot(df, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str.all)
```

```{r}
ggplot(df, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str.all) +
  scale_x_log10() + scale_y_log10()
```

```{r}
ggplot(df, aes(x = mean, y = var, color = ct)) + geom_smooth() +
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() +
  ggtitle(title.str.all)
```

## Dispersion by cell type -- trimmed

Plot the trimmed mean and variance summaries by cell type.

```{r}
ggplot(df.trim, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str.trim)
```

```{r}
ggplot(df.trim, aes(x = mean, y = var)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str.trim) +
  scale_x_log10() + scale_y_log10()
```

```{r}
ggplot(df.trim, aes(x = mean, y = var, color = ct)) + geom_smooth() +
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() +
  ggtitle(title.str.trim)
```

# Dispersion by cell type, donor

```{r}
title.str <- paste0("All genes, ", assayname)
ctv <- unique(sce[["ctbroad"]])
dv <- unique(sce[["donor"]])
df <- do.call(rbind, lapply(ctv, function(ci){
  do.call(rbind, lapply(dv, function(di){
    filt <- sce[["ctbroad"]]==ci & sce[["donor"]]==di; me <- logcounts(sce[,filt])
    df <- data.frame(var = rowVars(me, na.rm = T), mean = rowMeans(me, na.rm = T))
    df$ct <- ci; df$donor <- di; df
  }))
}))
```

```{r}
ggplot(df, aes(x = mean, y = var, color = donor)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str)
```

```{r}
ggplot(df, aes(x = mean, y = var, color = ct)) + geom_smooth() +
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  facet_wrap(~donor) + ggtitle(title.str)
```

# Dispersion by cell type, donor -- trimmed

```{r}
title.str <- paste0("Trimmed (<=Q90) genes, ", assayname)
filt <- df$mean <= quantile(df$mean, seq(0,1,0.1))[10]
filt <- filt & df$var <= quantile(df$var, seq(0,1,0.1), na.rm = T)[10]
df.trim <- df[filt,]
```

```{r}
ggplot(df, aes(x = mean, y = var, color = donor)) + geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  geom_smooth() + facet_wrap(~ct) + ggtitle(title.str)
```

```{r}
ggplot(df, aes(x = mean, y = var, color = ct)) + geom_smooth() +
  geom_abline(slope = 1, intercept = 0, color = "red") + theme_bw() + 
  facet_wrap(~donor) + ggtitle(title.str)
```
