---
title: "02-02_donor-var-bg-vs-marker_mrb-dlpfc"
author: "Sean Maden"
date: "2023-01-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("lute", "dplyr", "ggforce", 
          "SingleCellExperiment", "SummarizedExperiment")
sapply(libv, library, character.only = TRUE)
```

# Load data

```{r}
# get save dpath
code.dname <- "08_lute-simulations"
proj.dname <- "deconvo_method-paper"
save.dpath <- file.path(proj.dname, "outputs", code.dname)

# get marker data
dfm.fname <- "markers-k2_db-mr2_sce-dlpfc-mrb.rda"
dfm <- get(load(file.path(save.dpath, dfm.fname)))

# get sce
sce.fname <- "sce-mrb_dlpfc.rda"
sce.fpath <- file.path(save.dpath, sce.fname)
sce <- get(load(sce.fpath))
```

# Prep data

Get top 20 markers per type

```{r}
nmarker <- 20
typev <- unique(dfm$cellType.target)
dfmt <- do.call(rbind, lapply(typev, function(typei){
  dfm %>% filter(cellType.target == typei) %>% 
    arrange(rank_ratio) %>%
    top_n(n = nmarker)
}))
```

Get downampled logcounts.

```{r}
assayname.old <- "logcounts"
assayname.new <- paste0(assayname.old, "_ds")
mexpr <- as.matrix(assays(sce)[[assayname]])
assays(sce)[[assayname.new]] <- mexpr_downsample(mexpr)
```

Get the dispersion summary data.

```{r}
dfds.all <- get_dispersion_data(sce = sce,
                                assayname = assayname.new,
                                group.variable = "k2")
dfds.k2 <- get_dispersion_data(sce = sce[dfmt$gene,],
                               assayname = assayname.new,
                               group.variable = "k2")
```

Compare summary data for all genes/background versus markers.

```{r}
# prepare plot data dfp
dfp <- dfds.all
dfp$type <- "all"
dfp2 <- dfds.k2
dfp2$type <- "k2_marker"
dfp <- rbind(dfp, dfp2)

# boxplot of means
ggbox <- ggplot(dfp, aes(x = type, y = mean)) + theme_bw() + geom_boxplot()
ggbox + facet_wrap(~group)

# boxplot of variances
ggbox <- ggplot(dfp, aes(x = type, y = var)) + theme_bw() + geom_boxplot()
ggbox + facet_wrap(~group)
```

Compare dispersion for all genes versus marker genes, in all cells.

```{r}
# get expr data matrix
mexpr <- assays(sce)[[assayname.new]]
# get bg as random subset of samples
nsamples <- 100; set.seed(0)
mf1 <- mexpr[sample(seq(nrow(mexpr)), nsamples),]
# get marker gene expression
mf2 <- mexpr[dfmt$gene,]

# get gene fits
lf.all <- mexpr_nbcoef(mf1)
lf.k2 <- mexpr_nbcoef(mf2)

# get plot data
namev <- c("all", "k2_markers")
lf <- list(lf.all, lf.k2)
dfp <- do.call(rbind, lapply(seq(2), function(ii){
  fi <- lf[[ii]]$fit
  dfi <- data.frame(dispersion = as.numeric(fi$overdispersions), 
                    deviances = as.numeric(fi$deviances))
  dfi$type <- namev[ii]; dfi
}))

# make plots
# dispersions
ggplot(dfp, aes(x = type, y = dispersion)) + 
  geom_boxplot() + facet_zoom(ylim = c(0, 20))
# deviances
ggplot(dfp, aes(x = type, y = deviances)) + geom_boxplot()
```

Compare dispersions and deviances by cell type.

```{r}
ctv <- sce[["k2"]]
dfp <- do.call(rbind, lapply(unique(ctv), function(gi){
  filt <- ctv == gi
  # get gene fits
  lfi.all <- mexpr_nbcoef(mf1[,filt])
  lfi.k2 <- mexpr_nbcoef(mf2[,filt])
  # get plot data
  namev <- c("all", "k2_markers"); lfi <- list(lfi.all, lfi.k2)
  dfp <- do.call(rbind, lapply(seq(2), function(ii){
    fi <- lfi[[ii]]$fit
    dfi <- data.frame(dispersion = as.numeric(fi$overdispersions),
                      deviances = as.numeric(fi$deviances))
    dfi$type <- namev[ii]; dfi
  }))
  dfp$celltype <- gi; dfp
}))

# make plots
# dispersions
ggplot(dfp, aes(x = type, y = dispersion)) + 
  geom_boxplot() + ylim(0, 20) + facet_wrap(~celltype)
# deviances
ggplot(dfp, aes(x = type, y = deviances)) + geom_boxplot() +
  facet_wrap(~celltype)
```

Get dispersion plots.

```{r}
ld <- sce_dispersion(sce, group.data = "k2", assayname = assayname.new, 
                     highlight.markers = dfmt$gene, downsample = FALSE,
                     hl.color = "red", point.alpha = 0.01, 
                     hl.alpha = 1, ref.linecol = "black")
```

View dispersions by cell type.

```{r}
ld$ggplot.dispersion
```

Append marker status

```{r}
```

# Plot dispersion by cell type

## Counts

## Logcounts
