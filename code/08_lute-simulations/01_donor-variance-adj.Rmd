---
title: "Donor variance adjustments"
author: "Sean Maden"
date: "2023-01-19"
output: html_document
---

Show simulation results of donor variance adjustments across low and high donor 
variances.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("lute", "ggpubr", "gridExtra")
sapply(libv, library, character.only = TRUE)

save.dpath <- file.path("deconvo_method-paper", "outputs", 
                        "08_lute-simulations")
```

# Get PCA summaries

This section shows the impact of varying the donor offset/variance on the results
of PCA performed on each type and donor. We will use a low offset of one and a 
high offset of 10, 10 donors, and two markers.

Make the initial, unadjusted donor signals `data.frame`'s for each offset as 
follows.

```{r}
df.unadj.1 <- rand_donor_marker_table(ndonor = 10, gindexv = c(1, 2),
                                      sd.offset.pos = 1, sd.offset.neg = 1)
df.unadj.10 <- rand_donor_marker_table(ndonor = 10, gindexv = c(1, 2),
                                      sd.offset.pos = 10, sd.offset.neg = 10)
```

Let's also get the adjusted signals, or the signals adjusted on donor-specific
variances and preserving type-specific variances using the `sva::ComBat` method.

```{r}
df.adj.1 <- donoradj_combat(df.unadj.1, return.type = "donordf")
df.adj.10 <- donoradj_combat(df.unadj.10, return.type = "donordf")
```

Now perform PCA for each experiment group (offset;type)

```{r}
ggpca.unadj.1 <- pcaplots_donor(dt = df.unadj.1)$pca.bydonortype$scatterplot.pc1.pc2
ggpca.unadj.10 <- pcaplots_donor(dt = df.unadj.10)$pca.bydonortype$scatterplot.pc1.pc2
ggpca.adj.1 <- pcaplots_donor(dt = df.adj.1)$pca.bydonortype$scatterplot.pc1.pc2
ggpca.adj.10 <- pcaplots_donor(dt = df.adj.10)$pca.bydonortype$scatterplot.pc1.pc2
```

Make a composite plot

```{r}
pca.leg <- get_legend(ggpca.unadj.1)
pc1 <- ggpca.unadj.1 + theme(legend.position = "none") +
  ggtitle("Offset = 1; Unadjusted")
pc2 <- ggpca.unadj.10 + theme(legend.position = "none") + 
  ggtitle("Offset = 10; Unadjusted")
pc3 <- ggpca.adj.1 + theme(legend.position = "none") +
  ggtitle("Offset = 1; Bias-adjusted")
pc4 <- ggpca.adj.10 + theme(legend.position = "none") +
  ggtitle("Offset = 10; Bias-adjusted")

lm <- matrix(c(1, 3, 1, 3, 2, 4, 2, 4, 5, 5, 5, 5), nrow = 2)

plot.fname <- "ggpca-composite_donor-offset-1-10_lutesim.jpg"
jpeg(plot.fname, width = 8, height = 5, units = "in", res = 400)
grid.arrange(pc1, pc2, pc3, pc4, pca.leg, layout_matrix = lm)
dev.off()

```
# Impact of offset on bias~proportions

Evaluate the impact of the offset on the function of bias~proportions. 

First, we define a vector of true proportions for type 1 which is centered on
0.75, with a minimum of 0.6 and a maximum of 0.9, with steps of 0.001 in-between.

```{r}
p1v <- seq(0.6, 0.9, 1e-3)
```

Next, we define the donor offsets as either low (1) or high (10). In each case,
we need to repeat the values to equal the true proportions.

```{r}
offset.levels <- c(1, 10)
loff <- lapply(offset.levels, function(offi){rep(offi, length(p1v))})
```

Now conduct a donor bias experiment. In each experiment, do the following: 

  * (1) Make a single pseudobulked sample without any between-donor bias/variance

  * (2) Get randomized, raw/unadjusted donor signals, and use these to make new 
deconvolution predictions.

  * (3) Get adjusted signals from unadjusted signals produced in (2) and use these
to make new deconvolution predictions.

  * (4) Compare deconvolution predictions from (2) and (3).

```{r}
dfres <- do.call(rbind, lapply(loff, function(ii){
  do.call(rbind, lapply(seq(length(ii)), function(jj){
    donor_marker_biasexpt(offsetv = ii[jj], P = c(p1v[jj], 1-p1v[jj]),
                          donor.adj.method = "combat")$dfres
  }))
}))
```

Let's generate a series of faceted bias scatterplots for each offset level.

```{r}
dfp <- dfres
dfp$prop.type <- ifelse(dfp$prop.type=="padj", "Bias-adjusted", "Unadjusted")
dfp$offset <- paste0("offset=",dfp$offset)
dfp$celltype <- ifelse(dfp$type.index==1, "Neuron", "Non-neuron")
ggpt <- ggplot(dfp, aes(x = prop.true, y = prop.pred, 
                color = celltype, shape = celltype)) +
  theme_bw() + geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "black")
ggpt + facet_wrap(~prop.type+offset)

plot.fname <- "ggpt-bias_donorbias-1-10_lutesim.jpg"
jpeg(plot.fname, width = 6, height = 4, units = "in", res = 400)
ggpt + facet_wrap(~prop.type+offset); dev.off()
```

Now let's plot the bias directly for adjusted and unadjusted proportions.

```{r}
# match results for each expt group/adj type
df.unadj <- dfres[dfres$prop.type == "punadj",]
df.adj <- dfres[dfres$prop.type == "padj",]
df.unadj <- df.unadj[order(df.unadj$prop.true, df.unadj$offset),]
df.adj <- df.adj[order(df.adj$prop.true, df.unadj$offset),]
identical(df.unadj$prop.true, df.adj$prop.true)
# get plot data
dfp <- data.frame(unadj = df.unadj$bias, adj = df.adj$bias,
                  offset = df.unadj$offset, type = df.unadj$type.index)
dfp$offset = paste0("offset=",dfp$offset)
dfp$celltype <- ifelse(dfp$type==1, "Neuron", "Non-neuron")
# make new plot
ggpt <- ggplot(dfp, aes(x = unadj, y = adj, color = celltype)) + theme_bw() +
  geom_point(alpha = 0.5, size = 2) + 
  geom_abline(slope = 1, intercept = 0, color = "black") +
  geom_hline(yintercept = 0, color = "black") +
  geom_vline(xintercept = 0, color = "black") +
  xlab("Unadjusted") + ylab("Bias-adjusted")
ggpt + facet_wrap(~offset) + ggtitle("Bias by offset amount")

plot.fname <- "ggpt-biasamt_donorbias-1-10_lutesim.jpg"
jpeg(plot.fname, width = 6, height = 2.5, units = "in", res = 400)
ggpt + facet_wrap(~offset) + ggtitle("Bias by offset amount"); dev.off()
```