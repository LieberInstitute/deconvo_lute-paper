---
title: "Donor variance adjustments"
author: "Sean Maden"
date: "2023-01-19"
output: html_document
---

Show simulation results of donor variance adjustments across low and high donor 
variances.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("lute", "ggpubr", "gridExtra")
sapply(libv, library, character.only = TRUE)

save.dpath <- file.path("deconvo_method-paper", "outputs", 
                        "08_lute-simulations")
```

# Get PCA summaries

This section shows the impact of varying the donor offset/variance on the results
of PCA performed on each type and donor. We will use a low offset of one and a 
high offset of 10, 10 donors, and two markers.

Make the initial, unadjusted donor signals `data.frame`'s for each offset as 
follows.

```{r}
offsetv <- c(1, 10)
df.unadj <- do.call(rbind, lapply(offsetv, function(offi){
  dfi <- rand_donor_marker_table(ndonor = 10, gindexv = c(1, 2), 
                                 sd.offset.pos = offi, sd.offset.neg = offi)
  dfi$offset <- offi; return(dfi)
}))
```

Let's also get the adjusted signals, or the signals adjusted on donor-specific
variances and preserving type-specific variances using the `sva::ComBat` method.

```{r}
df.adj <- do.call(rbind, lapply(offsetv, function(offi){
  dfi <- donoradj_combat(df, return.type = "donordf")
  dfi$offset <- offi; return(dfi)
}))
```

Now combine adjusted and unadjusted data.

```{r}
# add df type
df.unadj$expt.type <- "unadj"
df.adj$expt.type <- "adj"
# order colnames
order.cnv <- order(match(colnames(df.adj), colnames(df.unadj)))
df.adj <- df.adj[,order.cnv]
# bind together
df <- rbind(df.unadj, df.adj)
```

Now perform PCA for each experiment group (offset;type)

```{r}
df$expt.group <- paste0(df$offset, ";", df$expt.type)
exptv <- unique(df$expt.group)
lpca <- lapply(exptv, function(ei){
  message(ei)
  dti <- df[df$expt.group==ei,]
  pcai <- pcaplots_donor(dt = dti)
  pcai$pca.bydonortype$scatterplot.pc1.pc2
})
```

## Compare PCA results

Compare PCA plots of adjusted and unadjusted data.

First, get PCA plots of the unadjusted data.

```{r}
lpca.unadj <- pcaplots_donor(dt = df)
lpca.unadj$pca.bydonortype$scatterplot.pc1.pc2
```

```{r}
df.adj <- donoradj_combat(df, return.type = "donordf", verbose = T)
# get pca for adj signals
lpca.adj <- pcaplots_donor(dt = df.adj)
lpca.adj$pca.bydonortype$scatterplot.pc1.pc2 + 
  ggtitle("Adj. method: combat")
```

Make a composite plot of the pca results

```{r}
pc1 <- lpca.unadj$pca.bydonortype$scatterplot.pc1.pc2
pc2 <- lpca.adj$pca.bydonortype$scatterplot.pc1.pc2 + 
  ggtitle("Adj. method: combat")
pc.leg <- get_legend(pc1)
pc1 <- pc1 + theme(legend.position = "none")
pc2 <- pc2 + theme(legend.position = "none")
lm <- matrix(c(1,1,1,2,2,2,3,3),nrow = 1)

#offsetval <- 5
#plot.fname <- paste0("ggpt.jpg")
#jpeg(file.path(save.dpath, plot.fname), width = 10, height = 4.5, 
#     units = "in", res = 400)
grid.arrange(pc1, pc2, pc.leg, layout_matrix = lm)
#dev.off()
```

# Impact of offset on bias~proportions

Evaluate the impact of the offset on the function of bias~proportions. 

First, define a vector of true proportions for type 1.

```{r}
p1v <- seq(0.6, 0.9, 1e-3)
```

Next, define a series of offsets. We'll look at offsets of 1, 10, and 50.

```{r}
offset.levels <- c(1, 10, 50)
loff <- lapply(offset.levels, function(offi){rep(offi, length(p1v))})
```

For each offset series, get the donor bias experiment results.

```{r}
dfres <- do.call(rbind, lapply(loff, function(ii){
  do.call(rbind, lapply(seq(length(ii)), function(jj){
    offi <- ii[jj]; p1i <- p1v[jj]
    lbi <- donor_marker_biasexpt(offsetv = offi, P = c(p1i, 1-p1i), 
                               donor.adj.method = "combat")
    lbi$dfres
  }))
}))
```

Let's generate a series of faceted bias scatterplots for each offset level.

```{r}
dfp <- dfres
dfp$prop.type <- ifelse(dfp$prop.type=="padj", "Bias-adjusted", "Unadjusted")
dfp$offset <- paste0("offset=",dfp$offset)
dfp$celltype <- ifelse(dfp$type.index==1, "Neuron", "Non-neuron")
ggpt <- ggplot(dfp, aes(x = prop.true, y = prop.pred, 
                color = celltype, shape = celltype)) +
  theme_bw() + geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "black")
ggpt + facet_wrap(~prop.type+offset)
```

Now let's plot the bias directly for adjusted and unadjusted proportions.

```{r}
# match results for each expt group/adj type
df.unadj <- dfres[dfres$prop.type == "punadj",]
df.adj <- dfres[dfres$prop.type == "padj",]
df.unadj <- df.unadj[order(df.unadj$prop.true, df.unadj$offset),]
df.adj <- df.adj[order(df.adj$prop.true, df.unadj$offset),]
identical(df.unadj$prop.true, df.adj$prop.true)
# get plot data
dfp <- data.frame(unadj = df.unadj$bias, adj = df.adj$bias,
                  offset = df.unadj$offset, type = df.unadj$type.index)
dfp$offset = paste0("offset=",dfp$offset)
dfp$celltype <- ifelse(dfp$type==1, "Neuron", "Non-neuron")
# make new plot
ggpt <- ggplot(dfp, aes(x = unadj, y = adj, color = celltype)) + theme_bw() +
  geom_point(alpha = 0.5, size = 2) + 
  geom_abline(slope = 1, intercept = 0, color = "black") +
  geom_hline(yintercept = 0, color = "black") +
  geom_vline(xintercept = 0, color = "black") +
  xlab("Unadjusted") + ylab("Bias-adjusted")
ggpt + facet_wrap(~offset) + ggtitle("Bias by offset amount")
```