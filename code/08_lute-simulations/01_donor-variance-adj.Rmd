---
title: "Donor variance adjustments"
author: "Sean Maden"
date: "2023-01-19"
output: html_document
---

Show simulation results of donor variance adjustments across low and high donor 
variances.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("lute", "ggpubr", "gridExtra")
sapply(libv, library, character.only = TRUE)

save.dpath <- file.path("deconvo_method-paper", "outputs", "08_lute-simulations")
```

# Simulate donor data

Get the data.frame of simulated donor signals.

```{r}
df <- donordf <- rand_donor_marker_table(ndonor = 10, gindexv = c(1, 2), 
                              sd.offset.pos = 5, sd.offset.neg = 5)
```

## Compare PCA results

Compare PCA plots of adjusted and unadjusted data.

First, get PCA plots of the unadjusted data.

```{r}
lpca.unadj <- pcaplots_donor(dt = df)
lpca.unadj$pca.bydonortype$scatterplot.pc1.pc2
```

```{r}
df.adj <- donoradj_combat(df, return.type = "donordf")
# get pca for adj signals
lpca.adj <- pcaplots_donor(dt = dfadj)
lpca.adj$pca.bydonortype$scatterplot.pc1.pc2 + ggtitle("Adj. method: combat")
```

Make a composite plot of the pca results

```{r}
pc1 <- lpca.unadj$pca.bydonortype$scatterplot.pc1.pc2
pc2 <- lpca.adj$pca.bydonortype$scatterplot.pc1.pc2 + 
  ggtitle("Adj. method: combat")
pc.leg <- get_legend(pc1)
pc1 <- pc1 + theme(legend.position = "none")
pc2 <- pc2 + theme(legend.position = "none")
lm <- matrix(c(1,1,1,2,2,2,3),nrow = 1)

offsetval <- 5
plot.fname <- paste0("ggpt-pca_adj-unadj_offset-", offsetval, 
                     "_lute-sim-donorbias.jpg")
jpeg(file.path(save.dpath, plot.fname), width = 8, height = 3, 
     units = "in", res = 400)
grid.arrange(pc1, pc2, pc.leg, layout_matrix = lm)
dev.off()
```

# Experiments

Using the `ComBat` method, vary donor variances using offsets of 5 and 100.

```{r}
p1v <- seq(0.1, 0.4, 5e-3)
#offsetv <- seq(1e-1,5,1e-2)
#offsetv <- sample(offsetv, length(p1v))
offsetv <- rep(1, length(p1v))
dfres <- do.call(rbind, lapply(seq(length(offsetv)), function(ii){
  offi <- offsetv[ii]; p1i <- p1v[ii]
  lbi <- donor_marker_biasexpt(offsetv = offi, P = c(p1i, 1-p1i), 
                               donor.adj.method = "combat")
  lbi$dfres
}))
```

Get bias scatterplot

```{r}
dfp <- dfres
dfp$offset <- as.numeric(dfp$offset)
dfp$celltype <- ifelse(dfp$type.index==1, "Neuron", "Non-neuron")
ggpt <- ggplot(dfp, aes(x = prop.true, y = prop.pred, 
                color = celltype, shape = celltype,
                size = offset)) +
  theme_bw() + geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "black")
ggpt + facet_wrap(~prop.type)
```

Try with increased offset at 10

```{r}
p1v <- seq(0.1, 0.4, 5e-3)
#offsetv <- seq(1e-1,5,1e-2)
#offsetv <- sample(offsetv, length(p1v))
offsetv <- rep(10, length(p1v))
dfres <- do.call(rbind, lapply(seq(length(offsetv)), function(ii){
  offi <- offsetv[ii]; p1i <- p1v[ii]
  lbi <- donor_marker_biasexpt(offsetv = offi, P = c(p1i, 1-p1i), 
                               donor.adj.method = "combat")
  lbi$dfres
}))
dfp <- dfres
dfp$offset <- as.numeric(dfp$offset)
dfp$celltype <- ifelse(dfp$type.index==1, "Neuron", "Non-neuron")
ggpt <- ggplot(dfp, aes(x = prop.true, y = prop.pred, 
                color = celltype, shape = celltype,
                size = offset)) +
  theme_bw() + geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "black")
ggpt + facet_wrap(~prop.type)
```

Try with increased offset at 50

```{r}
p1v <- seq(0.1, 0.4, 5e-3)
#offsetv <- seq(1e-1,5,1e-2)
#offsetv <- sample(offsetv, length(p1v))
offsetv <- rep(50, length(p1v))
dfres <- do.call(rbind, lapply(seq(length(offsetv)), function(ii){
  offi <- offsetv[ii]; p1i <- p1v[ii]
  lbi <- donor_marker_biasexpt(offsetv = offi, P = c(p1i, 1-p1i), 
                               donor.adj.method = "combat")
  lbi$dfres
}))
dfp <- dfres
dfp$offset <- as.numeric(dfp$offset)
dfp$celltype <- ifelse(dfp$type.index==1, "Neuron", "Non-neuron")
ggpt <- ggplot(dfp, aes(x = prop.true, y = prop.pred, 
                color = celltype, shape = celltype,
                size = offset)) +
  theme_bw() + geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "black")
ggpt + facet_wrap(~prop.type)
```
