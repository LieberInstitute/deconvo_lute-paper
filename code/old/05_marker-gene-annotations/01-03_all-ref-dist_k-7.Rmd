---
title: "get all reference distributions"
author: "Sean Maden"
date: '2022-10-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SummarizedExperiment)
library(here)
library(ggplot2)
library(gridExtra)

#------
# load 
#------
# set base paths
proj.dpath <- "deconvo_method-paper"
source.dpath <- file.path(proj.dpath,"source")

# load se object
sef.fname <- "sef-markers_ct-treg_stransform-expt_dlpfc-ro1.rda"
sef.fpath <- file.path(proj.dpath, "outputs/03_test-stransform", sef.fname)
sef <- get(load(sef.fpath))

# load signal matrices
lz.fname <- "lz_s-rescale-k4_dlpfc-ro1.rda"
lz.fpath <- file.path(proj.dpath, "outputs/03_test-stransform", lz.fname)
lz <- get(load(file.path(lz.fpath)))

#-------
# source
#-------
source.fnv <- c("z_methods")
for(fni in source.fnv){
  source(file.path(source.dpath, paste0(fni, ".R")))}

```

# Append glial cell label

```{r}
ctvarname <- "cellType_broad_hc"
glialv <- c("Astro", "MicroOligo", "Micro", "Oligo", "OPC")
colData(sef)$glial <- ifelse(sef[[ctvarname]] %in% glialv, TRUE, FALSE)
```

# Summarize by donor

## cell abundance by glial label

```{r}
dvarname <- "BrNum"
donorv <- unique(sef[[dvarname]])
dfp <- do.call(rbind, lapply(donorv, function(di){
  cdi <- colData(sef[,sef[[dvarname]]==di])
  is.glial <- cdi$glial == T
  data.frame(glial_nuclei_count = length(which(is.glial)),
             neuron_nuclei_count = length(which(cdi[[ctvarname]] 
                                              %in% c("Inhib", "Excit"))),
             total_nuclei = nrow(cdi), donor = di)
}))
```

## scatterplot of glial versus neurons, by donor

```{r}
ggplot(dfp, aes(x = glial_nuclei_count, 
                y = neuron_nuclei_count, 
                size = total_nuclei)) + 
  geom_abline(yintercept = 0, slope = 1, col = "red", lwd = 1.5) +
  geom_point() + ggtitle("Nuclei by donor")
```
## stacked barplots of cell abundances by donor

```{r}
dfp <- do.call(rbind, lapply(donorv, function(di){
  cdi <- colData(sef[,sef[[dvarname]]==di])
  dfpi <- as.data.frame(table(cdi[,ctvarname]))
  dfpi$donor <- di
  return(dfpi)
}))
# order by donor totals
totalv <- unlist(lapply(donorv, function(di){sum(dfp[dfp$donor==di,]$Freq)}))
dfp$donor <- factor(dfp$donor, levels = donorv[rev(order(totalv))])
```

Barplots, absolute counts

```{r}
ggplot(dfp, aes(x = donor, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity", color = "blue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  ylab("Nuclei count")
```

Barplots, percentages

```{r}
ggplot(dfp, aes(x = donor, y = Freq, fill = Var1)) + 
  geom_bar(stat = "identity", position = "fill", color = "blue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  ylab("Percent of nuclei (%)")
```



# Counts distributions

## Cell type abundances

```{r}
dfp.bp <- as.data.frame(table(sef[["celltype.treg"]]))
colnames(dfp.bp) <- c("cell_type", "number_of_cells")
#dfp.bp$cell_type <- as.factor(dfp.bp$cell_type, levels = c(""))
dfp.bp$glial <- ifelse(dfp.bp$cell_type %in% c("Astro", "MicroOligo", "Oligo", "OPC", "other"), TRUE, FALSE)
ggplot(dfp.bp, aes(x = cell_type, y = number_of_cells, fill = glial)) + geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 45))
```

```{r}
ctvarname <- "cellType_broad_hc"
dfp <- as.data.frame(table(sef[[ctvarname]]))
colnames(dfp) <- c("cell_type", "number_of_cells")
dfp$glial <- ifelse(dfp$cell_type %in% c("Astro", "MicroOligo", 
                                         "Micro", "Oligo", "OPC"), 
                    TRUE, FALSE)
#dfp.bp$cell_type <- as.factor(dfp.bp$cell_type, levels = c(""))
# order on medians
ctv <- unique(dfp$cell_type)
medianv <- unlist(lapply(ctv, function(ci){
  median(dfp[dfp$cell_type==ci,]$mean_counts)}))
dfp$cell_type <- factor(dfp$cell_type, 
                        levels = c("Excit", "Inhib", 
                                   "OPC", "Oligo", 
                                   "Astro", "EndoMural", 
                                   "Micro"))
```
```{r}
ggplot(dfp, aes(x = cell_type, y = number_of_cells, fill = glial)) + geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Mean marker counts by donor, cell type

Scatter plots of mean expression counts versus cell abundances, by donor and cell type.

```{r}
ctv <- unique(sef[["celltype.treg"]])
brv <- unique(sef[["BrNum"]])
dfp <- do.call(rbind, lapply(ctv, function(cti){
  which.var <- sef[["celltype.treg"]]==cti
  dfi <- do.call(rbind, lapply(brv, function(bri){
    which.var <- which.var & sef[["BrNum"]]==bri
    dfi <- data.frame(mean_counts = rowMeans(assays(sef[,which.var])$counts), 
                      gene_name = rownames(sef),
                      number_of_cells = length(which(which.var)))
    dfi$donor <- bri
    dfi
  }))
  dfi$cell_type <- cti
  return(dfi)
}))
```

```{r}
ggplot(dfp, aes(x = number_of_cells, y = mean_counts, color = cell_type, size = number_of_cells)) + 
  geom_point() + facet_wrap(~donor)
```

## Mean across donors/samples -- K = 7

```{r}
# get counts table by k cell type
ctvarname <- "cellType_broad_hc"
ctk <- do.call(cbind, lapply(unique(sef[[ctvarname]]), function(ki){
  rowMeans(assays(sef[,sef[[ctvarname]]==ki])$counts)
}))
colnames(ctk) <- unique(sef[[ctvarname]])
```

```{r}
# get dfp
dfp <- reshape::melt(ctk)
colnames(dfp) <- c("gene_name", "cell_type", "mean_counts")
dfp$glial <- ifelse(dfp$cell_type %in% c("Astro", "MicroOligo", "Micro", "Oligo", "OPC", "other"), TRUE, FALSE)
# order on medians
ctv <- unique(dfp$cell_type)
medianv <- unlist(lapply(ctv, function(ci){
  median(dfp[dfp$cell_type==ci,]$mean_counts)}))
dfp$cell_type <- factor(dfp$cell_type, 
                        levels = ctv[rev(order(medianv))])
```

```{r}
ggplot(dfp, aes(x = cell_type, y = mean_counts, fill = glial)) + 
  geom_violin(draw_quantiles = 0.5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Mean across donors/samples -- K = 4

Gets the distributions of counts summaries for marker genes.

```{r}
# get counts table by k cell type
ctk <- do.call(cbind, lapply(unique(sef[["celltype.treg"]]), function(ki){
  rowMeans(assays(sef[,sef[["celltype.treg"]]==ki])$counts)
}))
colnames(ctk) <- unique(sef[["celltype.treg"]])
# get dfp
dfp <- reshape::melt(ctk)
colnames(dfp) <- c("gene_name", "cell_type", "mean_counts")
```

Violin plots

```{r}
dfp$glial <- ifelse(dfp$cell_type %in% c("Astro", "MicroOligo", "Oligo", "OPC", "other"), TRUE, FALSE)
ggplot(dfp, aes(x = cell_type, y = mean_counts, fill = glial)) + 
  geom_violin(draw_quantiles = 0.5)
```

## Upset plot of markers

```{r}
library(UpSetR)
```

## Mean by donors/samples

```{r}
# get counts table by k cell type
ctk2 <- do.call(cbind, lapply(unique(sef[["celltype.treg"]]), function(ki){
  # filter on cell type
  which.k <- which(sef[["celltype.treg"]]==ki)
  sefk <- sef[,which.k]
  # get means by donor
  ctki <- do.call(cbind, lapply(unique(sefk[["BrNum"]]), function(bi){
    rowMeans(assays(sefk[,sefk[["BrNum"]]==bi])$counts)
  }))
  # get final means
  rowMeans(ctki)
}))
colnames(ctk2) <- unique(sef[["celltype.treg"]])
# get dfp
dfp2 <- reshape::melt(ctk2)
colnames(dfp2) <- c("gene_name", "cell_type", "mean_counts")
```

Violin plots

```{r}
ggplot(dfp2, aes(x = cell_type, y = mean_counts)) + 
  geom_violin(draw_quantiles = 0.5)
```

# Mean ratio by donor

```{r}
dfp3 <- reshape::melt(lz$z.summary.filt)
dfp3$cell_type <- gsub(".*;", "", dfp3$X2)

colnames(dfp3) <- c("gene_name", "donor;cell_type", "MR_kd", "cell_type")
ggplot(dfp3, aes(x = cell_type, y = MR_kd)) + 
  geom_violin(draw_quantiles = 0.5)
```

# Mean ratio plots -- K = 7

## Get datasets
```{r}
# get mean ratio by k cell type
ctvarname <- "cellType_broad_hc"
# append normcounts and logcounts to sef
ct <- assays(sef)$counts # counts
sf <- 2^rnorm(ncol(sef))
sf <- sf/mean(sf)
assays(sef)$normcounts <- t(t(ct)/sf)
dim(assays(sef)$normcounts)
assays(sef)$logcounts <- log2(assays(sef)$normcounts+1)
# get data tables
nc <- assays(sef)$normcounts
lc <- assays(sef)$logcounts
mrk <- do.call(cbind, lapply(ctv, function(ki){
  which.ki <- sef[[ctvarname]]==ki
  rowMeans(lc[,which.ki])/rowMeans(lc[,!which.ki])
}))
colnames(mrk) <- ctv
```

## Plot counts and logcounts

Helper function

```{r}
get_ggvp <- function(dfp, yaxis.name, xaxis.text){
  colnames(dfp) <- c("gene_name", "cell_type", "value")
  dfp$glial <- ifelse(dfp$cell_type %in% c("Astro", "MicroOligo", "Micro", 
                          "Oligo", "OPC", "other"), TRUE, FALSE)
  dfp$cell_type <- factor(dfp$cell_type, 
                          levels = c("Excit", "Inhib","OPC", 
                                     "Oligo", "Astro","EndoMural", "Micro"))
  # make plot
  ggvp <- ggplot(dfp, aes(x = cell_type, y = value, fill = glial)) +
    geom_violin(draw_quantiles = 0.5) + ylab(yaxis.name)
  if(xaxis.text){
    ggvp <- ggvp + theme(axis.text.x = element_text(angle = 45, hjust = 1),
                         legend.position = "none")
  } else{
     ggvp <- ggvp + theme(axis.text.x = element_blank(),
                          axis.title.x = element_blank(),
                          legend.position = "none")
  }
  return(ggvp)
}

get_lggvp <- function(df, make.dfp = TRUE, yaxis.name = "mean_counts", 
                      xaxis.text = TRUE){
  if(make.dfp){
    # get means by cell types
    ctvarname <- "cellType_broad_hc"
    ctv <- unique(sef[[ctvarname]])
    mc <- do.call(cbind, lapply(ctv, function(ki){
      rowMeans(df[,sef[[ctvarname]]==ki])
    })); colnames(mc) <- ctv
    dfp <- reshape::melt(mc)
  } else{dfp <- df}
  # get plot data
  ggvp <- get_ggvp(dfp, yaxis.name, xaxis.text) 
 return(
   list(dfp = dfp, ggvp = ggvp))
}
```

Make violin plots

```{r}
# get violin plots of means
lmc <- get_lggvp(ct, yaxis.name = "mean_counts", xaxis.text = F) # counts
lnc <- get_lggvp(nc, yaxis.name ="mean_normcounts", xaxis.text = F) # norm counts
llc <- get_lggvp(lc, yaxis.name = "mean_logcounts", xaxis.text = F) # log counts
lmr <- get_lggvp(reshape::melt(mrk), make.dfp = F, 
                 yaxis.name = "mean_ratio", xaxis.text = T)
```

Make composite plot

```{r}
# make composite plot
grid.arrange(lmc$ggvp, lnc$ggvp, llc$ggvp, lmr$ggvp, ncol = 1)
```

```{r}
grid.arrange(llc$ggvp, lmr$ggvp, ncol = 1)
```

## Get markers from sef

```{r}
get_z_experiment(sef, type.varname = "cellType_broad_hc")
```

## Heatmap

```{r}
library(ComplexHeatmap)
library(gridtext)
library(RColorBrewer)
```

```{r}
hmi <- mrk
col.pal <- ComplexHeatmap:::default_col(hmi, main_matrix = TRUE)
Heatmap(hmi)
```

```{r}
Heatmap(hmi, row_title = rowlab, column_title = collab, col = col.pal,
                  row_labels = "none", show_row_names = F, 
                  show_column_names = show.col.names, name = legend.name, 
                  show_row_dend = F, show_column_dend = F,
                  top_annotation = colanno)
```