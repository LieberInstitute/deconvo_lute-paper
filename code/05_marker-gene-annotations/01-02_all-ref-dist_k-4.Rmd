---
title: "01-02_all-ref-dist_k-4"
author: "Sean Maden"
date: '2022-10-24'
output: html_document
---

This vignette shows summary statistics for the restrictive example cell type labels
(e.g. K = 4) corresponding to the cell type labels from the TREG paper.

# Get cell data and labels

## Load data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SummarizedExperiment); library(here); library(ggplot2); library(gridExtra)
#------
# paths
#------
proj.dpath <- "deconvo_method-paper"
# filtered summarized experiment paths
sef.fname <- "sef-markers_ct-treg_stransform-expt_dlpfc-ro1.rda"
sef.fpath <- file.path(proj.dpath, "outputs", "03_test-stransform", sef.fname)
# lz signature matrix list
lz.fname <- "lz_s-rescale-k4_dlpfc-ro1.rda"
lz.fpath <- file.path(proj.dpath, "outputs", "03_test-stransform", lz.fname)
#-----
# load 
#-----
sef <- get(load(sef.fpath)) # load sef
lz <- get(load(lz.fpath)) # load z signature matrix list
#-----------
# set params
#-----------
knamevarname <- "celltype.treg"
gvarname <- "glial"
dvarname <- "BrNum"
glialv <- c("Astro", "MicroOligo", "Micro", "Oligo", "OPC")
#-----------------
# helper functions
#-----------------

get_ggvp <- function(dfp, yaxis.name, xaxis.text){
  colnames(dfp) <- c("gene_name", "cell_type", "value")
  dfp$glial <- ifelse(dfp$cell_type %in% c("Astro", "MicroOligo", "Micro", 
                          "Oligo", "OPC", "other"), TRUE, FALSE)
  dfp$cell_type <- factor(dfp$cell_type, 
                          levels = c("Excit", "Inhib","OPC", 
                                     "Oligo", "Astro","EndoMural", "Micro"))
  # make plot
  ggvp <- ggplot(dfp, aes(x = cell_type, y = value, fill = glial)) +
    geom_violin(draw_quantiles = 0.5) + ylab(yaxis.name)
  if(xaxis.text){
    ggvp <- ggvp + theme(axis.text.x = element_text(angle = 45, hjust = 1),
                         legend.position = "none")
  } else{
     ggvp <- ggvp + theme(axis.text.x = element_blank(),
                          axis.title.x = element_blank(),
                          legend.position = "none")
  }
  return(ggvp)
}

get_lggvp <- function(df, make.dfp = TRUE, yaxis.name = "mean_counts", 
                      xaxis.text = TRUE){
  if(make.dfp){
    # get means by cell types
    knamev <- unique(sef[[ctvarname]])
    mc <- do.call(cbind, lapply(knamev, function(ki){
      rowMeans(df[,sef[[knamevarname]]==ki])
    })); colnames(mc) <- knamev
    dfp <- reshape::melt(mc)
  } else{dfp <- df}
  # get plot data
  ggvp <- get_ggvp(dfp, yaxis.name, xaxis.text) 
 return(
   list(dfp = dfp, ggvp = ggvp))
}
```

## Append glial cell label

```{r}
sef[[gvarname]] <- ifelse(sef[[knamevarname]] %in% glialv, TRUE, FALSE)
```

# Cell abundance summaries

Summaries of the cell type labels contained in variables "`r knamevarname`" and 
"`r gvarname`."

## Table of type abundance

```{r}
knitr::kable(table(x = sef[[knamevarname]]), align = "c")
```

## Table of type, glial status

```{r}
knitr::kable(table(sef[[gvarname]]), align = "c")
```

```{r}
knitr::kable(table(sef[[knamevarname]], sef[[gvarname]]), align = "c")
```

## Type abundances barplot

```{r}
dfp <- as.data.frame(table(sef[[knamevarname]], sef[[gvarname]]))
colnames(dfp) <- c("cell_type", "glial", "num_nuclei")
dfp[,1] <- as.character(dfp[,1])
dfp[,2] <- as.character(dfp[,2])
```
```{r}
ggplot(dfp, aes(x = cell_type, y = num_nuclei, fill = glial)) + geom_bar(stat = "identity")
```

## Abundances by donor

Cell nuclei abundances/counts, grouped by donor variable "`r dvarname`", or the donor brain ID.

### Type abundances violin plots

```{r}
cd <- colData(sef)
dv <- unique(sef[[dvarname]])
dfp <- do.call(rbind, lapply(dv, function(di){
  cdi <- cd[cd[,dvarname]==di,]
  dfp <- as.data.frame(table(cdi[,knamevarname]))
  dfp$donor <- di
  dfp
}))
colnames(dfp) <- c("cell_type", "num_nuclei", "donor")
dfp$glial <- ifelse(dfp$cell_type %in% c("Oligo"), T, F)
```
```{r}
ggplot(dfp, aes(x = cell_type, y = num_nuclei, fill = glial)) + 
  geom_violin(draw_quantiles = 0.5)
```

### Type abundances stacked barplots

```{r}
# order donor var
sumv <- as.data.frame(table(sef[[dvarname]]))
dfp$donor <- factor(dfp$donor, levels = sumv[,1][rev(order(sumv[,2]))])
```

Counts

```{r}
ggplot(dfp, aes(x = donor, y = num_nuclei, fill = cell_type)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Percentages

```{r}
ggplot(dfp, aes(x = donor, y = num_nuclei, fill = cell_type)) + 
  geom_bar(position = "fill", stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Scatterplot of glial versus neurons, by donor

```{r}
dfp <- do.call(rbind, lapply(dv, function(donori){
  sefi <- sef[,sef[[dvarname]]==donori]
  data.frame(glial_nuclei = length(which(sefi[[gvarname]]==T)),
             neuronal_nuclei = length(which(
               sefi[[knamevarname]] %in% c("Inhib", "Excit"))),
             total_nuclei = ncol(sefi), donor = donori)
}))
```
```{r}
ggplot(dfp, aes(x = glial_nuclei, y = neuronal_nuclei)) + 
  geom_abline(intercept = 0, slope = 1, col = "red", lwd = 1.5) + ggtitle("Nuclei by donor") +
  geom_point(aes(size = total_nuclei), alpha = 0.5, color = "blue") + 
  geom_text(aes(label = donor), position = "dodge", color = "black")
```

### Scatterplot of neuronal types

Plotting Excit versus Inhib neuron abundances.

```{r}
sefi <- sef[,sef[[knamevarname]] %in% c("Inhib", "Excit")]
dfp <- as.data.frame(table(sefi[[knamevarname]], sefi[[dvarname]]))
dfp <- cbind(dfp[dfp[,1]=="Excit",], dfp[dfp[,1]=="Inhib",])[,c(2,3,6)]
colnames(dfp) <- c("donor", "Excit", "Inhib")
dfp$total_neurons <- dfp$Excit+dfp$Inhib
```
```{r}
ggplot(dfp, aes(x = Excit, y = Inhib)) + 
  geom_point(aes(size = total_neurons), alpha = 0.5, color = "blue") +
  geom_abline(intercept = 0, slope = 1, col = "red", lwd = 1.5) +
  geom_text(aes(label = donor), position = "dodge", color = "black")
```

### Scatterplot of Oligo versus non-Oligo cell types

```{r}
sefi <- sef[,!sef[[knamevarname]] %in% c("Inhib", "Excit")]
dfp <- as.data.frame(table(sefi[[knamevarname]], sefi[[dvarname]]))
dfp <- cbind(dfp[dfp[,1]=="Oligo",], dfp[dfp[,1]=="other",])[,c(2,3,6)]
colnames(dfp) <- c("donor", "Oligo", "Other")
dfp$total_glial <- dfp$Oligo+dfp$Other
```
```{r}
ggplot(dfp, aes(x = Oligo, y = Other)) + 
  geom_point(aes(size = total_glial), alpha = 0.5, color = "blue") +
  geom_abline(intercept = 0, slope = 1, col = "red", lwd = 1.5) +
  geom_text(aes(label = donor), position = "dodge", color = "black")
```

# Marker genes plots
## Upset plot of marker gene identities

# Expression at marker genes

## Composite violin plots

```{r}
# expression data
ct <- assays(sef)$counts
sf <- 2^rnorm(ncol(sef))
sf <- sf/mean(sf)
nc <- t(t(ct)/sf)
lc <- log2(nc+1)

# get mean ratio expression -- by donor,type
knamev <- unique(sef[[knamevarname]])
mr.kd <- do.call(cbind, lapply(knamev, function(ki){
  sefi <- sef[,sef[[knamevarname]]==ki] # type subset
  dfpi <- do.call(cbind, lapply(dv, function(donori){
    sefii <- sefi[,sefi[[dvarname]]==donori] # donor, type subset
    numerv <- rowMeans(assays(sefii[,sefii[[knamevarname]]==ki])$counts)
    ldenom <- lapply(knamev[!knamev==ki], function(kj){
      filtj <- sef[[knamevarname]]==kj & sef[[dvarname]]==donori
      rowMeans(assays(sef[,filtj])$counts)+1e-6
    })
    mrkdv <- rep(numerv, length(knamev)-1)/unlist(ldenom)
    rowMeans(matrix(mrkdv, nrow = length(numerv)))
  }))
  colnames(dfpi) <- paste0(dv, ";", ki)
  rownames(dfpi) <- rownames(sef)
  dfpi
}))
dfp.mrkd <- reshape::melt(mr.kd)
colnames(dfp.mrkd) <- c("gene_name", "donor;type", "mr_kd")
dfp.mrkd$cell_type <- gsub(".*;", "", dfp.mrkd$`donor;type`)
# get mean ratio expression -- by type
mr.k <- do.call(cbind, lapply(knamev, function(ki){
  which.ki <- grepl(ki, colnames(mr.kd)); rowMeans(mr.kd[,which.ki])
}))
colnames(mr.k) <- knamev
rownames(mr.k) <- rownames(mr.kd)
dfp.mrk <- reshape::melt(mr.k)
colnames(dfp.mrk) <- c("gene_name", "cell_type", "mr_k")
```

```{r}
# get violin plots of means
lmc <- get_lggvp(ct, yaxis.name = "mean_counts", xaxis.text = F) # counts
lnc <- get_lggvp(nc, yaxis.name ="mean_normcounts", xaxis.text = F) # norm counts
llc <- get_lggvp(lc, yaxis.name = "mean_logcounts", xaxis.text = F) # log counts
# mr by k,d
lmrkd <- get_lggvp(dfp.mrkd, make.dfp = F, yaxis.name = "mean_ratio",
                   xaxis.text = T)
# mr by k
lmrk <- get_lggvp(dfp.mrk, make.dfp = F, yaxis.name = "mean_ratio",
                  xaxis.text = T)
```

Make composite plots with `grid.arrange`.

```{r}
# make composite plot
grid.arrange(lmc$ggvp, lnc$ggvp, llc$ggvp, lmr$ggvp, ncol = 1)
```

```{r}
grid.arrange(llc$ggvp, lmr$ggvp, ncol = 1)
```

## Heatmap

```{r}
```