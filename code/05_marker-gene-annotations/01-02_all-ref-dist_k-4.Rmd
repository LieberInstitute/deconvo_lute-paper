---
title: "01-02_all-ref-dist_k-4"
author: "Sean Maden"
date: '2022-10-24'
number_sections: true
output: html_document
---

This vignette shows summary statistics for the restrictive example cell type labels
(e.g. K = 4) corresponding to the cell type labels from the TREG paper.

# Get cell data and labels

## Load data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SummarizedExperiment); library(here); library(ggplot2); library(gridExtra)
library(ComplexHeatmap)
#------
# paths
#------
proj.dpath <- "deconvo_method-paper"
# filtered summarized experiment paths
sef.fname <- "sef-markers_ct-treg_stransform-expt_dlpfc-ro1.rda"
sef.fpath <- file.path(proj.dpath, "outputs", "03_test-stransform", sef.fname)
# lz signature matrix list
lz.fname <- "lz_s-rescale-k4_dlpfc-ro1.rda"
lz.fpath <- file.path(proj.dpath, "outputs", "03_test-stransform", lz.fname)
#-----
# load 
#-----
sef <- get(load(sef.fpath)) # load sef
lz <- get(load(lz.fpath)) # load z signature matrix list
#-----------
# set params
#-----------
kvarname <- "celltype.treg"
gvarname <- "glial"
dvarname <- "BrNum"
glialv <- c("Astro", "MicroOligo", "Micro", "Oligo", "OPC")
#-----------------
# helper functions
#-----------------

get_ggvp <- function(dfp, kvarname, yaxis.name, xaxis.text){
  #
  # note: dfp input order c("gene_name", "cell_type", "value")
  #
  #
  colnames(dfp) <- c("gene_name", "cell_type", "value")
  dfp$glial <- ifelse(dfp$cell_type %in% c("Astro", "MicroOligo", "Micro", 
                          "Oligo", "OPC", "other"), TRUE, FALSE)
  dfp$cell_type <- factor(dfp$cell_type, 
                          levels = c("Excit", "Inhib","OPC", 
                                     "Oligo", "Astro","EndoMural", "Micro"))
  # make plot
  ggvp <- ggplot(dfp, aes(x = cell_type, y = value, fill = glial)) +
    geom_violin(draw_quantiles = 0.5) + ylab(yaxis.name)
  if(xaxis.text){
    ggvp <- ggvp + theme(axis.text.x = element_text(angle = 45, hjust = 1),
                         legend.position = "none")
  } else{
     ggvp <- ggvp + theme(axis.text.x = element_blank(),
                          axis.title.x = element_blank(),
                          legend.position = "none")
  }
  return(ggvp)
}

get_lggvp <- function(df, kvarname, make.dfp = TRUE, yaxis.name = "mean_counts", 
                      xaxis.text = TRUE){
  if(make.dfp){
    # get means by cell types
    knamev <- unique(sef[[kvarname]])
    mc <- do.call(cbind, lapply(knamev, function(ki){
      rowMeans(df[,sef[[kvarname]]==ki])
    })); colnames(mc) <- knamev
    dfp <- reshape::melt(mc)
  } else{dfp <- df}
  # get plot data
  ggvp <- get_ggvp(dfp = dfp, yaxis.name = yaxis.name, 
                   xaxis.text = xaxis.text, 
                   kvarname = kvarname) 
 return(
   list(dfp = dfp, ggvp = ggvp))
}
```

## Append glial cell label

```{r}
sef[[gvarname]] <- ifelse(sef[[kvarname]] %in% glialv, TRUE, FALSE)
```

# Cell abundance summaries

Summaries of the cell type labels contained in variables "`r kvarname`" and 
"`r gvarname`."

## Table of type abundance

```{r}
knitr::kable(table(x = sef[[kvarname]]), align = "c")
```

## Table of type, glial status

```{r}
knitr::kable(table(sef[[gvarname]]), align = "c")
```

```{r}
knitr::kable(table(sef[[kvarname]], sef[[gvarname]]), align = "c")
```

## Type abundances barplot

```{r}
dfp <- as.data.frame(table(sef[[kvarname]], sef[[gvarname]]))
colnames(dfp) <- c("cell_type", "glial", "num_nuclei")
dfp[,1] <- as.character(dfp[,1])
dfp[,2] <- as.character(dfp[,2])
```
```{r}
ggplot(dfp, aes(x = cell_type, y = num_nuclei, fill = glial)) + geom_bar(stat = "identity")
```

## Abundances by donor

Cell nuclei abundances/counts, grouped by donor variable "`r dvarname`", or the donor brain ID.

### Type abundances violin plots

```{r}
cd <- colData(sef)
dv <- unique(sef[[dvarname]])
dfp <- do.call(rbind, lapply(dv, function(di){
  cdi <- cd[cd[,dvarname]==di,]
  dfp <- as.data.frame(table(cdi[,kvarname]))
  dfp$donor <- di
  dfp
}))
colnames(dfp) <- c("cell_type", "num_nuclei", "donor")
dfp$glial <- ifelse(dfp$cell_type %in% c("Oligo"), T, F)
```
```{r}
ggplot(dfp, aes(x = cell_type, y = num_nuclei, fill = glial)) + 
  geom_violin(draw_quantiles = 0.5)
```

### Type abundances stacked barplots

```{r}
# order donor var
sumv <- as.data.frame(table(sef[[dvarname]]))
dfp$donor <- factor(dfp$donor, levels = sumv[,1][rev(order(sumv[,2]))])
```

Counts

```{r}
ggplot(dfp, aes(x = donor, y = num_nuclei, fill = cell_type)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Percentages

```{r}
ggplot(dfp, aes(x = donor, y = num_nuclei, fill = cell_type)) + 
  geom_bar(position = "fill", stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Scatterplot of glial versus neurons, by donor

```{r}
dfp <- do.call(rbind, lapply(dv, function(donori){
  sefi <- sef[,sef[[dvarname]]==donori]
  data.frame(glial_nuclei = length(which(sefi[[gvarname]]==T)),
             neuronal_nuclei = length(which(
               sefi[[kvarname]] %in% c("Inhib", "Excit"))),
             total_nuclei = ncol(sefi), donor = donori)
}))
```
```{r}
ggplot(dfp, aes(x = glial_nuclei, y = neuronal_nuclei)) + 
  geom_abline(intercept = 0, slope = 1, col = "red", lwd = 1.5) + ggtitle("Nuclei by donor") +
  geom_point(aes(size = total_nuclei), alpha = 0.5, color = "blue") + 
  geom_text(aes(label = donor), position = "dodge", color = "black")
```

### Scatterplot of neuronal types

Plotting Excit versus Inhib neuron abundances.

```{r}
sefi <- sef[,sef[[kvarname]] %in% c("Inhib", "Excit")]
dfp <- as.data.frame(table(sefi[[kvarname]], sefi[[dvarname]]))
dfp <- cbind(dfp[dfp[,1]=="Excit",], dfp[dfp[,1]=="Inhib",])[,c(2,3,6)]
colnames(dfp) <- c("donor", "Excit", "Inhib")
dfp$total_neurons <- dfp$Excit+dfp$Inhib
```
```{r}
ggplot(dfp, aes(x = Excit, y = Inhib)) + 
  geom_point(aes(size = total_neurons), alpha = 0.5, color = "blue") +
  geom_abline(intercept = 0, slope = 1, col = "red", lwd = 1.5) +
  geom_text(aes(label = donor), position = "dodge", color = "black")
```

### Scatterplot of Oligo versus non-Oligo cell types

```{r}
sefi <- sef[,!sef[[kvarname]] %in% c("Inhib", "Excit")]
dfp <- as.data.frame(table(sefi[[kvarname]], sefi[[dvarname]]))
dfp <- cbind(dfp[dfp[,1]=="Oligo",], dfp[dfp[,1]=="other",])[,c(2,3,6)]
colnames(dfp) <- c("donor", "Oligo", "Other")
dfp$total_glial <- dfp$Oligo+dfp$Other
```
```{r}
ggplot(dfp, aes(x = Oligo, y = Other)) + 
  geom_point(aes(size = total_glial), alpha = 0.5, color = "blue") +
  geom_abline(intercept = 0, slope = 1, col = "red", lwd = 1.5) +
  geom_text(aes(label = donor), position = "dodge", color = "black")
```

# Marker genes plots
## Upset plot of marker gene identities

# Expression at marker genes

## Composite violin plots

Make composite plots with `grid.arrange`.

Get expression distributions across variable scales, grouped by cell types.

```{r}
# expression data
ct <- assays(sef)$counts
sf <- 2^rnorm(ncol(sef))
sf <- sf/mean(sf)
nc <- t(t(ct)/sf)
lc <- log2(nc+1)

# get mean ratio expression -- by donor,type
knamev <- unique(sef[[kvarname]])
mr.kd <- do.call(cbind, lapply(knamev, function(ki){
  sefi <- sef[,sef[[kvarname]]==ki] # type subset
  dfpi <- do.call(cbind, lapply(dv, function(donori){
    sefii <- sefi[,sefi[[dvarname]]==donori] # donor, type subset
    numerv <- rowMeans(assays(sefii[,sefii[[kvarname]]==ki])$counts)
    ldenom <- lapply(knamev[!knamev==ki], function(kj){
      filtj <- sef[[kvarname]]==kj & sef[[dvarname]]==donori
      rowMeans(assays(sef[,filtj])$counts)+1e-6
    })
    mrkdv <- rep(numerv, length(knamev)-1)/unlist(ldenom)
    rowMeans(matrix(mrkdv, nrow = length(numerv)))
  }))
  colnames(dfpi) <- paste0(dv, ";", ki)
  rownames(dfpi) <- rownames(sef)
  dfpi
}))
dfp.mrkd <- reshape::melt(mr.kd)
colnames(dfp.mrkd) <- c("gene_name", "donor;type", "value")
dfp.mrkd$cell_type <- gsub(".*;", "", dfp.mrkd$`donor;type`)
dfp.mrkd <- dfp.mrkd[,c(1,4,3)]

# get mean ratio expression -- by type
mr.k <- do.call(cbind, lapply(knamev, function(ki){
  which.ki <- grepl(ki, colnames(mr.kd)); rowMeans(mr.kd[,which.ki])
}))
colnames(mr.k) <- knamev
rownames(mr.k) <- rownames(mr.kd)
dfp.mrk <- reshape::melt(mr.k)
colnames(dfp.mrk) <- c("gene_name", "cell_type", "value")
```

```{r}
# get violin plots of means
lmc <- get_lggvp(ct, yaxis.name = "mean_counts", xaxis.text = F, kvarname = kvarname) # counts
lnc <- get_lggvp(nc, yaxis.name ="mean_normcounts", xaxis.text = F, kvarname = kvarname) # norm counts
llc <- get_lggvp(lc, yaxis.name = "mean_logcounts", xaxis.text = F, kvarname = kvarname) # log counts
# mr by k,d
lmrkd <- get_lggvp(dfp.mrkd, make.dfp = F, yaxis.name = "mean_ratio_kd",
                   xaxis.text = T, kvarname = kvarname)
# mr by k
lmrk <- get_lggvp(dfp.mrk, make.dfp = F, yaxis.name = "mean_ratio_k",
                  xaxis.text = T, kvarname = kvarname)
```

### Individual violin plots

Counts

```{r}
lmc$ggvp
```

Normalized counts

```{r}
lnc$ggvp
```

Log counts

```{r}
llc$ggvp
```

Mean ratio by cell type (k) and donor (d), e.g. "mr_kd"

```{r}
lmrkd$ggvp
```

Mean ratio by cell type (k)

```{r}
lmrk$ggvp
```

### Composite -- all scales

```{r}
# make composite plot
grid.arrange(lmc$ggvp, lnc$ggvp, llc$ggvp, lmrkd$ggvp, lmrk$ggvp, ncol = 1)
```

### Composite -- counts without mean ratios

```{r}
grid.arrange(lmc$ggvp, lnc$ggvp, llc$ggvp, ncol = 1)
```

## Heatmaps of mean ratios

### Prep heatmap params

Make annotations

```{r}
dfm <- as.data.frame(lz$top.marker.data)
dfm <- dfm[order(match(dfm$gene, rownames(sef))),]
cond <- identical(dfm$gene, rownames(sef))
if(!cond){stop("couldn't match gene names.")}
# cell type annotations
rowData(sef)$cell_type <- dfm$celltype.target
rowData(sef)$top_mean_ratio <- dfm$ratio
ra <- rowAnnotation(cell_type = rowData(sef)$cell_type,
                    top_mean_ratio = rowData(sef)$top_mean_ratio)
ca.kd <- columnAnnotation(cell_type = gsub(".*;", "", colnames(mr.kd)))
ca.k <- columnAnnotation(cell_type = gsub(".*;", "", colnames(mr.k)))
```

Make axis labels

```{r}
ylab <- paste0("Genes (G = ",nrow(mr.kd),")")
xlab.kd <- paste0("Donors, types (k;d = ",ncol(mr.kd),")")
xlab.k <- paste0("Type (K = ",ncol(mr.k),")")
```

### Prep heatmap data

Unscaled

```{r}
set.seed(0)
hm.kd <- Heatmap(mr.kd, top_annotation = ca.kd, 
                 show_row_names = F, show_column_names = F,
                 row_title = ylab, column_title = xlab.kd,
                 name = "MR_kd_unscaled")
hm.k <- Heatmap(mr.k, top_annotation = ca.k, right_annotation = ra,
                show_row_names = F, show_column_names = F,
                row_title = ylab, column_title = xlab.k,
                name = "MR_k_unscaled")
```

Scaled 

```{r}
set.seed(0)
hm.kds <- Heatmap(scale(mr.kd), top_annotation = ca.kd, 
                  show_row_names = F, show_column_names = F,
                  row_title = ylab, column_title = xlab.kd,
                  name = "MR_kd_scaled")
hm.ks <- Heatmap(scale(mr.k), top_annotation = ca.k, right_annotation = ra,
                 show_row_names = F, show_column_names = F,
                 row_title = ylab, column_title = xlab.k,
                 name = "MR_k_scaled")
```

### Plot heatmaps

Heatmap of MRKD

```{r}
hm.kd
```

Heatmap of MRK

```{r}
hm.k
```

Composite heatmap

```{r}
hm.kd + hm.k
```

### Scaled

```{r}
hm.kds
```

```{r}
hm.ks
```

```{r}
hm.kds + hm.ks
```