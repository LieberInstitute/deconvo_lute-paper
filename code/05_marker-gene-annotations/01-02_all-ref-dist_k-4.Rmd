---
title: "01-02_all-ref-dist_k-4"
author: "Sean Maden"
date: '2022-10-24'
output: html_document
---

This vignette shows summary statistics for the restrictive example cell type labels
(e.g. K = 4) corresponding to the cell type labels from the TREG paper.

# Get cell data and labels

## Load data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SummarizedExperiment); library(here); library(ggplot2); library(gridExtra)
#------
# paths
#------
proj.dpath <- "deconvo_method-paper"
# filtered summarized experiment paths
sef.fname <- "sef-markers_ct-treg_stransform-expt_dlpfc-ro1.rda"
sef.fpath <- file.path(proj.dpath, "outputs", "03_test-stransform", sef.fname)
# lz signature matrix list
lz.fname <- "lz_s-rescale-k4_dlpfc-ro1.rda"
lz.fpath <- file.path(proj.dpath, "outputs", "03_test-stransform", lz.fname)
#-----
# load 
#-----
sef <- get(load(sef.fpath)) # load sef
lz <- get(load(lz.fpath)) # load z signature matrix list
#-----------
# set params
#-----------
ctvarname <- "celltype.treg"
gvarname <- "glial"
dvarname <- "BrNum"
glialv <- c("Astro", "MicroOligo", "Micro", "Oligo", "OPC")
#-----------------
# helper functions
#-----------------
get_ggvp <- function(dfp, yaxis.name, xaxis.text){
  colnames(dfp) <- c("gene_name", "cell_type", "value")
  dfp$glial <- ifelse(dfp$cell_type %in% c("Astro", "MicroOligo", "Micro", 
                          "Oligo", "OPC", "other"), TRUE, FALSE)
  dfp$cell_type <- factor(dfp$cell_type, 
                          levels = c("Excit", "Inhib","OPC", 
                                     "Oligo", "Astro","EndoMural", "Micro"))
  # make plot
  ggvp <- ggplot(dfp, aes(x = cell_type, y = value, fill = glial)) +
    geom_violin(draw_quantiles = 0.5) + ylab(yaxis.name)
  if(xaxis.text){
    ggvp <- ggvp + theme(axis.text.x = element_text(angle = 45, hjust = 1),
                         legend.position = "none")
  } else{
     ggvp <- ggvp + theme(axis.text.x = element_blank(),
                          axis.title.x = element_blank(),
                          legend.position = "none")
  }
  return(ggvp)
}

get_lggvp <- function(df, make.dfp = TRUE, yaxis.name = "mean_counts", 
                      xaxis.text = TRUE){
  if(make.dfp){
    # get means by cell types
    ctvarname <- "cellType_broad_hc"
    ctv <- unique(sef[[ctvarname]])
    mc <- do.call(cbind, lapply(ctv, function(ki){
      rowMeans(df[,sef[[ctvarname]]==ki])
    })); colnames(mc) <- ctv
    dfp <- reshape::melt(mc)
  } else{dfp <- df}
  # get plot data
  ggvp <- get_ggvp(dfp, yaxis.name, xaxis.text) 
 return(
   list(dfp = dfp, ggvp = ggvp))
}
```

## Append glial cell label

```{r}
sef[[gvarname]] <- ifelse(sef[[ctvarname]] %in% glialv, TRUE, FALSE)
```

# Cell abundance summaries

Summaries of the cell type labels contained in variables "`r ctvarname`" and 
"`r gvarname`."

## Table of type abundance

```{r}
knitr::kable(table(x = sef[[ctvarname]]), align = "c")
```

## Table of type, glial status

```{r}
knitr::kable(table(sef[[gvarname]]), align = "c")
```

```{r}
knitr::kable(table(sef[[ctvarname]], sef[[gvarname]]), align = "c")
```

## Type abundances barplot

```{r}
dfp <- as.data.frame(table(sef[[ctvarname]], sef[[gvarname]]))
colnames(dfp) <- c("cell_type", "glial", "num_nuclei")
dfp[,1] <- as.character(dfp[,1])
dfp[,2] <- as.character(dfp[,2])
# order on value
dfp[,1] <- factor(dfp[,1], levels = dfp[,1][order(dfp[,4])])
```
```{r}
ggplot(dfp, aes(x = cell_type, y = num_nuclei, fill = glial)) + geom_bar(stat = "identity")
```

## Abundances by donor

Cell nuclei abundances/counts, grouped by donor variable "`r dvarname`", or the donor brain ID.

### Type abundances violin plots

```{r}
cd <- colData(sef)
dv <- unique(sef[[dvarname]])
dfp <- do.call(rbind, lapply(dv, function(di){
  cdi <- cd[cd[,dvarname]==di,]
  dfp <- as.data.frame(table(cdi[,ctvarname]))
  dfp$donor <- di
  dfp
}))
colnames(dfp) <- c("cell_type", "num_nuclei", "donor")
```
```{r}
ggplot(dfp, aes(x = cell_type, y = num_nuclei)) + 
  geom_violin(draw_quantiles = 0.5)
```

### Type abundances stacked barplots

```{r}
# order donor var
sumv <- as.data.frame(table(sef[[dvarname]]))
dfp$donor <- factor(dfp$donor, levels = sumv[,1][rev(order(sumv[,2]))])
```

Counts

```{r}
ggplot(dfp, aes(x = donor, y = num_nuclei, fill = cell_type)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Percentages

```{r}
ggplot(dfp, aes(x = donor, y = num_nuclei, fill = cell_type)) + 
  geom_bar(position = "fill", stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Scatterplot of glial versus neurons, by donor

```{r}
dfp <- do.call(rbind, lapply(dv, function(donori){
  sefi <- sef[,sef[[dvarname]]==donori]
  data.frame(glial_nuclei = length(which(sefi[[gvarname]]==T)),
             neuronal_nuclei = length(which(
               sefi[[ctvarname]] %in% c("Inhib", "Excit"))),
             total_nuclei = ncol(sefi), donor = donori)
}))
```
```{r}
ggplot(dfp, aes(x = glial_nuclei, y = neuronal_nuclei, size = total_nuclei)) + 
  geom_abline(intercept = 0, slope = 1, col = "red", lwd = 1.5) +
  geom_point() + ggtitle("Nuclei by donor")
```

### Scatterplot of neuronal types

Plotting Excit versus Inhib neuron abundances.

```{r}
sefi <- sef[,sef[[ctvarname]] %in% c("Inhib", "Excit")]
dfp <- as.data.frame(table(sefi[[ctvarname]], sefi[[dvarname]]))
dfp <- cbind(dfp[dfp[,1]=="Excit",], dfp[dfp[,1]=="Inhib",])[,c(2,3,6)]
colnames(dfp) <- c("donor", "Excit", "Inhib")
dfp$total_neurons <- dfp$Excit+dfp$Inhib
```
```{r}
ggplot(dfp, aes(x = Excit, y = Inhib)) + 
  geom_point(aes(size = total_neurons), alpha = 0.5, color = "blue") +
  geom_abline(intercept = 0, slope = 1, col = "red", lwd = 1.5) +
  geom_text(aes(label = donor), position = "dodge", color = "black")
```

### Scatterplot of Oligo versus non-Oligo cell types

```{r}
sefi <- sef[,!sef[[ctvarname]] %in% c("Inhib", "Excit")]
dfp <- as.data.frame(table(sefi[[ctvarname]], sefi[[dvarname]]))
dfp <- cbind(dfp[dfp[,1]=="Oligo",], dfp[dfp[,1]=="other",])[,c(2,3,6)]
colnames(dfp) <- c("donor", "Oligo", "Other")
dfp$total_glial <- dfp$Oligo+dfp$Other
```
```{r}
ggplot(dfp, aes(x = Oligo, y = Other)) + 
  geom_point(aes(size = total_glial), alpha = 0.5, color = "blue") +
  geom_abline(intercept = 0, slope = 1, col = "red", lwd = 1.5) +
  geom_text(aes(label = donor), position = "dodge", color = "black")
```

# Marker genes plots
## Upset plot of marker gene identities

# Expression at marker genes
## Get expression plots

```{r}
# get violin plots of means
lmc <- get_lggvp(ct, yaxis.name = "mean_counts", xaxis.text = F) # counts
lnc <- get_lggvp(nc, yaxis.name ="mean_normcounts", xaxis.text = F) # norm counts
llc <- get_lggvp(lc, yaxis.name = "mean_logcounts", xaxis.text = F) # log counts
lmr <- get_lggvp(reshape::melt(mrk), make.dfp = F, 
                 yaxis.name = "mean_ratio", xaxis.text = T)
```

## Make expression composite plot

Make composite plots with `grid.arrange`.

```{r}
# make composite plot
grid.arrange(lmc$ggvp, lnc$ggvp, llc$ggvp, lmr$ggvp, ncol = 1)
```

```{r}
grid.arrange(llc$ggvp, lmr$ggvp, ncol = 1)
```