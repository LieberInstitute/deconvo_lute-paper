---
title: "pseudobulk_experiment_stransform"
author: "Sean Maden"
date: '2022-10-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
proj.dpath <- "deconvo_method-paper"
```

```{r}
source.dpath <- file.path("deconvo_method-paper", 
                          "source")
source.fnv <- c("pb_methods.R")
for(fni in source.fnv){
  source(
    file.path(here(), 
              source.dpath, fni))}
```

# Overview

This vignette investigates the impact of performing transformations at the cell-level.
Specifically, we apply either static or randomized transformations on individual
cell types based on quantification of cells from independent analyses. We hope that
by applying cell quantification factors to cell type signature data prior to 
deconvolution would improve the robustness of deconvolution across cells having
large differences in cell abundances and available total expression (e.g. total reads).

# Get s-transformed signature matrices

We wish to evaluate the impact of performing transformations on the signature matrix data.
To do this, we need the transformation values and an outline of the experiment design.

## Load the z-table series

Loads list containing the main preprocessed signature matrix table.

```{r}
save.dpath <- file.path(proj.dpath, "outputs/02_test-source")
lz.fname <- "lz_mr_dlpfc-ro1.rda"
lz <- get(load(file.path(here(), save.dpath, lz.fname)))
```

## Define the transformation distributions

The s transformations apply some factor to all cells of a given type, e.g. all
rows in a column for some $Z^{G\times K}$ signature matrix.

For static s, we only need the means (or medians), and this same value is applied
to all cells of a given cell type.

```{r}
meanv <- c(6,2,2,8)
```

For randomized S, we additionally define some standard deviations. Now, random 
values from the same normal distribution are applied to all cells of a given
cell type.

```{r}
sdv <- c(2, 1, 1, 3)
```

## Run transformations

We transform the signature matrix using `s_rescale()`.

First, use the static transformation method. We pass the vector of means to the
argument `factorv`.
```{r}
# get the s-rescaled z tables
lz[["zs.stat"]] <- s_rescale(lz[["z.final"]], factorv = meanv)
```

Second, use the randomized transformation method. Note, we use arguments `meanv`
and `sdv` to define a distribution for each cell type.
```{r}
# z randomized
lz[["zs.rand"]] <- s_rescale(lz[["z.final"]], meanv = meanv, sdv = sdv)
```

# Performing pseudobulking experiments

We can use pseudobulking to evaluate the impact of the S-transformation on 
deconvolution outcomes. Here, we specifically test the relative cell proportions
as well as the relative scaling, or total counts, on deconvolution with `nnls`.

## Experiment setup

We wish to evaluate deconvolution outcomes in a variety of conditions. For instance,
can we recover neuronal cell proportions as well as oligodendrocyte cell proportions
when equal numbers of cells are present? For each of these conditions, we also
test outcomes for the 3 Z signature matrices defined above to see if either of
the S-transformation strategies had any effect. 

## Get data objects

We need to load the `SummarizedExperiment` from which to sample cell-level 
expression counts.

```{r}
sef <- get(load(file.path(here())))
```

We also need to subset the `lz` list to include just the Z signature matrices of
interest.

```{r}
# subset lz
lexpt <- lz[c("z.final", "zs.stat", "zs.rand")]
```

## Run experiments

```{r}
# run experiment
pb.expt <- get_pb_experiment(lz = lexpt, scef = sef, datv = c(1,1,1,1), nj = NA,
                             scale.range = 500:2000, ctvarname = "celltypes",
                             plot.results = TRUE, method.str = "nnls", 
                             seed.num = 2)
```

