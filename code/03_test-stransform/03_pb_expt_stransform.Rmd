---
title: "pseudobulk_experiment_stransform"
author: "Sean Maden"
date: '2022-10-10'
output: html_document
bibliography: citations.bib
---

```{r setup, include=FALSE}
library(here)
knitr::opts_chunk$set(echo = TRUE)
message("here: ", here())
proj.dpath <- "deconvo_method-paper"
# source methods
source.dpath <- file.path("deconvo_method-paper",
                          "source")
source.fnv <- c("pb_methods", 
                "z_transformations")
for(fni in source.fnv){
  source(
    file.path(here(), 
              source.dpath, 
              paste0(fni, ".R")))}
```

# Overview

This vignette investigates the impact of performing transformations at the cell 
type level. Specifically, we apply either static or randomized transformations 
on individual cell types based on quantification of cells from independent 
analyses. We hope that by applying cell quantification factors to cell type 
signature data prior to deconvolution would improve the robustness of 
deconvolution across cells having large differences in cell abundances and 
available total expression (e.g. total reads).

# Get s-transformed signature matrices

We wish to evaluate the impact of performing transformations on the signature matrix data.

To do this, we need the transformation values and an outline of the experiment design.

## Load the z-table series

Load the preprocessed signature matrix table.

```{r}
lz.fname <- "lz_s-rescale-k4_dlpfc-ro1.rda"
lz.fpath <- file.path(proj.dpath, 
                      "outputs/03_test-stransform", 
                      lz.fname)
lz <- get(load(file.path(here(), lz.fpath)))
```

## Define the transformation distributions

The s transformations apply some factor to all cells of a given type, e.g. all
rows in a column for some $Z^{G\times K}$ signature matrix.

When we define some vector of factors, e.g. `meanv`, we wish to applye to cell type
1 the value corresponding to `meanv[1]`, to cell type 2 the value corresponding to
`meanv[2]`, etc.

Below, we use the following data as obtained from the paper @huuki-myers_data-driven_2022. These
indicate the mean and SD in sizes of four types of cells in brain tissues.

```{r, echo = F}
dft <- data.frame(cell_type = c("Excit", "Inhib", "Oligo", "other"),
                        mean = c(6, 8, 2, 2), 
                        sd = c(2, 3, 1, 1))
knitr::kable(dft,
             align = "c", 
             label = "Cell type sizes")
```

For static s, we only need the means (or medians), and this same value is applied
to all cells of a given cell type.

```{r}
meanv <- c(6, 2, 2, 8)
```

For randomized S, we additionally define some standard deviations. Now, random 
values from the same normal distribution are applied to all cells of a given
cell type.

```{r}
sdv <- c(2, 1, 1, 3)
```

## Run transformations

We transform the signature matrix using `s_rescale()`.

First, use the static transformation method. We pass the vector of means to the
argument `factorv`.
```{r}
lz[["zs.stat"]] <- s_rescale(lz[["z.final"]], factorv = meanv)
```

Second, use the randomized transformation method. Note, we use arguments `meanv`
and `sdv` to define a distribution for each cell type.
```{r}
lz[["zs.rand"]] <- s_rescale(lz[["z.final"]], meanv = meanv, sdv = sdv)
```

# Performing pseudobulking experiments

We can use pseudobulking to evaluate the impact of the S-transformation on 
deconvolution outcomes. Here, we specifically test the relative cell proportions
as well as the relative scaling, or total counts, on deconvolution with `nnls`.

## Experiment setup

We wish to evaluate deconvolution outcomes in a variety of conditions. For instance,
can we recover neuronal cell proportions as well as oligodendrocyte cell proportions
when equal numbers of cells are present? For each of these conditions, we also
test outcomes for the 3 Z signature matrices defined above to see if either of
the S-transformation strategies had any effect. 

### Get data objects

We need to load the `SummarizedExperiment` from which to sample cell-level 
expression counts.

```{r}
sef.fname <- "sef-markers_ct-treg_stransform-expt_dlpfc-ro1.rda"
sef.fpath <- file.path(proj.dpath, 
                      "outputs/03_test-stransform", 
                      sef.fname)
sef <- get(load(file.path(here(), sef.fpath)))
```

We also need to subset the `lz` list to include just the Z signature matrices of
interest.

```{r}
# subset lz
lexpt <- lz[c("z.final", "zs.stat", "zs.rand")]
```

### Experiment design

We wish to evaluate a series of scales and cell proportions. 

```{r}
scalev <- seq(500, 5000, 500)
cell.propv <- seq(0, 1000, 225)
datv <- c(0, 1, 2, 3,
          1, 2, 3, 0,
          2, 3, 0, 1,
          3, 0, 1, 2,
          0, 0, 1, 0)
```



## Run experiments

```{r}

# run experiment
pb.expt <- get_pb_experiment(lz = lexpt, 
                             scef = sef, 
                             datv = datv,
                             scale.range = 500:2000, 
                             ctvarname = "celltype.treg",
                             plot.results = TRUE, 
                             method.str = "nnls",
                             plot.save.dpath = file.path(proj.dpath,
                                                         "outputs",
                                                         "03_test-stransform"),
                             save.plots = FALSE,
                             seed.num = 2)

pb.expt$lgg_plots$lgg.pi$ggpt.all.celltype.facet
```
# Results

```{r}
attach(pb.expt$lpb$pb_report)
```

```{r}
pb.expt$lgg_plots$lgg.pi$ggpt.all.col
pb.expt$lgg_plots$lgg.pi$ggpt.all.celltype.facet
```


```{r}
df.tall <- pb.expt$lpb$pb_report
alpha.value <- 0.4
ggmain <- pb.expt$lgg_plots$lgg.pi$ggpt.all.col
ggpt.all.col <- ggmain + geom_point(aes(color = cell_type),alpha = alpha.value)
ggpt.all.col
```

```{r}
ggpt.all.celltype.facet <- ggpt.all.col + facet_wrap(~cell_type, nrow = 1)
ggpt.all.celltype.facet
```
