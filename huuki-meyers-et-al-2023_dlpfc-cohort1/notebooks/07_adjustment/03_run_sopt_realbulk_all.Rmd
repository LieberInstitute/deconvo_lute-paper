---
title: "Real bulk results"
author: "Sean Maden"
date: "2023-09-21"
output:
  pdf_document: default
  html_document: default
---

Deconvolution on real bulk samples.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libv <- c("dplyr", "ggplot2", "GGally", "gridExtra")
sapply(libv, library, character.only = TRUE)
```

```{r}
setwd("..")
setwd("..")
load("./env/07_adjustment/03_run_adjustment_realbulk_all_script.RData")
list.df.true <- metadata(sce)[["list.df.true.k2"]]
plotsList <- function(dfp){
  # plotsList
  # 
  # scatterplot and jitterbox plot of results data, with outlier label.
  #
  # dfp.tall results data.frame
  #
  #
dfp$scale <- ifelse(dfp$scale, "withscale", "noscale")

dfLabel <- dfp[dfp$true < 0.75 & dfp$value < 0.25,]

new.plot.tall <- ggplot(dfp, aes(x = true, y = value)) + 
  geom_point(size = 4, alpha = 0.5) + geom_abline(slope = 1, intercept = 0) + facet_wrap(~scale) + 
  xlab("Known") + ylab("Predicted") + xlim(0.1,0.9) + ylim(0.1,0.9) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(data = dfLabel, aes(x = true, y = value), 
            label = sample.id, nudge_x = 0.1, nudge_y = 0.1)
new.plot.tall

new.plot.tall.jitterbox <- ggplot(dfp, aes(x = scale, y = error)) + 
  geom_jitter(alpha = 0.5, width = 0.5, height = 0) + theme_bw() +
  geom_boxplot(alpha = 0, color = "cyan") + 
  xlab("Scale") + ylab("Error (neuron)") + ylim(0, 0.5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank())
new.plot.tall.jitterbox
return(list(
  new.plot.tall, new.plot.tall.jitterbox
))
}
```

```{r}
list.df.true <- metadata(sce)[["list.df.true.k2"]]

for(sample.id in unique(dfp.tall$sample.id)){
  message(sample.id)
  message(identical(dfp.tall[dfp.tall$sample.id==sample.id,]$true[1],
            as.numeric(list.df.true[[sample.id]]["neuron"])))
}
```
  
```{r}
for(sample.id in unique(dfp.tall$sample.id)){
  filter.dfp.tall <- dfp.tall$sample.id==sample.id
  filter.dfp.wide <- rownames(dfp.wide)==sample.id
  true.neuron.value <- as.numeric(df.true.list[[sample.id]]["neuron"])
  dfp.tall[filter.dfp.tall,]$true <- true.neuron.value
  dfp.wide[filter.dfp.wide,]$neuron.true <- true.neuron.value
}
dfp.tall$error <- abs(dfp.tall$true-dfp.tall$value)
```

# Plots

```{r}
dfpWide <- dfp.wide

#ggpairs(dfp.wide, 
#        columns = rev(colnames(dfp.wide)),
#        xlim = c(0, 1), ylim = c(0, 1))

colnames(dfpWide) <- c("neuron_NNLS_NoScale", "neuron_NNLS_Scale", 
                       "neuron_MuSiC_Noscale", "neuron_MuSiC_Scale", 
                       "neuron_Bisque_Scale", "neuron_Bisque_Noscale", 
                       "neuron_Known")
ggpairs(dfpWide, 
        columns = rev(colnames(dfpWide)),
        xlim = c(0, 1), ylim = c(0, 1))

```

```{r}
new.plot.tall <- ggplot(dfp.tall, aes(x = true, y = value, color = sample.id)) + 
  geom_point() + geom_abline(slope = 1, intercept = 0) + 
  facet_wrap(~scale*algorithm) + xlab("True") + 
  ylab("Predicted") + xlim(0.1,0.9) + ylim(0.1,0.9) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
new.plot.tall
```

Same as previous plot, but showing neuron and glial proportions.

```{r}
# parse dfp.tall

# append glial data
# pred value
dfp.tall2 <- dfp.tall
dfp.tall2$cell.type <- "glial"
dfp.tall2$value <- 1-dfp.tall2$value
dfp.tall2$true <- 1-dfp.tall2$true
# error
dfp.tall2$error <- abs(dfp.tall2$true-dfp.tall2$value)

# recombine
# bind
dfp.tall <- rbind(dfp.tall, dfp.tall2) |> as.data.frame()
# rename type variables
dfp.tall$type <- ifelse(dfp.tall$scale, "withscale", "noscale")
```

```{r}
new.plot.tall.jitterbox <- ggplot(dfp.tall, 
                                  aes(x = scale, y = error)) + 
  geom_jitter(alpha = 0.5, width = 0.5, height = 0) + geom_boxplot(alpha = 0, color = "cyan") +
  facet_wrap(~algorithm) + xlab("Scale") + 
  ylab("Error (neuron)") + ylim(0, 0.5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
new.plot.tall.jitterbox
```

## Multipanel scatterplots and jitterplots, neuron and glial

```{r}
# append glial
dfp.tall2 <- dfp.tall
dfp.tall2$cell.type <- "glial"
dfp.tall2$value <- 1-dfp.tall2$value
dfp.tall2$true <- 1-dfp.tall2$true
dfp.tall <- rbind(dfp.tall, dfp.tall2) |> as.data.frame()

plotsList <- function(dfp, outlier = TRUE){
    # plotsList
    # 
    # scatterplot and jitterbox plot of results data, with outlier label.
    #
    # dfp.tall results data.frame
    #
    #
    #
    #
  
    
    dfp$scale <- ifelse(dfp$scale, "withscale", "noscale")
    
    newPlot <- ggplot(dfp, aes(x = true, y = value)) + 
      geom_point(size = 4, alpha = 0.5) + 
      geom_abline(slope = 1, intercept = 0) + 
      facet_grid(cell.type~scale) + xlab("Known") + 
      ylab("Predicted") + theme_bw() + xlim(0, 1) + ylim(0, 1) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
        
    if(outlier){
      dfLabelGlial <- dfp[dfp$value > 0.75 & dfp$cell.type == "glial",]
      dfLabelNeuron <- dfp[dfp$value < 0.25 & 
                             dfp$true < 0.75 & dfp$cell.type == "neuron",]
    newPlot <- newPlot +
      geom_text(data = dfLabelNeuron, aes(x = true, y = value), 
                  label = sample.id, nudge_x = 0.1, nudge_y = 0.1) +
      geom_text(data = dfLabelGlial, aes(x = true, y = value), 
                  label = sample.id, nudge_x = 0.1, nudge_y = 0.1)
    }
    
    
    
      
    jitterbox <- ggplot(dfp[dfp$cell.type == "neuron",], aes(x = scale, y = error)) + 
        geom_jitter(alpha = 0.5, width = 0.5, height = 0) + theme_bw() +
        geom_boxplot(alpha = 0, color = "cyan") + 
        xlab("Scale") + ylab("Error") + ylim(0, 0.5) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1),
              axis.title.x = element_blank())
    
    return(list(
        newPlot, jitterbox
    ))
}

plotsListNNLS <- plotsList(dfp.tall[dfp.tall$algorithm=="nnls",])
plotsListMUSIC <- plotsList(dfp.tall[dfp.tall$algorithm=="music",])
plotsListBISQUE <- plotsList(dfp.tall[dfp.tall$algorithm=="bisque",], outlier = FALSE)

```

# Save

Save NNLS multipanel plot.

```{r}
setwd("..")
setwd("..")

jpeg("./figures/07_adjustment/fig3_bulk-results_nnls.jpg", 
     width = 6, height = 4, units = "in", res = 400)

grid.arrange(plotsListNNLS[[1]], plotsListNNLS[[2]],  
             layout_matrix = matrix(c(1,1,2), byrow=TRUE, nrow = 1))

dev.off()

```

Save Bisque and MuSiC multipanel plot.

```{r}
setwd("..")
setwd("..")
jpeg("./figures/07_adjustment/fig3_bulk-results_music-bisque.jpg", 
     width = 5.5, height = 8, units = "in", res = 400)
grid.arrange(plotsListMUSIC[[1]] + ggtitle("MuSiC"), plotsListMUSIC[[2]] + ggtitle(""), 
             plotsListBISQUE[[1]] + ggtitle("Bisque"), plotsListBISQUE[[2]] + ggtitle(""), 
             layout_matrix = matrix(c(1,1,2,3,3,4), byrow = TRUE, nrow = 2))
dev.off()

```

Save ggpairs plot.

```{r}
jpeg("./figures/07_adjustment/figs12_ggpairs_realbulk.jpg", 
     width = 10, height = 10, units = "in", res = 400)

ggpairs(dfp.wide, 
        columns = rev(colnames(dfp.wide)),
        xlim = c(0, 1), ylim = c(0, 1))

dev.off()

#

jpeg("./figures/07_adjustment/FIG_S7.jpg", 
     width = 15, height = 15, units = "in", res = 400)

ggpairs(dfpWide, 
        columns = rev(colnames(dfpWide)),
        xlim = c(0, 1), ylim = c(0, 1))

dev.off()

pdf("./figures/07_adjustment/FIG_S7.pdf", 
     width = 15, height = 15, units = "in", res = 400)

ggpairs(dfpWide, 
        columns = rev(colnames(dfpWide)),
        xlim = c(0, 1), ylim = c(0, 1))

dev.off()

```

# Composite K2 plots

Prepare the plot data.

```{r}
# parse dfp.tall
dfp.tall <- dfp.tall[dfp.tall$cell.type=="neuron",]

# append glial data
# pred value
dfp.tall2 <- dfp.tall
dfp.tall2$cell.type <- "glial"
dfp.tall2$value <- 1-dfp.tall2$value
dfp.tall2$true <- 1-dfp.tall2$true

# recombine
# bind
dfp.tall <- rbind(dfp.tall, dfp.tall2) |> as.data.frame()
dfp.tall$error.negative <- dfp.tall$true-dfp.tall$value
dfp.tall$error <- abs(dfp.tall$error.negative)
# rename type variables
dfp.tall$type <- ifelse(dfp.tall$scale, "withscale", "noscale")
```

Plots showing neuron and glial proportions from K2 results.

```{r}
cellTypeColor1 <- "blue"
cellTypeColor2 <- "red"
idLineColor <- "orange"

# get plot objects
new.plot.nnls.k2.noline <- ggplot(dfp.tall[dfp.tall$algorithm=="nnls",], 
                   aes(x = true, y = value, colour = cell.type)) + 
  geom_point(size = 4, alpha = 0.3) + 
  geom_abline(slope = 1, intercept = 0) + 
  geom_hline(yintercept = 0.5) + 
  geom_vline(xintercept = 0.5) + theme_bw() +
  xlab("Known") + ylab("Predicted") +
  xlim(0, 1) + ylim(0, 1) + facet_wrap(~type) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = c(cellTypeColor2, cellTypeColor1))
new.plot.nnls.k2.withline <-
  new.plot.nnls.k2.noline + geom_line(aes(group=sample.id), color = idLineColor)

# preview plots
new.plot.nnls.k2.noline
new.plot.nnls.k2.withline
```

```{r}
new.plot.facet.color <- new.plot.nnls.k2.noline + facet_grid(cell.type~type)
new.plot.facet.color
```

Errors boxplots.

```{r}
dfp.tall$type <- factor(dfp.tall$type)
dfp.tall$celltype <- as.character(dfp.tall$cell.type)
dfp.tall$bp.id <- paste0(dfp.tall$sample.id,"_",dfp.tall$type) |> factor()

set.seed(0)
posdodged <- position_jitterdodge(dodge.width=0.9)
new.plot.k2.2celltype.noline <- ggplot(dfp.tall[dfp.tall$algorithm=="nnls",], 
                                aes(x = type, y = error.negative, 
                                    colour = celltype)) + 
  geom_hline(yintercept = 0, color = "black") +
  geom_point(position=posdodged, alpha = 0.3, size = 4) + theme_bw() +
  geom_boxplot(alpha = 0, position = position_dodge(1), size = 0.8, width = 0.9) + 
  xlab("Scale") + ylab("Error (Known - Predicted)") + ylim(-0.5, 0.5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = c(cellTypeColor2, cellTypeColor1))
  
new.plot.k2.2celltype.noline
```

```{r}
dfp.tall$type <- factor(dfp.tall$type)
dfp.tall$celltype <- as.character(dfp.tall$cell.type)
dfp.tall$bp.id <- paste0(dfp.tall$sample.id,"_",dfp.tall$type) |> factor()

set.seed(0)
posdodged <- position_jitterdodge(dodge.width=0.9)
new.boxplot.abserr.k2.2celltype.noline <- ggplot(dfp.tall[dfp.tall$algorithm=="nnls",], 
                                aes(x = type, y = error.negative, 
                                    colour = celltype)) + 
  geom_hline(yintercept = 0, color = "black") +
  geom_point(position=posdodged, alpha = 0.3, size = 2) + theme_bw() +
  geom_boxplot(alpha = 0, position = position_dodge(1), size = 0.8, width = 0.9) + 
  xlab("Scale") + ylab("Error (Known - Predicted)") + ylim(-0.5, 0.5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = c(cellTypeColor2, cellTypeColor1))
  
new.boxplot.abserr.k2.2celltype.noline
```

Save k2 plots. 

```{r}
setwd("..")
setwd("..")
lm <- matrix(c(rep(1,10),rep(2,7)),nrow=1)
jpeg("./figures/07_adjustment/fig3_scatter-box_bulk-nnls-noline.jpg", 
     width = 8, height = 3, units = "in", res = 400)
grid.arrange(new.plot.nnls.k2.noline + theme(legend.position = "none"),
             new.boxplot.abserr.k2.2celltype.noline,
             layout_matrix = lm, ncol = 2)
dev.off()

jpeg("./figures/07_adjustment/fig3_scatter-box_bulk-nnls-withline.jpg", 
     width = 8, height = 3, units = "in", res = 400)
grid.arrange(new.plot.nnls.k2.withline + theme(legend.position = "none"),
             new.boxplot.abserr.k2.2celltype.noline, 
             layout_matrix = lm, ncol = 2)
dev.off()
```

```{r}
setwd("..")
setwd("..")
lm <- matrix(c(rep(1,10),rep(2,7)),nrow=1)
jpeg("./figures/07_adjustment/fig3_scatter-box_bulk-nnls_facet-color.jpg", 
     width = 9, height = 4.5, units = "in", res = 400)
grid.arrange(
  new.plot.facet.color,
  new.boxplot.abserr.k2.2celltype.noline,
  layout_matrix = lm, ncol = 2
)
dev.off()
```

# Session info

```{r}
sessionInfo()
```
